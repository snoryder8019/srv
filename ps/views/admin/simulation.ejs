<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Stringborn Universe</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <style>
    body {
      background: #0a0a0a;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 20px;
    }

    .simulation-control {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #4ade80;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .control-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .control-panel {
      background: #111;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 20px;
    }

    .control-panel h2 {
      color: #4ade80;
      margin-top: 0;
      font-size: 1.2em;
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .status-item {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 4px;
      border-left: 3px solid #4ade80;
    }

    .status-label {
      color: #888;
      font-size: 0.85em;
      margin-bottom: 5px;
    }

    .status-value {
      color: #fff;
      font-size: 1.5em;
      font-weight: bold;
    }

    .status-value.running {
      color: #4ade80;
    }

    .status-value.stopped {
      color: #ef4444;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      flex: 1;
      padding: 12px 20px;
      background: #1a1a1a;
      color: #4ade80;
      border: 2px solid #4ade80;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 1em;
      transition: all 0.2s;
    }

    button:hover {
      background: #4ade80;
      color: #000;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.danger {
      border-color: #ef4444;
      color: #ef4444;
    }

    button.danger:hover {
      background: #ef4444;
      color: #fff;
    }

    .speed-control {
      margin-bottom: 20px;
    }

    .speed-control label {
      display: block;
      color: #888;
      margin-bottom: 10px;
    }

    .speed-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    input[type="range"] {
      flex: 1;
      height: 6px;
      background: #333;
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #4ade80;
      cursor: pointer;
      border-radius: 50%;
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #4ade80;
      cursor: pointer;
      border-radius: 50%;
      border: none;
    }

    .speed-display {
      min-width: 200px;
      text-align: right;
      color: #4ade80;
      font-weight: bold;
    }

    .universe-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .stat-card {
      background: #1a1a1a;
      padding: 12px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-card .label {
      color: #888;
      font-size: 0.8em;
      margin-bottom: 5px;
    }

    .stat-card .value {
      color: #4ade80;
      font-size: 1.8em;
      font-weight: bold;
    }

    .message {
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border-left: 4px solid;
      display: none;
    }

    .message.success {
      background: rgba(74, 222, 128, 0.1);
      border-color: #4ade80;
      color: #4ade80;
    }

    .message.error {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #ef4444;
    }

    .back-link {
      color: #4ade80;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .script-section {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .script-section h3 {
      color: #4ade80;
      margin-top: 0;
      font-size: 1em;
      margin-bottom: 10px;
    }

    .script-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .script-buttons button {
      flex: 0 1 auto;
      min-width: 150px;
    }
  </style>
</head>
<body>
  <div class="simulation-control">
    <a href="/admin" class="back-link">‚Üê Back to Admin Dashboard</a>

    <h1>üéÆ Simulation Control Center</h1>

    <div id="message" class="message"></div>

    <div class="control-grid">
      <!-- Status Panel -->
      <div class="control-panel">
        <h2>üìä Simulation Status</h2>
        <div class="status-grid">
          <div class="status-item">
            <div class="status-label">Status</div>
            <div id="sim-status" class="status-value stopped">STOPPED</div>
          </div>
          <div class="status-item">
            <div class="status-label">Tick Rate</div>
            <div id="sim-tickrate" class="status-value">100ms</div>
          </div>
          <div class="status-item">
            <div class="status-label">Ticks/Second</div>
            <div id="sim-tps" class="status-value">10</div>
          </div>
          <div class="status-item">
            <div class="status-label">Gravity Radius</div>
            <div id="sim-gravity" class="status-value">200</div>
          </div>
        </div>

        <div class="button-group">
          <button id="btn-start" onclick="startSimulation()">‚ñ∂Ô∏è Start</button>
          <button id="btn-stop" onclick="stopSimulation()" disabled>‚è∏Ô∏è Stop</button>
        </div>

        <div class="speed-control">
          <label>Simulation Speed</label>
          <div class="speed-input-group">
            <input type="range" id="speed-slider" min="10" max="2000" value="100" step="10">
            <span class="speed-display" id="speed-display">100ms (10 tps)</span>
          </div>
          <button style="margin-top: 10px;" onclick="updateSpeed()">Apply Speed</button>
        </div>
      </div>

      <!-- Universe Stats Panel -->
      <div class="control-panel">
        <h2>üåå Universe Statistics</h2>
        <div class="universe-stats">
          <div class="stat-card">
            <div class="label">Anomalies</div>
            <div id="stat-anomalies" class="value">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Galaxies</div>
            <div id="stat-galaxies" class="value">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Stars</div>
            <div id="stat-stars" class="value">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Planets</div>
            <div id="stat-planets" class="value">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Total Assets</div>
            <div id="stat-assets" class="value">0</div>
          </div>
          <div class="stat-card">
            <div class="label">Characters</div>
            <div id="stat-characters" class="value">0</div>
          </div>
        </div>
      </div>

      <!-- Universe Management Panel -->
      <div class="control-panel full-width">
        <h2>üõ†Ô∏è Universe Management</h2>

        <div class="script-section">
          <h3>Seed Test Universe</h3>
          <p style="color: #888; margin: 10px 0;">Creates a complete test universe: 1 Anomaly, 1 Galaxy, 1 Star, 5 Planets</p>
          <div class="script-buttons">
            <button onclick="seedTestUniverse()">üå± Seed Test Universe</button>
            <button class="danger" onclick="resetUniverse()">üóëÔ∏è Reset Universe</button>
          </div>
        </div>

        <div class="script-section">
          <h3>Quick Actions</h3>
          <div class="script-buttons">
            <button onclick="refreshStatus()">üîÑ Refresh Status</button>
            <button onclick="viewGalacticMap()">üó∫Ô∏è View Galactic Map</button>
            <button onclick="viewScriptPanel()">üìú Script Control Panel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Update speed display as slider moves
    document.getElementById('speed-slider').addEventListener('input', function(e) {
      const tickRate = parseInt(e.target.value);
      const tps = (1000 / tickRate).toFixed(1);
      document.getElementById('speed-display').textContent = `${tickRate}ms (${tps} tps)`;
    });

    // Show message helper
    function showMessage(message, type = 'success') {
      const msgEl = document.getElementById('message');
      msgEl.textContent = message;
      msgEl.className = `message ${type}`;
      msgEl.style.display = 'block';
      setTimeout(() => {
        msgEl.style.display = 'none';
      }, 5000);
    }

    // Fetch and update simulation status
    async function refreshStatus() {
      try {
        const response = await fetch('/admin/api/simulation/status');
        const data = await response.json();

        if (data.success) {
          const sim = data.simulation;
          const universe = data.universe;

          // Update simulation status
          const statusEl = document.getElementById('sim-status');
          if (sim.running) {
            statusEl.textContent = 'RUNNING';
            statusEl.className = 'status-value running';
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-stop').disabled = false;
          } else {
            statusEl.textContent = 'STOPPED';
            statusEl.className = 'status-value stopped';
            document.getElementById('btn-start').disabled = false;
            document.getElementById('btn-stop').disabled = true;
          }

          document.getElementById('sim-tickrate').textContent = sim.tickRate + 'ms';
          document.getElementById('sim-tps').textContent = sim.ticksPerSecond.toFixed(1);
          document.getElementById('sim-gravity').textContent = sim.gravityRadius;

          // Update universe stats
          document.getElementById('stat-anomalies').textContent = universe.anomalies;
          document.getElementById('stat-galaxies').textContent = universe.galaxies;
          document.getElementById('stat-stars').textContent = universe.stars;
          document.getElementById('stat-planets').textContent = universe.planets;
          document.getElementById('stat-assets').textContent = universe.totalAssets;
          document.getElementById('stat-characters').textContent = universe.characters;
        }
      } catch (error) {
        showMessage('Error fetching status: ' + error.message, 'error');
      }
    }

    // Start simulation
    async function startSimulation() {
      try {
        const response = await fetch('/admin/api/simulation/start', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
          showMessage('Simulation started successfully!', 'success');
          refreshStatus();
        } else {
          showMessage(data.message || 'Failed to start simulation', 'error');
        }
      } catch (error) {
        showMessage('Error starting simulation: ' + error.message, 'error');
      }
    }

    // Stop simulation
    async function stopSimulation() {
      try {
        const response = await fetch('/admin/api/simulation/stop', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
          showMessage('Simulation stopped', 'success');
          refreshStatus();
        } else {
          showMessage(data.message || 'Failed to stop simulation', 'error');
        }
      } catch (error) {
        showMessage('Error stopping simulation: ' + error.message, 'error');
      }
    }

    // Update simulation speed
    async function updateSpeed() {
      const tickRate = parseInt(document.getElementById('speed-slider').value);

      try {
        const response = await fetch('/admin/api/simulation/speed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tickRate })
        });
        const data = await response.json();

        if (data.success) {
          showMessage('Simulation speed updated!', 'success');
          refreshStatus();
        } else {
          showMessage(data.error || 'Failed to update speed', 'error');
        }
      } catch (error) {
        showMessage('Error updating speed: ' + error.message, 'error');
      }
    }

    // Seed test universe
    async function seedTestUniverse() {
      if (!confirm('This will create a test universe with 1 anomaly, 1 galaxy, 1 star, and 5 planets. Continue?')) {
        return;
      }

      try {
        showMessage('Seeding test universe...', 'success');
        const response = await fetch('/admin/scripts/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scriptFile: 'seed-test-universe.js' })
        });

        const text = await response.text();
        console.log('Seed output:', text);

        showMessage('Test universe seeded! Refreshing status...', 'success');
        setTimeout(refreshStatus, 1000);
      } catch (error) {
        showMessage('Error seeding universe: ' + error.message, 'error');
      }
    }

    // Reset universe
    async function resetUniverse() {
      if (!confirm('‚ö†Ô∏è WARNING: This will delete all assets and reset all characters! Are you sure?')) {
        return;
      }

      if (!confirm('This action cannot be undone. Really reset the universe?')) {
        return;
      }

      try {
        const response = await fetch('/admin/api/simulation/reset', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
          showMessage(`Universe reset! Deleted ${data.deleted.assets} assets, reset ${data.deleted.charactersReset} characters.`, 'success');
          refreshStatus();
        } else {
          showMessage(data.error || 'Failed to reset universe', 'error');
        }
      } catch (error) {
        showMessage('Error resetting universe: ' + error.message, 'error');
      }
    }

    // Navigation helpers
    function viewGalacticMap() {
      window.location.href = '/universe/galactic-map-3d';
    }

    function viewScriptPanel() {
      window.location.href = '/admin/control-panel';
    }

    // Auto-refresh status every 5 seconds
    refreshStatus();
    setInterval(refreshStatus, 5000);
  </script>
</body>
</html>
