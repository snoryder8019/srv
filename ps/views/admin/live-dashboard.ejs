<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      background: #0a0e27;
      color: #fff;
      font-family: 'Courier New', monospace;
      margin: 0;
      padding: 0;
    }

    .live-dashboard {
      padding: 20px;
      max-width: 1800px;
      margin: 0 auto;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #8a4fff;
    }

    .dashboard-header h1 {
      margin: 0;
      color: #8a4fff;
      font-size: 32px;
      text-shadow: 0 0 20px rgba(138, 79, 255, 0.8);
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .pulse-dot {
      width: 12px;
      height: 12px;
      background: #00ff9f;
      border-radius: 50%;
      animation: pulse 2s infinite;
      box-shadow: 0 0 10px #00ff9f;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .dashboard-card {
      background: rgba(138, 79, 255, 0.05);
      border: 2px solid #8a4fff;
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .dashboard-card:hover {
      border-color: #00ff9f;
      box-shadow: 0 0 30px rgba(0, 255, 159, 0.3);
      transform: translateY(-2px);
    }

    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #8a4fff, #00ff9f);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .card-title {
      font-size: 14px;
      color: #8a4fff;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 0;
      font-weight: bold;
    }

    .card-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-healthy {
      background: rgba(0, 255, 159, 0.2);
      color: #00ff9f;
      border: 1px solid #00ff9f;
    }

    .status-degraded {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
      border: 1px solid #ffc107;
    }

    .status-down {
      background: rgba(255, 82, 82, 0.2);
      color: #ff5252;
      border: 1px solid #ff5252;
    }

    .card-value {
      font-size: 48px;
      font-weight: bold;
      color: #00ff9f;
      margin: 10px 0;
      text-shadow: 0 0 20px rgba(0, 255, 159, 0.5);
    }

    .card-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
    }

    .service-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .service-item {
      padding: 12px;
      border-bottom: 1px solid rgba(138, 79, 255, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .service-item:hover {
      background: rgba(138, 79, 255, 0.1);
    }

    .service-item:last-child {
      border-bottom: none;
    }

    .service-name {
      color: #fff;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .service-icon {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .icon-healthy { background: #00ff9f; box-shadow: 0 0 8px #00ff9f; }
    .icon-degraded { background: #ffc107; box-shadow: 0 0 8px #ffc107; }
    .icon-down { background: #ff5252; box-shadow: 0 0 8px #ff5252; }

    .test-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .test-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #8a4fff, #6d3acc);
      border: 1px solid #8a4fff;
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-family: 'Courier New', monospace;
      transition: all 0.3s;
      font-size: 12px;
      text-transform: uppercase;
    }

    .test-btn:hover {
      background: linear-gradient(135deg, #6d3acc, #8a4fff);
      box-shadow: 0 0 20px rgba(138, 79, 255, 0.5);
      transform: translateY(-2px);
    }

    .test-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .test-output {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(138, 79, 255, 0.3);
      border-radius: 6px;
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 12px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
    }

    .test-output::-webkit-scrollbar {
      width: 8px;
    }

    .test-output::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
    }

    .test-output::-webkit-scrollbar-thumb {
      background: #8a4fff;
      border-radius: 4px;
    }

    .test-line {
      margin: 2px 0;
      padding: 2px 0;
    }

    .test-line.success { color: #00ff9f; }
    .test-line.error { color: #ff5252; }
    .test-line.info { color: #64b5f6; }

    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(138, 79, 255, 0.2);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #8a4fff, #00ff9f);
      transition: width 0.3s ease;
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { background-position: -100% 0; }
      100% { background-position: 100% 0; }
    }

    .metric-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(138, 79, 255, 0.2);
    }

    .metric-row:last-child {
      border-bottom: none;
    }

    .metric-label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 13px;
    }

    .metric-value {
      color: #00ff9f;
      font-weight: bold;
      font-size: 13px;
    }

    .cron-job-item {
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 3px solid #8a4fff;
    }

    .cron-job-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .cron-job-name {
      font-weight: bold;
      color: #fff;
    }

    .cron-job-schedule {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      font-family: 'Courier New', monospace;
    }

    .cron-trigger-btn {
      padding: 4px 12px;
      background: rgba(0, 255, 159, 0.2);
      border: 1px solid #00ff9f;
      color: #00ff9f;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-family: 'Courier New', monospace;
      transition: all 0.2s;
    }

    .cron-trigger-btn:hover {
      background: rgba(0, 255, 159, 0.3);
      box-shadow: 0 0 10px rgba(0, 255, 159, 0.5);
    }

    .action-btn {
      padding: 8px 16px;
      background: rgba(0, 255, 159, 0.1);
      border: 1px solid #00ff9f;
      color: #00ff9f;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      transition: all 0.3s;
      text-transform: uppercase;
      font-weight: bold;
    }

    .action-btn:hover {
      background: rgba(0, 255, 159, 0.2);
      box-shadow: 0 0 15px rgba(0, 255, 159, 0.3);
    }

    .script-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .script-item {
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }

    .script-item:hover {
      background: rgba(138, 79, 255, 0.1);
    }

    .script-name {
      color: #fff;
      font-size: 12px;
    }

    .run-script-btn {
      padding: 4px 10px;
      background: rgba(138, 79, 255, 0.3);
      border: 1px solid #8a4fff;
      color: #8a4fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      transition: all 0.2s;
    }

    .run-script-btn:hover {
      background: rgba(138, 79, 255, 0.5);
      color: #fff;
    }

    .wide-card {
      grid-column: span 2;
    }

    @media (max-width: 768px) {
      .wide-card {
        grid-column: span 1;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #00ff9f;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <%- include('../partials/header', { user: user }) %>

  <div class="live-dashboard">
    <div class="dashboard-header">
      <h1>‚ö° Live Admin Dashboard</h1>
      <div class="live-indicator">
        <div class="pulse-dot"></div>
        <span>Real-time Monitoring Active</span>
      </div>
    </div>

    <!-- System Metrics -->
    <div class="dashboard-grid">
      <!-- CPU Usage -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3 class="card-title">CPU Usage</h3>
          <span class="card-status status-healthy" id="cpu-status">Normal</span>
        </div>
        <div class="card-value" id="cpu-value">0%</div>
        <div class="card-label">System Load</div>
        <div class="progress-bar">
          <div class="progress-fill" id="cpu-progress" style="width: 0%"></div>
        </div>
      </div>

      <!-- Memory Usage -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3 class="card-title">Memory Usage</h3>
          <span class="card-status status-healthy" id="mem-status">Normal</span>
        </div>
        <div class="card-value" id="mem-value">0%</div>
        <div class="card-label" id="mem-details">0 MB / 0 MB</div>
        <div class="progress-bar">
          <div class="progress-fill" id="mem-progress" style="width: 0%"></div>
        </div>
      </div>

      <!-- Database Status -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3 class="card-title">Database</h3>
          <span class="card-status status-healthy" id="db-status">Connected</span>
        </div>
        <div class="card-value" style="font-size: 32px;">MongoDB</div>
        <div class="card-label">projectStringborne</div>
        <button class="action-btn" onclick="testDatabaseConnection()" style="margin-top: 10px; width: 100%;">
          Test Connection
        </button>
      </div>

      <!-- Server Uptime -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3 class="card-title">Server Uptime</h3>
          <span class="card-status status-healthy">Running</span>
        </div>
        <div class="card-value" style="font-size: 32px;" id="uptime-value">0h 0m</div>
        <div class="card-label">Since Last Restart</div>
      </div>
    </div>

    <!-- Services Status -->
    <div class="dashboard-grid">
      <div class="dashboard-card wide-card">
        <div class="card-header">
          <h3 class="card-title">üîß Services Status</h3>
          <button class="action-btn" onclick="refreshServices()">Refresh</button>
        </div>
        <ul class="service-list" id="services-list">
          <li class="service-item">
            <span class="service-name">
              <span class="service-icon icon-healthy"></span>
              Loading services...
            </span>
          </li>
        </ul>
      </div>
    </div>

    <!-- Test Metrics Dashboard -->
    <div class="section-header" style="margin: 40px 0 20px 0; padding-bottom: 15px; border-bottom: 2px solid rgba(138, 79, 255, 0.3);">
      <h2 style="color: #00ff9f; font-size: 24px; margin: 0;">üìä Test Metrics & Analytics</h2>
    </div>

    <!-- Key Metrics Cards -->
    <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
      <div class="dashboard-card metric-card">
        <div class="metric-icon" style="font-size: 32px; margin-bottom: 10px;">‚úÖ</div>
        <div class="metric-value" id="total-tests" style="font-size: 36px; color: #00ff9f; font-weight: bold;">-</div>
        <div class="metric-label" style="font-size: 12px; opacity: 0.7;">Total Tests</div>
      </div>
      <div class="dashboard-card metric-card">
        <div class="metric-icon" style="font-size: 32px; margin-bottom: 10px;">üéØ</div>
        <div class="metric-value" id="pass-rate" style="font-size: 36px; color: #00ff9f; font-weight: bold;">-</div>
        <div class="metric-label" style="font-size: 12px; opacity: 0.7;">Pass Rate</div>
      </div>
      <div class="dashboard-card metric-card">
        <div class="metric-icon" style="font-size: 32px; margin-bottom: 10px;">‚ö°</div>
        <div class="metric-value" id="avg-duration" style="font-size: 36px; color: #64b5f6; font-weight: bold;">-</div>
        <div class="metric-label" style="font-size: 12px; opacity: 0.7;">Avg Duration (ms)</div>
      </div>
      <div class="dashboard-card metric-card">
        <div class="metric-icon" style="font-size: 32px; margin-bottom: 10px;">üìà</div>
        <div class="metric-value" id="test-trend" style="font-size: 24px; color: #00ff9f; font-weight: bold;">-</div>
        <div class="metric-label" style="font-size: 12px; opacity: 0.7;">Trend</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
      <!-- Test Results Chart -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3 class="card-title">üìä Test Results Distribution</h3>
        </div>
        <div style="position: relative; height: 250px; padding: 20px;">
          <canvas id="test-results-chart"></canvas>
        </div>
      </div>

      <!-- Performance Trends Chart -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3 class="card-title">üìà Test History (Last 20 Runs)</h3>
        </div>
        <div style="position: relative; height: 250px; padding: 20px;">
          <canvas id="test-history-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Suite Performance 3D Visualization -->
    <div class="dashboard-grid">
      <div class="dashboard-card wide-card">
        <div class="card-header">
          <h3 class="card-title">üéÆ 3D Performance Visualization</h3>
          <button class="action-btn" onclick="animate3DChart()">Rotate</button>
        </div>
        <div id="three-container" style="width: 100%; height: 400px; background: rgba(0,0,0,0.3); border-radius: 8px;"></div>
      </div>
    </div>

    <!-- Detailed Suite Breakdown -->
    <div class="dashboard-grid">
      <div class="dashboard-card wide-card">
        <div class="card-header">
          <h3 class="card-title">üìã Suite Performance Breakdown</h3>
        </div>
        <div id="suite-breakdown" style="padding: 10px;">
          <div style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">Loading metrics...</div>
        </div>
      </div>
    </div>

    <!-- Test Runner -->
    <div class="dashboard-grid">
      <div class="dashboard-card wide-card">
        <div class="card-header">
          <h3 class="card-title">üß™ Test Runner</h3>
          <span class="card-status status-healthy" id="test-status">Ready</span>
        </div>

        <div class="test-controls">
          <button class="test-btn" onclick="runTests('all')">Run All Tests</button>
          <button class="test-btn" onclick="runTests('api')">API Tests</button>
          <button class="test-btn" onclick="runTests('integration')">Integration Tests</button>
          <button class="test-btn" onclick="runTests('performance')">Performance Tests</button>
        </div>

        <div class="test-output" id="test-output" style="display: none;">
          <div class="test-line info">Ready to run tests...</div>
        </div>
      </div>
    </div>

    <!-- Cron Jobs -->
    <div class="dashboard-grid">
      <div class="dashboard-card">
        <div class="card-header">
          <h3 class="card-title">‚è∞ Scheduled Jobs</h3>
          <button class="action-btn" onclick="refreshCronJobs()">Refresh</button>
        </div>
        <div id="cron-jobs-list">
          <div style="color: rgba(255,255,255,0.6); font-size: 12px;">Loading cron jobs...</div>
        </div>
      </div>

      <!-- Database Metrics -->
      <div class="dashboard-card">
        <div class="card-header">
          <h3 class="card-title">üìä Database Metrics</h3>
        </div>
        <div id="db-metrics">
          <div class="metric-row">
            <span class="metric-label">Collections</span>
            <span class="metric-value" id="db-collections">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Total Users</span>
            <span class="metric-value" id="db-users">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Total Characters</span>
            <span class="metric-value" id="db-characters">-</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Total Assets</span>
            <span class="metric-value" id="db-assets">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Unified MongoDB Management -->
    <div class="dashboard-grid">
      <div class="dashboard-card wide-card">
        <div class="card-header">
          <h3 class="card-title">üóÑÔ∏è MongoDB Database Management</h3>
          <button class="action-btn" onclick="refreshAllDatabaseData()">Refresh All</button>
        </div>

        <!-- Summary Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
          <div style="text-align: center; padding: 15px; background: rgba(0, 255, 159, 0.1); border-radius: 8px;">
            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Total Size</div>
            <div style="font-size: 24px; color: #00ff9f; font-weight: bold;" id="db-total-size">-</div>
          </div>
          <div style="text-align: center; padding: 15px; background: rgba(100, 181, 246, 0.1); border-radius: 8px;">
            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Data Size</div>
            <div style="font-size: 24px; color: #64b5f6; font-weight: bold;" id="db-data-size">-</div>
          </div>
          <div style="text-align: center; padding: 15px; background: rgba(138, 79, 255, 0.1); border-radius: 8px;">
            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Index Size</div>
            <div style="font-size: 24px; color: #8a4fff; font-weight: bold;" id="db-index-size">-</div>
          </div>
          <div style="text-align: center; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px;">
            <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Total Documents</div>
            <div style="font-size: 24px; color: #ffc107; font-weight: bold;" id="db-total-docs">-</div>
          </div>
        </div>

        <!-- Collections Table with Actions -->
        <div style="overflow-x: auto;">
          <h4 style="color: #8a4fff; margin-bottom: 10px; font-size: 14px;">Collections (Sorted by Size)</h4>
          <div id="unified-collections-table" style="font-size: 12px;">
            <div style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Linode Server Metrics -->
    <div class="dashboard-grid">
      <div class="dashboard-card wide-card">
        <div class="card-header">
          <h3 class="card-title">‚òÅÔ∏è Linode Server Metrics</h3>
          <button class="action-btn" onclick="refreshLinodeMetrics()">Refresh</button>
        </div>
        <div id="linode-metrics-container">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            <div style="padding: 15px; background: rgba(138, 79, 255, 0.1); border-radius: 8px;">
              <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Plan Type</div>
              <div style="font-size: 18px; color: #8a4fff; font-weight: bold;" id="linode-plan">-</div>
            </div>
            <div style="padding: 15px; background: rgba(0, 255, 159, 0.1); border-radius: 8px;">
              <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Region</div>
              <div style="font-size: 18px; color: #00ff9f; font-weight: bold;" id="linode-region">-</div>
            </div>
            <div style="padding: 15px; background: rgba(100, 181, 246, 0.1); border-radius: 8px;">
              <div style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">Status</div>
              <div style="font-size: 18px; color: #64b5f6; font-weight: bold;" id="linode-status">-</div>
            </div>
          </div>
          <div style="margin-top: 20px;">
            <h4 style="color: #8a4fff; margin-bottom: 10px; font-size: 14px;">Network I/O (Last 24h)</h4>
            <div style="height: 200px; position: relative;">
              <canvas id="linode-network-chart"></canvas>
            </div>
          </div>
          <div style="margin-top: 20px;">
            <h4 style="color: #8a4fff; margin-bottom: 10px; font-size: 14px;">Disk I/O (Last 24h)</h4>
            <div style="height: 200px; position: relative;">
              <canvas id="linode-disk-chart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Document Viewer Modal -->
  <div id="documentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; overflow: auto;">
    <div style="max-width: 1200px; margin: 50px auto; background: #0a0a0f; border: 1px solid #8a4fff; border-radius: 8px; padding: 30px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="color: #8a4fff; margin: 0;" id="modalTitle">Documents</h2>
        <button onclick="closeDocumentModal()" style="background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0 10px;">&times;</button>
      </div>
      <div id="modalContent" style="background: #000; border: 1px solid #333; border-radius: 4px; padding: 20px; max-height: 70vh; overflow: auto; font-family: monospace; font-size: 12px; line-height: 1.6; color: #00ff9f;">
        <!-- Content will be populated here -->
      </div>
      <div style="margin-top: 20px; text-align: right;">
        <button onclick="closeDocumentModal()" style="padding: 10px 20px; background: #8a4fff; border: none; border-radius: 4px; color: #fff; cursor: pointer;">Close</button>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>

  <!-- Chart.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Three.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>

  <script>
    // Auto-refresh system status every 5 seconds
    let refreshInterval;

    async function loadSystemStatus() {
      try {
        const response = await fetch('/admin/api/monitor/status');
        const data = await response.json();

        if (data.success) {
          updateSystemMetrics(data.system);
          updateServicesList(data.services);
        }
      } catch (error) {
        console.error('Error loading system status:', error);
      }
    }

    function updateSystemMetrics(system) {
      // CPU
      const cpuPercent = system.cpuUsagePercent.toFixed(1);
      document.getElementById('cpu-value').textContent = cpuPercent + '%';
      document.getElementById('cpu-progress').style.width = cpuPercent + '%';

      const cpuStatus = document.getElementById('cpu-status');
      if (cpuPercent > 80) {
        cpuStatus.textContent = 'High';
        cpuStatus.className = 'card-status status-degraded';
      } else {
        cpuStatus.textContent = 'Normal';
        cpuStatus.className = 'card-status status-healthy';
      }

      // Memory
      const memPercent = system.memUsagePercent.toFixed(1);
      document.getElementById('mem-value').textContent = memPercent + '%';
      document.getElementById('mem-progress').style.width = memPercent + '%';
      document.getElementById('mem-details').textContent =
        `${system.memUsedMB} MB / ${system.memTotalMB} MB`;

      const memStatus = document.getElementById('mem-status');
      if (memPercent > 80) {
        memStatus.textContent = 'High';
        memStatus.className = 'card-status status-degraded';
      } else {
        memStatus.textContent = 'Normal';
        memStatus.className = 'card-status status-healthy';
      }

      // Uptime
      const hours = Math.floor(system.uptime / 3600);
      const minutes = Math.floor((system.uptime % 3600) / 60);
      document.getElementById('uptime-value').textContent = `${hours}h ${minutes}m`;
    }

    function updateServicesList(services) {
      const list = document.getElementById('services-list');
      list.innerHTML = services.map(svc => {
        const statusClass = svc.status === 'healthy' ? 'healthy' :
                           svc.status === 'degraded' ? 'degraded' : 'down';
        const statusText = svc.status.toUpperCase();

        return `
          <li class="service-item">
            <span class="service-name">
              <span class="service-icon icon-${statusClass}"></span>
              ${svc.name}
            </span>
            <span class="card-status status-${statusClass}">${statusText}</span>
          </li>
        `;
      }).join('');
    }

    async function refreshServices() {
      await loadSystemStatus();
    }

    async function runTests(suite) {
      const output = document.getElementById('test-output');
      const status = document.getElementById('test-status');

      output.style.display = 'block';
      output.innerHTML = '<div class="test-line info"><span class="loading-spinner"></span>Running tests...</div>';
      status.textContent = 'Running';
      status.className = 'card-status status-degraded';

      try {
        const response = await fetch('/admin/api/tests/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ suite: suite === 'all' ? null : suite })
        });

        const data = await response.json();

        if (data.success) {
          displayTestResults(data.results);
          status.textContent = data.results.failed > 0 ? 'Failed' : 'Passed';
          status.className = data.results.failed > 0 ? 'card-status status-down' : 'card-status status-healthy';

          // Refresh test metrics after test completes
          await loadTestMetrics();
        } else {
          output.innerHTML = `<div class="test-line error">Error: ${data.error}</div>`;
          status.textContent = 'Error';
          status.className = 'card-status status-down';
        }
      } catch (error) {
        output.innerHTML = `<div class="test-line error">Failed to run tests: ${error.message}</div>`;
        status.textContent = 'Error';
        status.className = 'card-status status-down';
      }
    }

    function displayTestResults(results) {
      const output = document.getElementById('test-output');
      let html = '';

      html += `<div class="test-line info">üìä Test Results</div>`;
      html += `<div class="test-line info">Total: ${results.total} | Passed: ${results.passed} | Failed: ${results.failed}</div>`;
      html += `<div class="test-line info">Duration: ${results.duration}ms</div>`;
      html += `<div class="test-line info">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</div>`;

      for (const suite of results.suites) {
        html += `<div class="test-line info"><strong>${suite.name}</strong> (${suite.passed}/${suite.tests.length})</div>`;

        for (const test of suite.tests) {
          if (test.status === 'passed') {
            html += `<div class="test-line success">  ‚úì ${test.file}</div>`;
          } else {
            html += `<div class="test-line error">  ‚úó ${test.file}</div>`;
            if (test.error) {
              html += `<div class="test-line error">    ${test.error}</div>`;
            }
          }
        }
      }

      output.innerHTML = html;
      output.scrollTop = output.scrollHeight;
    }

    async function refreshCronJobs() {
      try {
        const response = await fetch('/admin/api/cron/status');
        const data = await response.json();

        if (data.success) {
          displayCronJobs(data.jobs);
        }
      } catch (error) {
        console.error('Error loading cron jobs:', error);
      }
    }

    function displayCronJobs(jobs) {
      const container = document.getElementById('cron-jobs-list');

      if (jobs.length === 0) {
        container.innerHTML = '<div style="color: rgba(255,255,255,0.6); font-size: 12px;">No cron jobs configured</div>';
        return;
      }

      container.innerHTML = jobs.map(job => `
        <div class="cron-job-item">
          <div class="cron-job-header">
            <div class="cron-job-name">${job.name}</div>
            <span class="card-status ${job.running ? 'status-healthy' : 'status-down'}">
              ${job.running ? 'Active' : 'Inactive'}
            </span>
          </div>
          <div class="cron-job-schedule">${job.schedule}</div>
          <button class="cron-trigger-btn" onclick="triggerCronJob('${job.name}')">
            Trigger Now
          </button>
        </div>
      `).join('');
    }

    async function triggerCronJob(jobName) {
      try {
        const response = await fetch(`/admin/api/cron/trigger/${encodeURIComponent(jobName)}`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          alert(`Job "${jobName}" triggered successfully!`);
        } else {
          alert(`Failed to trigger job: ${data.error}`);
        }
      } catch (error) {
        alert(`Error triggering job: ${error.message}`);
      }
    }

    async function testDatabaseConnection() {
      try {
        const response = await fetch('/admin/api/tests/database');
        const data = await response.json();

        if (data.success) {
          alert('Database connection successful!');
          document.getElementById('db-status').textContent = 'Connected';
          document.getElementById('db-status').className = 'card-status status-healthy';
        } else {
          alert('Database connection failed!');
          document.getElementById('db-status').textContent = 'Error';
          document.getElementById('db-status').className = 'card-status status-down';
        }
      } catch (error) {
        alert('Database connection failed: ' + error.message);
        document.getElementById('db-status').textContent = 'Error';
        document.getElementById('db-status').className = 'card-status status-down';
      }
    }

    async function loadDatabaseMetrics() {
      try {
        const response = await fetch('/admin/api/database/metrics');
        const data = await response.json();

        if (data.success) {
          document.getElementById('db-collections').textContent = data.metrics.collections || '-';
          document.getElementById('db-users').textContent = (data.metrics.users || 0).toLocaleString();
          document.getElementById('db-characters').textContent = (data.metrics.characters || 0).toLocaleString();
          document.getElementById('db-assets').textContent = (data.metrics.assets || 0).toLocaleString();
        }
      } catch (error) {
        console.error('Error loading database metrics:', error);
      }
    }

    // Format bytes helper
    function formatBytes(bytes, decimals = 2) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // Unified function to refresh all database data
    async function refreshAllDatabaseData() {
      try {
        const response = await fetch('/admin/api/database/collections');
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load collections');
        }

        // Calculate summary stats
        const totalSize = data.collections.reduce((sum, c) => sum + c.totalSize, 0);
        const totalDataSize = data.collections.reduce((sum, c) => sum + c.size, 0);
        const totalIndexSize = data.collections.reduce((sum, c) => sum + c.indexSize, 0);
        const totalDocs = data.collections.reduce((sum, c) => sum + c.count, 0);
        const emptyCollections = data.collections.filter(c => c.count === 0);

        // Update summary stats
        document.getElementById('db-total-size').textContent = formatBytes(totalSize);
        document.getElementById('db-data-size').textContent = formatBytes(totalDataSize);
        document.getElementById('db-index-size').textContent = formatBytes(totalIndexSize);
        document.getElementById('db-total-docs').textContent = totalDocs.toLocaleString();

        // Create unified table with all columns and actions
        const tableContainer = document.getElementById('unified-collections-table');
        let html = '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="border-bottom: 2px solid rgba(138, 79, 255, 0.3);">';
        html += '<th style="text-align: left; padding: 10px; color: #8a4fff;">Collection</th>';
        html += '<th style="text-align: right; padding: 10px; color: #8a4fff;">Docs</th>';
        html += '<th style="text-align: right; padding: 10px; color: #8a4fff;">Data Size</th>';
        html += '<th style="text-align: right; padding: 10px; color: #8a4fff;">Storage</th>';
        html += '<th style="text-align: right; padding: 10px; color: #8a4fff;">Indexes</th>';
        html += '<th style="text-align: right; padding: 10px; color: #8a4fff;">Total</th>';
        html += '<th style="text-align: right; padding: 10px; color: #8a4fff;">% of DB</th>';
        html += '<th style="text-align: center; padding: 10px; color: #8a4fff;">Actions</th>';
        html += '</tr></thead><tbody>';

        data.collections.forEach(c => {
          const isEmpty = c.count === 0;
          const rowColor = isEmpty ? 'rgba(255, 82, 82, 0.1)' : 'transparent';
          const nameColor = isEmpty ? '#ff5252' : '#fff';
          const percentOfTotal = totalSize > 0 ? ((c.totalSize / totalSize) * 100).toFixed(2) : 0;

          html += `<tr style="border-bottom: 1px solid rgba(138, 79, 255, 0.2); background: ${rowColor};">`;
          html += `<td style="padding: 10px; color: ${nameColor}; font-weight: bold;">${c.name}</td>`;
          html += `<td style="padding: 10px; text-align: right; color: #64b5f6;">${c.count.toLocaleString()}</td>`;
          html += `<td style="padding: 10px; text-align: right;">${formatBytes(c.size)}</td>`;
          html += `<td style="padding: 10px; text-align: right;">${formatBytes(c.storageSize)}</td>`;
          html += `<td style="padding: 10px; text-align: right; color: #8a4fff;">${formatBytes(c.indexSize)}</td>`;
          html += `<td style="padding: 10px; text-align: right; color: #00ff9f; font-weight: bold;">${formatBytes(c.totalSize)}</td>`;
          html += `<td style="padding: 10px; text-align: right; color: #ffc107;">${percentOfTotal}%</td>`;
          html += `<td style="padding: 10px; text-align: center;">`;

          if (c.count > 0) {
            html += `<button onclick="viewDocuments('${c.name}')" style="padding: 5px 10px; background: #00aaff; border: none; border-radius: 4px; color: #fff; cursor: pointer; margin-right: 5px; font-size: 11px;">üìÑ View</button>`;
          }

          if (isEmpty) {
            html += `<button onclick="dropCollection('${c.name}')" style="padding: 5px 10px; background: #ff5252; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 11px;">üóëÔ∏è Drop</button>`;
          }

          html += `</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';

        // Add summary footer
        html += `<div style="margin-top: 20px; padding: 15px; background: rgba(138, 79, 255, 0.1); border-radius: 6px;">`;
        html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">`;
        html += `<div><span style="opacity: 0.7;">Total Collections:</span> <strong>${data.collections.length}</strong></div>`;
        html += `<div><span style="opacity: 0.7;">Empty Collections:</span> <strong style="color: ${emptyCollections.length > 0 ? '#ff5252' : '#00ff9f'};">${emptyCollections.length}</strong></div>`;
        html += `</div>`;

        if (emptyCollections.length > 0) {
          html += `<div style="margin-top: 10px; color: #ffc107;">‚ö†Ô∏è You have ${emptyCollections.length} empty collection(s) that can be cleaned up</div>`;
        }

        html += `</div>`;

        tableContainer.innerHTML = html;
      } catch (error) {
        console.error('Error loading database data:', error);
        document.getElementById('unified-collections-table').innerHTML =
          `<div style="color: #ff5252; text-align: center; padding: 20px;">Error: ${error.message}</div>`;
      }
    }

    // Backward compatibility - keep old function names
    async function refreshDatabaseUsage() {
      return refreshAllDatabaseData();
    }

    let linodeNetworkChart = null;
    let linodeDiskChart = null;

    async function refreshLinodeMetrics() {
      try {
        const response = await fetch('/admin/api/linode/metrics');
        const data = await response.json();

        if (!data.success) {
          document.getElementById('linode-plan').textContent = 'Not configured';
          document.getElementById('linode-region').textContent = data.error || 'N/A';
          document.getElementById('linode-status').textContent = 'N/A';
          return;
        }

        const metrics = data.metrics;

        // Update instance info
        document.getElementById('linode-plan').textContent = metrics.instance.type || 'N/A';
        document.getElementById('linode-region').textContent = metrics.instance.region || 'N/A';
        document.getElementById('linode-status').textContent = metrics.instance.status || 'N/A';

        // Network I/O Chart
        if (metrics.netv4 && metrics.netv4.in && metrics.netv4.out) {
          const netCtx = document.getElementById('linode-network-chart');
          if (netCtx) {
            if (linodeNetworkChart) {
              linodeNetworkChart.destroy();
            }

            const inData = metrics.netv4.in;
            const outData = metrics.netv4.out;

            linodeNetworkChart = new Chart(netCtx, {
              type: 'line',
              data: {
                labels: inData.map((_, i) => i),
                datasets: [
                  {
                    label: 'In (Mbps)',
                    data: inData.map(v => (v[1] / 125000).toFixed(2)), // Convert bits/s to Mbps
                    borderColor: '#00ff9f',
                    backgroundColor: 'rgba(0, 255, 159, 0.1)',
                    tension: 0.4,
                    fill: true
                  },
                  {
                    label: 'Out (Mbps)',
                    data: outData.map(v => (v[1] / 125000).toFixed(2)),
                    borderColor: '#64b5f6',
                    backgroundColor: 'rgba(100, 181, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    labels: { color: '#fff', font: { size: 11 } }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: { color: '#fff', font: { size: 10 } },
                    grid: { color: 'rgba(138, 79, 255, 0.2)' }
                  },
                  x: {
                    display: false
                  }
                }
              }
            });
          }
        }

        // Disk I/O Chart
        if (metrics.io && metrics.io.io && metrics.io.swap) {
          const diskCtx = document.getElementById('linode-disk-chart');
          if (diskCtx) {
            if (linodeDiskChart) {
              linodeDiskChart.destroy();
            }

            const ioData = metrics.io.io;
            const swapData = metrics.io.swap;

            linodeDiskChart = new Chart(diskCtx, {
              type: 'line',
              data: {
                labels: ioData.map((_, i) => i),
                datasets: [
                  {
                    label: 'I/O (blocks/s)',
                    data: ioData.map(v => v[1]),
                    borderColor: '#8a4fff',
                    backgroundColor: 'rgba(138, 79, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                  },
                  {
                    label: 'Swap (blocks/s)',
                    data: swapData.map(v => v[1]),
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.4,
                    fill: true
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    labels: { color: '#fff', font: { size: 11 } }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: { color: '#fff', font: { size: 10 } },
                    grid: { color: 'rgba(138, 79, 255, 0.2)' }
                  },
                  x: {
                    display: false
                  }
                }
              }
            });
          }
        }
      } catch (error) {
        console.error('Error loading Linode metrics:', error);
        document.getElementById('linode-plan').textContent = 'Error';
        document.getElementById('linode-region').textContent = error.message;
        document.getElementById('linode-status').textContent = 'Error';
      }
    }

    // Initialize dashboard
    // ========================================
    // TEST METRICS VISUALIZATION
    // ========================================

    let testResultsChart = null;
    let testHistoryChart = null;
    let threeScene = null;
    let threeRenderer = null;
    let threeCamera = null;
    let threeBars = [];
    let rotationEnabled = false;

    async function loadTestMetrics() {
      try {
        const response = await fetch('/admin/api/tests/metrics');
        const data = await response.json();

        if (data.success) {
          updateMetricsCards(data.metrics, data.latest);
          createTestResultsChart(data.latest);
          createTestHistoryChart(data.history);
          create3DVisualization(data.latest);
          createSuiteBreakdown(data.latest);
        }
      } catch (error) {
        console.error('Error loading test metrics:', error);
      }
    }

    function updateMetricsCards(metrics, latest) {
      document.getElementById('total-tests').textContent = latest.total;
      document.getElementById('pass-rate').textContent = metrics.passRate + '%';
      document.getElementById('avg-duration').textContent = Number(metrics.avgDuration).toLocaleString();

      const trendEl = document.getElementById('test-trend');
      const trendIcons = {
        improving: 'üìà Improving',
        declining: 'üìâ Declining',
        stable: '‚û°Ô∏è Stable'
      };
      trendEl.textContent = trendIcons[metrics.trend] || metrics.trend;
      trendEl.style.color = metrics.trend === 'improving' ? '#00ff9f' :
                           metrics.trend === 'declining' ? '#ff5252' : '#64b5f6';
    }

    function createTestResultsChart(latest) {
      const ctx = document.getElementById('test-results-chart');
      if (!ctx) return;

      if (testResultsChart) {
        testResultsChart.destroy();
      }

      const suiteData = latest.suites.map(s => ({
        name: s.name.toUpperCase(),
        passed: s.passed,
        failed: s.failed
      }));

      testResultsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: suiteData.map(s => s.name),
          datasets: [
            {
              label: 'Passed',
              data: suiteData.map(s => s.passed),
              backgroundColor: 'rgba(0, 255, 159, 0.8)',
              borderColor: 'rgba(0, 255, 159, 1)',
              borderWidth: 2
            },
            {
              label: 'Failed',
              data: suiteData.map(s => s.failed),
              backgroundColor: 'rgba(255, 82, 82, 0.8)',
              borderColor: 'rgba(255, 82, 82, 1)',
              borderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#fff', font: { size: 12 } }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#fff', font: { size: 11 } },
              grid: { color: 'rgba(138, 79, 255, 0.2)' }
            },
            x: {
              ticks: { color: '#fff', font: { size: 11 } },
              grid: { color: 'rgba(138, 79, 255, 0.2)' }
            }
          }
        }
      });
    }

    function createTestHistoryChart(history) {
      const ctx = document.getElementById('test-history-chart');
      if (!ctx) return;

      if (testHistoryChart) {
        testHistoryChart.destroy();
      }

      const historyData = history.slice().reverse(); // Oldest first

      testHistoryChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: historyData.map((h, i) => `Run ${i + 1}`),
          datasets: [
            {
              label: 'Pass Rate %',
              data: historyData.map(h => ((h.passed / h.total) * 100).toFixed(1)),
              borderColor: '#00ff9f',
              backgroundColor: 'rgba(0, 255, 159, 0.1)',
              tension: 0.4,
              fill: true,
              yAxisID: 'y'
            },
            {
              label: 'Duration (s)',
              data: historyData.map(h => (h.duration / 1000).toFixed(2)),
              borderColor: '#64b5f6',
              backgroundColor: 'rgba(100, 181, 246, 0.1)',
              tension: 0.4,
              fill: true,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              labels: { color: '#fff', font: { size: 12 } }
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              ticks: { color: '#00ff9f', font: { size: 10 } },
              grid: { color: 'rgba(138, 79, 255, 0.2)' },
              title: { display: true, text: 'Pass Rate %', color: '#00ff9f' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              ticks: { color: '#64b5f6', font: { size: 10 } },
              grid: { drawOnChartArea: false },
              title: { display: true, text: 'Duration (s)', color: '#64b5f6' }
            },
            x: {
              ticks: { color: '#fff', font: { size: 10 }, maxRotation: 45 },
              grid: { color: 'rgba(138, 79, 255, 0.2)' }
            }
          }
        }
      });
    }

    function create3DVisualization(latest) {
      const container = document.getElementById('three-container');
      if (!container) return;

      // Clear existing
      container.innerHTML = '';

      const width = container.clientWidth;
      const height = 400;

      // Scene
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0a0e27);

      // Camera
      const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
      camera.position.set(0, 5, 10);
      camera.lookAt(0, 0, 0);

      // Renderer
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(width, height);
      container.appendChild(renderer.domElement);

      // Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const pointLight = new THREE.PointLight(0x8a4fff, 1, 100);
      pointLight.position.set(10, 10, 10);
      scene.add(pointLight);

      // Create bars for each suite
      threeBars = [];
      const suites = latest.suites;
      const spacing = 3;
      const startX = -(suites.length - 1) * spacing / 2;

      suites.forEach((suite, i) => {
        const height = (suite.passed / suite.tests.length) * 5 || 0.1;
        const geometry = new THREE.BoxGeometry(2, height, 2);

        // Color based on pass rate
        const passRate = suite.passed / suite.tests.length;
        const color = passRate === 1 ? 0x00ff9f :
                      passRate > 0.5 ? 0x64b5f6 : 0xff5252;

        const material = new THREE.MeshPhongMaterial({
          color,
          emissive: color,
          emissiveIntensity: 0.2,
          shininess: 100
        });

        const cube = new THREE.Mesh(geometry, material);
        cube.position.set(startX + i * spacing, height / 2, 0);
        scene.add(cube);
        threeBars.push(cube);

        // Add label
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 256;
        canvas.height = 128;
        ctx.fillStyle = '#ffffff';
        ctx.font = '32px Courier';
        ctx.textAlign = 'center';
        ctx.fillText(suite.name.toUpperCase(), 128, 64);

        const texture = new THREE.CanvasTexture(canvas);
        const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
        const sprite = new THREE.Sprite(spriteMaterial);
        sprite.position.set(startX + i * spacing, height + 1, 0);
        sprite.scale.set(2, 1, 1);
        scene.add(sprite);
      });

      // Grid
      const gridHelper = new THREE.GridHelper(20, 20, 0x8a4fff, 0x444444);
      scene.add(gridHelper);

      // Animation
      let rotation = 0;
      function animate() {
        requestAnimationFrame(animate);

        if (rotationEnabled) {
          rotation += 0.01;
          camera.position.x = Math.sin(rotation) * 12;
          camera.position.z = Math.cos(rotation) * 12;
          camera.lookAt(0, 2, 0);
        }

        renderer.render(scene, camera);
      }

      animate();

      // Store refs
      threeScene = scene;
      threeRenderer = renderer;
      threeCamera = camera;
    }

    function animate3DChart() {
      rotationEnabled = !rotationEnabled;
      event.target.textContent = rotationEnabled ? 'Stop' : 'Rotate';
    }

    function createSuiteBreakdown(latest) {
      const container = document.getElementById('suite-breakdown');
      if (!container) return;

      let html = '<div style="display: grid; gap: 15px;">';

      latest.suites.forEach(suite => {
        const passRate = ((suite.passed / suite.tests.length) * 100).toFixed(1);
        const color = passRate === '100.0' ? '#00ff9f' :
                     passRate >= '50.0' ? '#64b5f6' : '#ff5252';

        html += `
          <div style="background: rgba(138,79,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid ${color};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <div style="font-size: 16px; font-weight: bold; color: ${color};">
                ${suite.name.toUpperCase()} Suite
              </div>
              <div style="font-size: 20px; color: ${color};">${passRate}%</div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 12px;">
              <div>
                <div style="opacity: 0.7;">Total Tests</div>
                <div style="color: #64b5f6; font-size: 18px;">${suite.tests.length}</div>
              </div>
              <div>
                <div style="opacity: 0.7;">Passed</div>
                <div style="color: #00ff9f; font-size: 18px;">${suite.passed}</div>
              </div>
              <div>
                <div style="opacity: 0.7;">Duration</div>
                <div style="color: #fff; font-size: 18px;">${suite.duration}ms</div>
              </div>
            </div>
            <div style="margin-top: 10px;">
              <div style="background: rgba(0,0,0,0.3); height: 6px; border-radius: 3px; overflow: hidden;">
                <div style="background: ${color}; height: 100%; width: ${passRate}%; transition: width 0.3s;"></div>
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
    }

    // ========================================
    // MONGODB COLLECTIONS BROWSER
    // ========================================

    // Backward compatibility - alias for old function
    async function loadCollections() {
      return refreshAllDatabaseData();
    }

    async function viewDocuments(collectionName) {
      try {
        const response = await fetch(`/admin/api/database/collections/${collectionName}/documents?limit=100`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load documents');
        }

        document.getElementById('modalTitle').textContent = `${collectionName} (${data.total} documents)`;

        let html = '';
        if (data.documents.length === 0) {
          html = '<div style="color: rgba(255,255,255,0.5);">No documents found</div>';
        } else {
          html = '<pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">';
          html += JSON.stringify(data.documents, null, 2);
          html += '</pre>';

          if (data.hasMore) {
            html += `<div style="margin-top: 20px; padding: 15px; background: rgba(138, 79, 255, 0.1); border-radius: 4px; text-align: center; color: #8a4fff;">`;
            html += `Showing ${data.documents.length} of ${data.total} documents. Use API to load more.`;
            html += `</div>`;
          }
        }

        document.getElementById('modalContent').innerHTML = html;
        document.getElementById('documentModal').style.display = 'block';
      } catch (error) {
        alert('Error loading documents: ' + error.message);
      }
    }

    async function dropCollection(collectionName) {
      if (!confirm(`Are you sure you want to drop the empty collection "${collectionName}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/admin/api/database/collections/${collectionName}`, {
          method: 'DELETE'
        });
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to drop collection');
        }

        alert(`‚úÖ Collection "${collectionName}" dropped successfully!`);
        refreshAllDatabaseData(); // Reload the unified table
      } catch (error) {
        alert('Error dropping collection: ' + error.message);
      }
    }

    function closeDocumentModal() {
      document.getElementById('documentModal').style.display = 'none';
    }

    // Close modal when clicking outside
    document.getElementById('documentModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeDocumentModal();
      }
    });

    // ========================================
    // DASHBOARD INITIALIZATION
    // ========================================

    async function initDashboard() {
      await loadSystemStatus();
      await refreshCronJobs();
      await loadDatabaseMetrics();
      await loadTestMetrics();
      await refreshDatabaseUsage();
      await refreshLinodeMetrics();
      await loadCollections();

      // Auto-refresh every 5 seconds
      refreshInterval = setInterval(() => {
        loadSystemStatus();
      }, 5000);
    }

    // Start dashboard
    initDashboard();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>
</body>
</html>
