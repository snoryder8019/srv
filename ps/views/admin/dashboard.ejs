<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <style>
    .admin-dashboard {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .dashboard-header {
      margin-bottom: 30px;
    }

    .dashboard-header h1 {
      margin: 0 0 10px 0;
      color: #00ff9f;
    }

    .dashboard-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .dashboard-nav a {
      padding: 10px 20px;
      background: rgba(0, 255, 159, 0.1);
      border: 1px solid #00ff9f;
      color: #00ff9f;
      text-decoration: none;
      border-radius: 4px;
      transition: all 0.3s;
    }

    .dashboard-nav a:hover {
      background: rgba(0, 255, 159, 0.2);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(0, 255, 159, 0.05);
      border: 1px solid #00ff9f;
      border-radius: 8px;
      padding: 20px;
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #00ff9f;
      font-size: 14px;
      text-transform: uppercase;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #fff;
      margin: 0;
    }

    .stat-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 5px;
    }

    .chart-section {
      background: rgba(0, 255, 159, 0.05);
      border: 1px solid #00ff9f;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .chart-section h2 {
      margin: 0 0 20px 0;
      color: #00ff9f;
    }

    .action-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .action-item {
      padding: 10px;
      border-bottom: 1px solid rgba(0, 255, 159, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .action-item:last-child {
      border-bottom: none;
    }

    .action-type {
      color: #00ff9f;
      font-weight: bold;
    }

    .action-count {
      background: rgba(0, 255, 159, 0.2);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
    }

    .user-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .user-item {
      padding: 12px;
      border-bottom: 1px solid rgba(0, 255, 159, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-item:last-child {
      border-bottom: none;
    }

    .user-name {
      color: #fff;
      font-weight: bold;
    }

    .user-actions {
      background: rgba(0, 255, 159, 0.2);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
    }

    .chart-container {
      height: 300px;
      position: relative;
    }

    .achievement-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .achievement-item {
      padding: 10px;
      border-bottom: 1px solid rgba(0, 255, 159, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .achievement-item:last-child {
      border-bottom: none;
    }

    .achievement-name {
      color: #fff;
    }

    .achievement-count {
      background: rgba(0, 255, 159, 0.2);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.6);
    }

    .error {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid #ff0000;
      padding: 15px;
      border-radius: 4px;
      color: #ff0000;
      margin: 20px 0;
    }

    .refresh-btn {
      background: #00ff9f;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .refresh-btn:hover {
      background: #00cc7f;
    }

    .time-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .time-filter button {
      padding: 8px 16px;
      background: rgba(0, 255, 159, 0.1);
      border: 1px solid #00ff9f;
      color: #00ff9f;
      border-radius: 4px;
      cursor: pointer;
    }

    .time-filter button.active {
      background: #00ff9f;
      color: #000;
    }

    .mini-chart {
      height: 50px;
      margin-top: 10px;
    }

    .trend-up {
      color: #00ff9f;
    }

    .trend-down {
      color: #ff6b6b;
    }
  </style>
</head>
<body>
  <%- include('../partials/header', { user: user }) %>

  <div class="admin-dashboard">
    <div class="dashboard-header">
      <h1>Admin Dashboard</h1>
      <p>Platform analytics and user insights</p>
    </div>

    <div class="dashboard-nav">
      <a href="/admin">Dashboard</a>
      <a href="/admin/users">Users</a>
      <a href="/admin/assets">Asset Approvals</a>
      <a href="/admin/generate">Generate Assets</a>
      <a href="/admin/game-state">Game State</a>
      <a href="/admin/galactic-map-settings">Galactic Map</a>
      <a href="/admin/monitor/orbital-systems">Orbital Monitor</a>
    </div>

    <div class="time-filter">
      <button class="active" data-days="7">Last 7 Days</button>
      <button data-days="30">Last 30 Days</button>
      <button data-days="90">Last 90 Days</button>
    </div>

    <button class="refresh-btn" onclick="loadAnalytics()">Refresh Data</button>

    <div id="loading" class="loading">
      Loading analytics...
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div id="analytics-content" style="display: none;">
      <!-- Overview Stats -->
      <div class="stats-grid" id="overviewStats">
        <!-- Stats will be loaded here -->
      </div>

      <!-- Charts Row -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        <!-- Actions by Type -->
        <div class="chart-section">
          <h2>Actions by Type</h2>
          <ul class="action-list" id="actionsList">
            <!-- Actions will be loaded here -->
          </ul>
        </div>

        <!-- Top Active Users -->
        <div class="chart-section">
          <h2>Top Active Users</h2>
          <ul class="user-list" id="topUsersList">
            <!-- Top users will be loaded here -->
          </ul>
        </div>
      </div>

      <!-- Daily Activity Chart -->
      <div class="chart-section">
        <h2>Daily Active Users</h2>
        <div class="chart-container">
          <canvas id="dailyActivityChart"></canvas>
        </div>
      </div>

      <!-- Asset Statistics -->
      <div class="chart-section">
        <h2>Asset Statistics</h2>
        <div class="stats-grid" id="assetStats">
          <!-- Asset stats will be loaded here -->
        </div>
      </div>

      <!-- Achievement Distribution -->
      <div class="chart-section">
        <h2>Achievement Distribution</h2>
        <ul class="achievement-list" id="achievementsList">
          <!-- Achievements will be loaded here -->
        </ul>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let currentDays = 7;
    let dailyChart = null;

    // Time filter buttons
    document.querySelectorAll('.time-filter button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.time-filter button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentDays = parseInt(btn.dataset.days);
        loadAnalytics();
      });
    });

    async function loadAnalytics() {
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const content = document.getElementById('analytics-content');

      loading.style.display = 'block';
      error.style.display = 'none';
      content.style.display = 'none';

      try {
        const response = await fetch(`/admin/api/analytics?days=${currentDays}`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load analytics');
        }

        renderAnalytics(data.analytics);

        loading.style.display = 'none';
        content.style.display = 'block';
      } catch (err) {
        console.error('Error loading analytics:', err);
        error.textContent = 'Error loading analytics: ' + err.message;
        error.style.display = 'block';
        loading.style.display = 'none';
      }
    }

    function renderAnalytics(analytics) {
      // Render overview stats
      const overviewStats = document.getElementById('overviewStats');
      overviewStats.innerHTML = `
        <div class="stat-card">
          <h3>Total Users</h3>
          <p class="stat-value">${analytics.overview.totalUsers.toLocaleString()}</p>
        </div>
        <div class="stat-card">
          <h3>Active Users</h3>
          <p class="stat-value">${analytics.overview.activeUsers.toLocaleString()}</p>
          <p class="stat-label">Last ${currentDays} days</p>
        </div>
        <div class="stat-card">
          <h3>New Users</h3>
          <p class="stat-value">${analytics.overview.newUsers.toLocaleString()}</p>
          <p class="stat-label">Last ${currentDays} days</p>
        </div>
        <div class="stat-card">
          <h3>Total Actions</h3>
          <p class="stat-value">${analytics.overview.totalActions.toLocaleString()}</p>
          <p class="stat-label">Last ${currentDays} days</p>
        </div>
        <div class="stat-card">
          <h3>Avg Actions/User</h3>
          <p class="stat-value">${analytics.overview.averageActionsPerUser}</p>
          <p class="stat-label">Last ${currentDays} days</p>
        </div>
      `;

      // Render actions by type
      const actionsList = document.getElementById('actionsList');
      actionsList.innerHTML = analytics.actionsByType.map(action => `
        <li class="action-item">
          <span class="action-type">${formatActionType(action._id)}</span>
          <span class="action-count">${action.count.toLocaleString()}</span>
        </li>
      `).join('');

      // Render top users
      const topUsersList = document.getElementById('topUsersList');
      topUsersList.innerHTML = analytics.topUsers.map((user, index) => `
        <li class="user-item">
          <span class="user-name">#${index + 1} ${user.username}</span>
          <span class="user-actions">${user.actionCount.toLocaleString()} actions</span>
        </li>
      `).join('');

      // Render daily activity chart
      renderDailyActivityChart(analytics.dailyActiveUsers);

      // Render asset stats
      const assetStats = document.getElementById('assetStats');
      const assetStatsObj = analytics.assetStats.reduce((acc, stat) => {
        acc[stat._id] = stat.count;
        return acc;
      }, {});

      assetStats.innerHTML = `
        <div class="stat-card">
          <h3>Draft Assets</h3>
          <p class="stat-value">${(assetStatsObj.draft || 0).toLocaleString()}</p>
        </div>
        <div class="stat-card">
          <h3>Pending Approval</h3>
          <p class="stat-value">${(assetStatsObj.pending || 0).toLocaleString()}</p>
        </div>
        <div class="stat-card">
          <h3>Approved Assets</h3>
          <p class="stat-value">${(assetStatsObj.approved || 0).toLocaleString()}</p>
        </div>
        <div class="stat-card">
          <h3>Rejected Assets</h3>
          <p class="stat-value">${(assetStatsObj.rejected || 0).toLocaleString()}</p>
        </div>
      `;

      // Render achievement distribution
      const achievementsList = document.getElementById('achievementsList');
      achievementsList.innerHTML = analytics.achievementDistribution.map(achievement => `
        <li class="achievement-item">
          <span class="achievement-name">${achievement.name || achievement._id}</span>
          <span class="achievement-count">${achievement.count} users</span>
        </li>
      `).join('');
    }

    function renderDailyActivityChart(dailyData) {
      const ctx = document.getElementById('dailyActivityChart').getContext('2d');

      if (dailyChart) {
        dailyChart.destroy();
      }

      const labels = dailyData.map(d => d.date);
      const data = dailyData.map(d => d.count);

      dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Daily Active Users',
            data: data,
            borderColor: '#00ff9f',
            backgroundColor: 'rgba(0, 255, 159, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: {
                color: '#fff'
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#fff'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            },
            x: {
              ticks: {
                color: '#fff'
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              }
            }
          }
        }
      });
    }

    function formatActionType(type) {
      return type.split('_').map(word =>
        word.charAt(0).toUpperCase() + word.slice(1)
      ).join(' ');
    }

    // Load analytics on page load
    loadAnalytics();
  </script>
</body>
</html>
