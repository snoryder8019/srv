<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Character</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="/stylesheets/character-detail.css">
  <link rel="stylesheet" href="/stylesheets/inventory-modal.css">
</head>
<body>
  <%- include('../partials/header', { user: user }) %>

  <%
  // Helper function to get item icon based on type/category
  function getItemIcon(item) {
    if (!item) return 'ðŸ“¦';

    const iconMap = {
      // Weapons
      'energy_weapon': 'âš¡',
      'ballistic_weapon': 'ðŸ”«',
      'melee_weapon': 'âš”ï¸',

      // Armor/Equipment
      'helmet': 'â›‘ï¸',
      'armor': 'ðŸ›¡ï¸',
      'boots': 'ðŸ‘¢',
      'gloves': 'ðŸ§¤',
      'pants': 'ðŸ‘–',

      // Consumables
      'consumable': 'ðŸ’Š',
      'health': 'â¤ï¸',
      'energy': 'âš¡',

      // Modules
      'shield': 'ðŸ›¡ï¸',
      'engine': 'ðŸš€',
      'weapon_module': 'âš”ï¸',

      // Resources
      'ore': 'â›ï¸',
      'scrap': 'ðŸ”©',
      'component': 'âš™ï¸',

      // Trade goods
      'trade_good': 'ðŸ“¦',
      'luxury': 'ðŸ’Ž',
      'common_goods': 'ðŸ“¦'
    };

    return iconMap[item.category] || iconMap[item.itemType] || 'ðŸ“¦';
  }

  // Helper function to get rarity class
  function getRarityClass(rarity) {
    const rarityMap = {
      'common': 'rarity-common',
      'uncommon': 'rarity-uncommon',
      'rare': 'rarity-rare',
      'legendary': 'rarity-legendary',
      'exotic': 'rarity-exotic'
    };
    return rarityMap[rarity] || 'rarity-common';
  }
  %>

  <main class="character-container">
    <div class="character-header">
      <h1><%= character.name %></h1>
      <div class="character-level">
        <span class="level-badge">Level <%= character.level %></span>
        <span class="class-badge"><%= character.primaryClass %></span>
      </div>
    </div>

    <div class="character-layout">
      <!-- Left Column: Character Info + Equipment -->
      <div class="left-column">
        <!-- Character Info Card -->
        <div class="card character-info-card">
          <h2>Character Information</h2>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Species:</span>
              <span class="info-value"><%= character.species %></span>
            </div>
            <div class="info-item">
              <span class="info-label">String Domain:</span>
              <span class="info-value"><%= character.stringDomain %></span>
            </div>
            <div class="info-item">
              <span class="info-label">Home Star:</span>
              <span class="info-value"><%= character.homeStar %></span>
            </div>
            <div class="info-item">
              <span class="info-label">Home Planet:</span>
              <span class="info-value"><%= character.homePlanet %></span>
            </div>
          </div>
        </div>

        <!-- Stats Card -->
        <div class="card stats-card">
          <h2>Base Stats</h2>
          <div class="stats-list">
            <div class="stat-item">
              <span class="stat-label">Strength:</span>
              <div class="stat-bar">
                <div class="stat-fill" style="width: <%= Math.min(character.stats.strength * 2, 100) %>%"></div>
                <span class="stat-value"><%= character.stats.strength %></span>
              </div>
            </div>
            <div class="stat-item">
              <span class="stat-label">Intelligence:</span>
              <div class="stat-bar">
                <div class="stat-fill" style="width: <%= Math.min(character.stats.intelligence * 2, 100) %>%"></div>
                <span class="stat-value"><%= character.stats.intelligence %></span>
              </div>
            </div>
            <div class="stat-item">
              <span class="stat-label">Agility:</span>
              <div class="stat-bar">
                <div class="stat-fill" style="width: <%= Math.min(character.stats.agility * 2, 100) %>%"></div>
                <span class="stat-value"><%= character.stats.agility %></span>
              </div>
            </div>
            <div class="stat-item">
              <span class="stat-label">Faith:</span>
              <div class="stat-bar">
                <div class="stat-fill" style="width: <%= Math.min(character.stats.faith * 2, 100) %>%"></div>
                <span class="stat-value"><%= character.stats.faith %></span>
              </div>
            </div>
            <div class="stat-item">
              <span class="stat-label">Tech:</span>
              <div class="stat-bar">
                <div class="stat-fill" style="width: <%= Math.min(character.stats.tech * 2, 100) %>%"></div>
                <span class="stat-value"><%= character.stats.tech %></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Talent Tree -->
      <div class="right-column">
        <div class="card talent-tree-card">
          <div class="talent-tree-header">
            <h2>Cosmic Talent Tree</h2>
            <div class="talent-points">
              <span class="points-available" id="talentPoints"><%= character.talents?.availablePoints || 0 %></span>
              <span class="points-label">Points Available</span>
            </div>
          </div>

          <div class="talent-tree-canvas-container">
            <canvas id="talentTreeCanvas"></canvas>
          </div>

          <div class="talent-actions">
            <button class="btn btn-secondary" id="resetTalents">Reset Talents</button>
          </div>
        </div>
      </div>
    </div>

    <div class="character-actions">
      <button class="btn btn-primary" onclick="window.inventoryModal.open(window.CHARACTER_ID)">
        Open Inventory
      </button>
      <a href="/characters" class="btn btn-secondary">Back to Characters</a>
    </div>
  </main>

  <%- include('../partials/footer') %>

  <!-- Pass character data to JavaScript -->
  <script>
    window.CHARACTER_ID = "<%= character._id %>";
    window.CHARACTER_DATA = <%- JSON.stringify(character) %>;

    // Auto-open inventory modal if query param is present
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const openInventory = urlParams.get('openInventory');

      if (openInventory && window.inventoryModal) {
        // Wait a bit for the modal to initialize
        setTimeout(() => {
          window.inventoryModal.open(window.CHARACTER_ID);

          // Switch to the requested tab
          if (openInventory === 'ship') {
            window.inventoryModal.switchTab('ship');
          } else if (openInventory === 'storehouse') {
            window.inventoryModal.switchTab('storehouse');
          }
        }, 100);
      }
    });
  </script>
  <script src="/javascripts/inventory-modal.js"></script>
  <script src="/javascripts/talent-tree-canvas.js"></script>
  <script src="/javascripts/character-detail.js"></script>
</body>
</html>
