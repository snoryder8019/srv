<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - 3D View</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="/stylesheets/galactic-map.css">
  <link rel="stylesheet" href="/stylesheets/activity-monitor.css">
  <link rel="stylesheet" href="/stylesheets/global-chat.css">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Courier New', monospace;
      background: #000;
    }

    /* Show header on this page */
    header {
      display: block !important;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    nav.navbar {
      display: flex !important;
    }

    /* Info Pane Styles REMOVED - Direct navigation instead */

    #mapContainer {
      width: 100vw;
      height: calc(100vh - 60px);
      margin-top: 60px;
      position: relative;
    }

    /* Info Overlay */
    .info-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 20, 40, 0.9);
      border: 2px solid #00ffaa;
      border-radius: 8px;
      padding: 15px 20px;
      color: #00ffaa;
      font-size: 14px;
      z-index: 100;
      min-width: 250px;
      backdrop-filter: blur(10px);
    }

    .info-overlay h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: #ffaa00;
      text-shadow: 0 0 10px #ffaa00;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      padding: 3px 0;
      border-bottom: 1px solid rgba(0, 255, 170, 0.2);
    }

    .info-label {
      color: #66ccff;
    }

    .info-value {
      color: #ffffff;
      font-weight: bold;
    }

    /* Control Instructions */
    .controls-overlay {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 20, 40, 0.9);
      border: 2px solid #4488ff;
      border-radius: 8px;
      padding: 15px 20px;
      color: #4488ff;
      font-size: 12px;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .controls-overlay h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #ffaa00;
    }

    .controls-overlay p {
      margin: 5px 0;
      color: #aaccff;
    }

    .controls-overlay kbd {
      background: rgba(100, 150, 255, 0.3);
      padding: 2px 6px;
      border-radius: 3px;
      border: 1px solid #4488ff;
      color: #ffffff;
    }

    /* Selected Asset Panel */
    .selected-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 20, 40, 0.95);
      border: 2px solid #ff6600;
      border-radius: 8px;
      padding: 15px 20px;
      color: #ffffff;
      font-size: 13px;
      z-index: 100;
      min-width: 300px;
      max-width: 400px;
      display: none;
      backdrop-filter: blur(10px);
    }

    .selected-panel.visible {
      display: block;
    }

    .selected-panel h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #ff6600;
      text-shadow: 0 0 10px #ff6600;
    }

    .selected-panel .asset-type {
      display: inline-block;
      background: rgba(255, 102, 0, 0.3);
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 11px;
      text-transform: uppercase;
      margin-bottom: 10px;
      border: 1px solid #ff6600;
    }

    /* Toggle Button */
    .view-toggle {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(138, 79, 255, 0.9);
      border: 2px solid #8a4fff;
      border-radius: 20px;
      padding: 10px 20px;
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s;
      text-decoration: none;
      backdrop-filter: blur(10px);
    }

    .view-toggle:hover {
      background: rgba(138, 79, 255, 1);
      box-shadow: 0 0 20px rgba(138, 79, 255, 0.8);
      transform: translateX(-50%) scale(1.05);
    }

    .back-button {
      background: rgba(255, 100, 100, 0.8);
      border: 2px solid #ff6644;
      color: #fff;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      font-size: 13px;
    }

    .back-button:hover {
      background: rgba(255, 100, 100, 1);
      box-shadow: 0 0 15px rgba(255, 100, 100, 0.6);
      transform: scale(1.05);
    }

    .back-button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Legend */
    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 20, 40, 0.9);
      border: 2px solid #00ffaa;
      border-radius: 8px;
      padding: 15px;
      color: #ffffff;
      font-size: 12px;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .legend h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #ffaa00;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Overlay Menu Active States */
    .overlay-menu.active {
      right: 0 !important;
    }

    .overlay-backdrop.active {
      opacity: 1 !important;
      pointer-events: auto !important;
    }

    /* Overlay menu hover effects */
    .overlay-menu-item:hover {
      background: rgba(138, 79, 255, 0.15) !important;
      border-left: 3px solid #8a4fff !important;
      padding-left: 17px !important;
    }

    .overlay-menu-item.admin-item:hover {
      background: rgba(255, 100, 100, 0.15) !important;
      border-left: 3px solid #ff6464 !important;
    }
  </style>
</head>
<body>
  <%- include('../partials/header', { user: user }) %>
  <%- include('../partials/breadcrumb-nav', { currentView: 'galactic' }) %>

  <!-- Main Map Container -->
  <div id="mapContainer"></div>

  <!-- Floating HUD Info (appears next to hovered stars) -->
  <div id="floatingHUD" style="
    position: fixed;
    display: none;
    z-index: 9999;
    pointer-events: none;
    font-family: 'Courier New', monospace;
    font-size: 10px;
    min-width: 180px;
    max-width: 240px;
  ">
    <div style="
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid #00ff00;
      border-radius: 3px;
      padding: 10px;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.3),
                  inset 0 0 15px rgba(0, 255, 0, 0.05);
    ">
      <div style="color: #00ff00; font-weight: bold; margin-bottom: 6px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;" id="hudTitle">
        [STAR]
      </div>
      <div style="color: #00ff00; opacity: 0.7; margin-bottom: 3px; font-size: 9px;" id="hudType">
        TYPE: UNKNOWN
      </div>
      <div style="color: #00ff00; opacity: 0.7; margin-bottom: 3px; font-size: 9px;" id="hudCoords">
        COORDS: [0, 0, 0]
      </div>
      <div style="color: #00ff00; opacity: 0.85; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(0, 255, 0, 0.25); font-size: 9px;">
        <div style="margin-bottom: 2px;" id="hudPlanets">
          PLANETS: 0
        </div>
        <div style="margin-bottom: 2px;" id="hudStations">
          STATIONS: 0
        </div>
        <div style="margin-bottom: 2px;" id="hudShips">
          SHIPS: 0
        </div>
        <div id="hudTotal">
          TOTAL: 0
        </div>
      </div>
    </div>
  </div>

  <!-- HUD Connection Line Canvas -->
  <canvas id="hudLineCanvas" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9998;
    display: none;
  "></canvas>

  <!-- Inline Script: Define sidebar functions IMMEDIATELY BEFORE HTML -->
  <script>
    // CRITICAL: Define these functions BEFORE any onclick handlers try to use them

    // Section toggle function
    window.toggleSidebarSection = function(sectionName) {
      const content = document.getElementById(sectionName + 'Content');
      const arrow = document.getElementById(sectionName + 'Arrow');

      if (!content || !arrow) {
        console.warn('‚ö†Ô∏è Section elements not found:', sectionName);
        return;
      }

      const isHidden = content.style.display === 'none';

      if (isHidden) {
        // Show section - use flex for certain sections, block for others
        if (sectionName === 'mapControls' || sectionName === 'layerControls' || sectionName === 'debugAdmin') {
          content.style.display = 'flex';
        } else {
          content.style.display = 'block';
        }
        arrow.textContent = '‚ñº';
        arrow.style.transform = 'rotate(0deg)';
      } else {
        // Hide section
        content.style.display = 'none';
        arrow.textContent = '‚ñ∂';
        arrow.style.transform = 'rotate(-90deg)';
      }

      console.log(`‚úÖ Toggled ${sectionName}: ${isHidden ? 'shown' : 'hidden'}`);
    };

    // Quick access toolbar handlers
    let sidebarVisible = false; // Start minimized by default
    let zenModeActive = false;

    /**
     * Toggle Overlay Menu - Define early so handleMenuToggle can call it
     */
    window.toggleOverlayMenu = function() {
      const menu = document.getElementById('overlayMenu');
      const backdrop = document.getElementById('overlayBackdrop');
      const btn = document.getElementById('toggleMenuBtn');

      const isActive = menu.classList.contains('active');

      if (isActive) {
        menu.classList.remove('active');
        backdrop.classList.remove('active');
        if (btn) btn.classList.remove('active');
      } else {
        menu.classList.add('active');
        backdrop.classList.add('active');
        if (btn) btn.classList.add('active');
      }
    };

    window.handleSidebarToggle = function() {
      console.log('‚¨ÖÔ∏è Sidebar toggle clicked');
      const sidebar = document.getElementById('unifiedSidebar');
      const showBtn = document.getElementById('showSidebarBtn');
      const toggleBtn = document.getElementById('toggleSidebarBtn');

      sidebarVisible = !sidebarVisible;

      if (sidebarVisible) {
        sidebar.style.transform = 'translateX(0)';
        showBtn.style.left = '-60px';
        showBtn.style.display = 'none';
        toggleBtn.textContent = '¬´';
        toggleBtn.title = 'Collapse Sidebar';
      } else {
        sidebar.style.transform = 'translateX(-320px)';
        showBtn.style.left = '0';
        showBtn.style.display = 'flex';
        toggleBtn.textContent = '¬ª';
        toggleBtn.title = 'Expand Sidebar';
      }
    };

    window.handleMenuToggle = function() {
      console.log('‚ò∞ Menu button clicked');
      // toggleOverlayMenu is defined later in this page - call it when user clicks
      window.toggleOverlayMenu();
    };

    window.handleZenToggle = function() {
      console.log('üëÅÔ∏è Zen mode clicked');
      zenModeActive = !zenModeActive;
      const zenBtn = document.getElementById('zenModeBtn');
      const hideables = document.querySelectorAll('.zen-hideable');

      if (zenModeActive) {
        hideables.forEach(el => {
          el.style.opacity = '0';
          el.style.pointerEvents = 'none';
        });
        zenBtn.style.background = 'rgba(255, 100, 100, 0.9)';
        zenBtn.style.borderColor = '#ff6464';
        zenBtn.textContent = 'üö´';
        zenBtn.title = 'Exit Zen Mode';
      } else {
        hideables.forEach(el => {
          el.style.opacity = '1';
          el.style.pointerEvents = 'auto';
        });
        zenBtn.style.background = 'rgba(100, 200, 255, 0.9)';
        zenBtn.style.borderColor = '#64c8ff';
        zenBtn.textContent = 'üëÅÔ∏è';
        zenBtn.title = 'Zen Mode';
      }
    };

    window.handleLocatePlayer = function() {
      console.log('üìç Locate player clicked');
      // This will be connected to the existing locateMeBtn handler later
      const btn = document.getElementById('locateMeBtn');
      if (btn) {
        btn.click();
      }
    };

    window.handleResetView = function() {
      console.log('‚ü≤ Reset view clicked');
      if (window.galacticMap) {
        // If we're in galaxy or system view, go back to galactic level
        if (window.galacticMap.currentLevel === 'galaxy' || window.galacticMap.currentLevel === 'system') {
          window.galacticMap.showGalacticLevel();
        } else {
          // Otherwise just reset camera position
          window.galacticMap.camera.zoom = 1;
          const center = window.galacticMap.universeCenter;
          window.galacticMap.camera.position.set(
            center.x,
            center.y + 3000,
            center.z + 2000
          );
          if (window.galacticMap.controls) {
            window.galacticMap.controls.target.copy(center);
          }
          window.galacticMap.camera.updateProjectionMatrix();
          if (window.galacticMap.controls) {
            window.galacticMap.controls.update();
          }
        }
      }
    };

    window.handleChatToggle = function() {
      console.log('üí¨ Chat toggle clicked');
      if (window.globalChat) {
        window.globalChat.toggleChat();
        console.log('‚úÖ Chat toggled');
      } else {
        console.warn('‚ö†Ô∏è Chat not initialized yet. Socket may not be connected.');
        // Show user-friendly message
        const notice = document.createElement('div');
        notice.style.cssText = `
          position: fixed;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 170, 0, 0.95);
          border: 2px solid #ffaa00;
          border-radius: 8px;
          padding: 15px 25px;
          color: #000;
          font-family: 'Courier New', monospace;
          font-size: 14px;
          z-index: 10000;
          box-shadow: 0 4px 20px rgba(255, 170, 0, 0.4);
        `;
        notice.textContent = '‚ö†Ô∏è Chat loading... Please wait for connection.';
        document.body.appendChild(notice);
        setTimeout(() => {
          if (notice.parentNode) {
            notice.style.opacity = '0';
            notice.style.transition = 'opacity 0.3s';
            setTimeout(() => document.body.removeChild(notice), 300);
          }
        }, 3000);
      }
    };

    window.handleZoomIn = function() {
      console.log('üîç Zoom in clicked');
      if (window.galacticMap) {
        window.galacticMap.camera.zoom *= 1.2;
        window.galacticMap.camera.updateProjectionMatrix();
        console.log('Zoom level:', window.galacticMap.camera.zoom);
      }
    };

    window.handleZoomOut = function() {
      console.log('üîç Zoom out clicked');
      if (window.galacticMap) {
        window.galacticMap.camera.zoom /= 1.2;
        window.galacticMap.camera.updateProjectionMatrix();
        console.log('Zoom level:', window.galacticMap.camera.zoom);
      }
    };

    // Galaxy Shape Control Handlers
    window.handleGalaxyShapePreset = function(shapeType) {
      console.log('üåÄ Galaxy shape preset clicked:', shapeType);
      if (!window.galacticMap) return;

      // Get current parameters from sliders
      const dimension = parseFloat(document.getElementById('dimensionSlider').value);
      const trim = parseFloat(document.getElementById('trimSlider').value);
      const curvature = parseFloat(document.getElementById('curvatureSlider').value);

      // Update all galaxies in scene
      window.galacticMap.assets.forEach((asset, id) => {
        if (asset.mesh && asset.mesh.userData.type === 'galaxy') {
          window.galacticMap.updateGalaxyShape(id, shapeType, { dimension, trim, curvature });
        }
      });

      console.log(`‚úÖ Updated all galaxies to ${shapeType}`);
    };

    window.handleGalaxyDimensionChange = function(value) {
      const dimension = parseFloat(value);
      document.getElementById('dimensionValue').textContent = dimension.toFixed(1);

      if (!window.galacticMap) return;

      // Get current shape and other params
      window.galacticMap.assets.forEach((asset, id) => {
        if (asset.mesh && asset.mesh.userData.type === 'galaxy') {
          const shape = asset.mesh.userData.galaxyShape || 'spiral-6';
          const trim = parseFloat(document.getElementById('trimSlider').value);
          const curvature = parseFloat(document.getElementById('curvatureSlider').value);
          window.galacticMap.updateGalaxyShape(id, shape, { dimension, trim, curvature });
        }
      });
    };

    window.handleGalaxyTrimChange = function(value) {
      const trim = parseFloat(value);
      document.getElementById('trimValue').textContent = trim.toFixed(2);

      if (!window.galacticMap) return;

      window.galacticMap.assets.forEach((asset, id) => {
        if (asset.mesh && asset.mesh.userData.type === 'galaxy') {
          const shape = asset.mesh.userData.galaxyShape || 'spiral-6';
          const dimension = parseFloat(document.getElementById('dimensionSlider').value);
          const curvature = parseFloat(document.getElementById('curvatureSlider').value);
          window.galacticMap.updateGalaxyShape(id, shape, { dimension, trim, curvature });
        }
      });
    };

    window.handleGalaxyCurvatureChange = function(value) {
      const curvature = parseFloat(value);
      document.getElementById('curvatureValue').textContent = curvature.toFixed(1);

      if (!window.galacticMap) return;

      window.galacticMap.assets.forEach((asset, id) => {
        if (asset.mesh && asset.mesh.userData.type === 'galaxy') {
          const shape = asset.mesh.userData.galaxyShape || 'spiral-6';
          const dimension = parseFloat(document.getElementById('dimensionSlider').value);
          const trim = parseFloat(document.getElementById('trimSlider').value);
          window.galacticMap.updateGalaxyShape(id, shape, { dimension, trim, curvature });
        }
      });
    };

    // Populate asset selector with ONLY anomalies and galaxies (galactic map level)
    window.populateAssetSelector = function() {
      console.log('üìã Populating asset selector (galactic map - anomalies & galaxies only)...');
      const selector = document.getElementById('assetSelector');

      if (!selector || !window.galacticMap || !window.galacticMap.allAssets) {
        console.warn('‚ö†Ô∏è Asset selector or galactic map not ready');
        return;
      }

      // Clear existing options except the first one
      selector.innerHTML = '<option value="">üåå Select Galactic Object</option>';

      // Only show galactic-level objects: anomalies and galaxies
      const anomalies = [];
      const galaxies = [];

      window.galacticMap.allAssets.forEach(asset => {
        const item = {
          id: asset._id,
          title: asset.title,
          type: asset.assetType,
          coordinates: asset.coordinates || asset.localCoordinates
        };

        if (asset.assetType === 'anomaly') {
          anomalies.push(item);
        } else if (asset.assetType === 'galaxy') {
          galaxies.push(item);
        }
      });

      // Add anomalies first
      if (anomalies.length > 0) {
        const group = document.createElement('optgroup');
        group.label = 'üåÄ Anomalies';
        anomalies.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = `üåÄ ${item.title}`;
          option.dataset.type = item.type;
          group.appendChild(option);
        });
        selector.appendChild(group);
      }

      // Add galaxies
      if (galaxies.length > 0) {
        const group = document.createElement('optgroup');
        group.label = 'üåå Galaxies';
        galaxies.forEach(item => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = `üåå ${item.title}`;
          option.dataset.type = item.type;
          group.appendChild(option);
        });
        selector.appendChild(group);
      }

      console.log(`‚úÖ Asset selector populated: ${anomalies.length} anomalies, ${galaxies.length} galaxies`);
    };

    /**
     * Update simulation speed via API
     */
    window.updateSimulationSpeed = async function(speed) {
      const speedFloat = parseFloat(speed);
      document.getElementById('simSpeedDisplay').textContent = speedFloat.toFixed(1) + 'x';

      try {
        const response = await fetch('/api/v1/state/simulation-speed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ speed: speedFloat })
        });

        const data = await response.json();
        if (data.success) {
          console.log(`‚ö° Simulation speed set to ${data.simulationSpeed.toFixed(1)}x`);
        } else {
          console.error('Failed to set simulation speed:', data.error);
        }
      } catch (error) {
        console.error('Error setting simulation speed:', error);
      }
    };

    /**
     * Fetch and display current simulation speed
     */
    window.loadSimulationSpeed = async function() {
      try {
        const response = await fetch('/api/v1/state/simulation-speed');
        const data = await response.json();

        if (data.success) {
          const slider = document.getElementById('simSpeedSlider');
          const display = document.getElementById('simSpeedDisplay');

          if (slider && display) {
            slider.value = data.simulationSpeed;
            display.textContent = data.simulationSpeed.toFixed(1) + 'x';
          }

          console.log(`‚ö° Current simulation speed: ${data.simulationSpeed.toFixed(1)}x`);
        }
      } catch (error) {
        console.error('Error loading simulation speed:', error);
      }
    };

    console.log('‚úÖ All sidebar functions defined globally');
  </script>

  <!-- Unified Left Sidebar (minimized by default) -->
  <div id="unifiedSidebar" class="zen-hideable" style="position: fixed; left: 0; top: 60px; height: calc(100vh - 60px); width: 320px; background: rgba(10, 10, 26, 0.95); backdrop-filter: blur(20px); border-right: 2px solid rgba(138, 79, 255, 0.3); z-index: 1000; display: flex; flex-direction: column; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform: translateX(-320px);">

    <!-- Quick Access Toolbar (Always Visible) -->
    <div class="quick-access-toolbar" style="padding: 15px; display: flex; gap: 10px; border-bottom: 2px solid rgba(138, 79, 255, 0.3); flex-wrap: wrap; justify-content: center;">
      <button id="toggleSidebarBtn" class="quick-btn" onclick="handleSidebarToggle()" style="background: rgba(138, 79, 255, 0.9); border: 2px solid #8a4fff; border-radius: 8px; padding: 10px; color: #ffffff; font-size: 18px; cursor: pointer; transition: all 0.3s; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; pointer-events: auto;" title="Expand Sidebar">¬ª</button>
      <button id="toggleMenuBtn" class="quick-btn" onclick="handleMenuToggle()" style="background: rgba(138, 79, 255, 0.9); border: 2px solid #8a4fff; border-radius: 8px; padding: 10px; color: #ffffff; font-size: 18px; cursor: pointer; transition: all 0.3s; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; pointer-events: auto;" title="Navigation Menu">‚ò∞</button>
      <button id="toggleChatBtn" class="quick-btn" onclick="handleChatToggle()" style="background: rgba(0, 255, 159, 0.9); border: 2px solid #00ff9f; border-radius: 8px; padding: 10px; color: #000; font-size: 18px; cursor: pointer; transition: all 0.3s; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; pointer-events: auto;" title="Global Chat">üí¨</button>
      <button id="zenModeBtn" class="quick-btn" onclick="handleZenToggle()" style="background: rgba(100, 200, 255, 0.9); border: 2px solid #64c8ff; border-radius: 8px; padding: 10px; color: #000; font-size: 18px; cursor: pointer; transition: all 0.3s; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; pointer-events: auto;" title="Zen Mode">üëÅÔ∏è</button>
      <button id="locateMeBtn" class="quick-btn" onclick="handleLocatePlayer()" style="background: rgba(0, 255, 0, 0.9); border: 2px solid #00ff00; border-radius: 8px; padding: 10px; color: #000; font-size: 18px; cursor: pointer; transition: all 0.3s; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; pointer-events: auto;" title="Locate My Character">üìç</button>
      <button id="resetViewBtn" class="quick-btn" onclick="handleResetView()" style="background: rgba(255, 170, 0, 0.9); border: 2px solid #ffaa00; border-radius: 8px; padding: 10px; color: #000; font-size: 18px; cursor: pointer; transition: all 0.3s; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; pointer-events: auto;" title="Reset View">‚ü≤</button>
    </div>

    <!-- Scrollable Content Area -->
    <div class="sidebar-content" style="flex: 1; overflow-y: auto; overflow-x: hidden; padding: 10px;">

      <!-- Navigation Breadcrumb Section -->
      <div class="sidebar-section" style="margin-bottom: 15px;">
        <div class="section-header" onclick="toggleSidebarSection('navigation')" style="background: rgba(0, 255, 0, 0.2); border: 2px solid #00ff00; border-radius: 8px; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
          <span style="color: #00ff00; font-family: 'Orbitron', monospace; font-weight: bold; font-size: 14px;">üß≠ NAVIGATION</span>
          <span id="navigationArrow" style="color: #00ff00; font-size: 14px; transition: transform 0.3s;">‚ñº</span>
        </div>
        <div id="navigationContent" class="section-content" style="padding: 12px; background: rgba(0, 0, 0, 0.3); border: 2px solid #00ff00; border-top: none; border-radius: 0 0 8px 8px; display: flex; flex-direction: column; gap: 8px;">
          <!-- Breadcrumb Navigation -->
          <div id="breadcrumbNav" style="
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            flex-wrap: wrap;
            padding: 8px;
            background: rgba(0, 255, 0, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 0, 0.2);
          ">
            <span style="color: #666; font-size: 10px;">[LOCATION]</span>
            <span id="breadcrumbUniverse" class="breadcrumb-item active" style="color: #00ff00; cursor: pointer; padding: 3px 8px; border-radius: 6px; transition: all 0.2s; background: rgba(0, 255, 0, 0.1);">
              UNIVERSE
            </span>
          </div>
          <!-- Quick Navigation Buttons -->
          <button onclick="if(window.galacticMap) window.galacticMap.showUniverseLevel();" style="background: rgba(0, 255, 0, 0.7); border: 2px solid #00ff00; border-radius: 6px; padding: 8px; color: #000; font-size: 12px; cursor: pointer; transition: all 0.3s; font-family: 'Courier New', monospace; font-weight: bold;" title="Return to Universe View">üåå Universe View</button>
        </div>
      </div>

      <!-- Map Controls Section -->
      <div class="sidebar-section" style="margin-bottom: 15px;">
        <div class="section-header" onclick="toggleSidebarSection('mapControls')" style="background: rgba(0, 170, 255, 0.2); border: 2px solid #00aaff; border-radius: 8px; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
          <span style="color: #00aaff; font-family: 'Orbitron', monospace; font-weight: bold; font-size: 14px;">üó∫Ô∏è MAP CONTROLS</span>
          <span id="mapControlsArrow" style="color: #00aaff; font-size: 14px; transition: transform 0.3s;">‚ñº</span>
        </div>
        <div id="mapControlsContent" class="section-content" style="padding: 12px; background: rgba(0, 0, 0, 0.3); border: 2px solid #00aaff; border-top: none; border-radius: 0 0 8px 8px; display: flex; flex-direction: column; gap: 10px;">
          <!-- Zoom Controls -->
          <div style="display: flex; gap: 8px; justify-content: space-between;">
            <button id="zoomInBtnSidebar" class="control-btn" onclick="handleZoomIn()" style="flex: 1; background: rgba(0, 255, 170, 0.9); border: 2px solid #00ffaa; border-radius: 6px; padding: 10px; color: #000; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s;" title="Zoom In">+</button>
            <button id="zoomOutBtnSidebar" class="control-btn" onclick="handleZoomOut()" style="flex: 1; background: rgba(0, 255, 170, 0.9); border: 2px solid #00ffaa; border-radius: 6px; padding: 10px; color: #000; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s;" title="Zoom Out">‚àí</button>
          </div>
          <!-- Asset Selector -->
          <select id="assetSelector" class="control-select" style="background: rgba(0, 255, 170, 0.9); border: 2px solid #00ffaa; border-radius: 6px; padding: 10px; color: #000; font-size: 12px; cursor: pointer; transition: all 0.3s; width: 100%; font-family: 'Courier New', monospace;" title="View Asset">
            <option value="">üåå Select Asset to View</option>
          </select>
        </div>
      </div>

      <!-- Selected Asset Section -->
      <div class="sidebar-section" style="margin-bottom: 15px;">
        <div class="section-header" onclick="toggleSidebarSection('selectedAsset')" style="background: rgba(255, 102, 0, 0.2); border: 2px solid #ff6600; border-radius: 8px; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
          <span style="color: #ff6600; font-family: 'Orbitron', monospace; font-weight: bold; font-size: 14px;">üéØ SELECTED</span>
          <span id="selectedAssetArrow" style="color: #ff6600; font-size: 14px; transition: transform 0.3s;">‚ñ∂</span>
        </div>
        <div id="selectedAssetContent" class="section-content" style="display: none; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 2px solid #ff6600; border-top: none; border-radius: 0 0 8px 8px; font-family: 'Orbitron', monospace; color: #e0e0ff; font-size: 11px;">
          <div id="selectedAssetInfo" style="text-align: center; color: #888; padding: 20px 0;">
            Click an asset to view details
          </div>
        </div>
      </div>

      <!-- Galaxy Shape Controls Section -->
      <div class="sidebar-section" style="margin-bottom: 15px;">
        <div class="section-header" onclick="toggleSidebarSection('galaxyShape')" style="background: rgba(138, 79, 255, 0.2); border: 2px solid #8a4fff; border-radius: 8px; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
          <span style="color: #8a4fff; font-family: 'Orbitron', monospace; font-weight: bold; font-size: 14px;">üåÄ GALAXY SHAPE</span>
          <span id="galaxyShapeArrow" style="color: #8a4fff; font-size: 14px; transition: transform 0.3s;">‚ñº</span>
        </div>
        <div id="galaxyShapeContent" class="section-content" style="padding: 12px; background: rgba(0, 0, 0, 0.3); border: 2px solid #8a4fff; border-top: none; border-radius: 0 0 8px 8px; display: flex; flex-direction: column; gap: 12px;">

          <!-- Shape Presets -->
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label style="color: #8a4fff; font-family: 'Orbitron', monospace; font-size: 11px; font-weight: bold;">Shape Presets:</label>
            <div style="display: flex; gap: 6px;">
              <button onclick="handleGalaxyShapePreset('spiral-3')" style="flex: 1; background: rgba(138, 79, 255, 0.3); border: 2px solid #8a4fff; border-radius: 6px; padding: 8px; color: #fff; font-size: 11px; cursor: pointer; transition: all 0.3s; font-family: 'Orbitron', monospace;" title="3-Armed Spiral">3-Arm</button>
              <button onclick="handleGalaxyShapePreset('spiral-4')" style="flex: 1; background: rgba(138, 79, 255, 0.3); border: 2px solid #8a4fff; border-radius: 6px; padding: 8px; color: #fff; font-size: 11px; cursor: pointer; transition: all 0.3s; font-family: 'Orbitron', monospace;" title="4-Armed Spiral">4-Arm</button>
              <button onclick="handleGalaxyShapePreset('spiral-6')" style="flex: 1; background: rgba(138, 79, 255, 0.5); border: 2px solid #8a4fff; border-radius: 6px; padding: 8px; color: #fff; font-size: 11px; cursor: pointer; transition: all 0.3s; font-family: 'Orbitron', monospace; box-shadow: 0 0 10px rgba(138, 79, 255, 0.5);" title="6-Armed Spiral (Default)">6-Arm</button>
            </div>
          </div>

          <!-- Dimension Slider -->
          <div style="display: flex; flex-direction: column; gap: 4px;">
            <label style="color: #8a4fff; font-family: 'Orbitron', monospace; font-size: 11px; display: flex; justify-content: space-between;">
              <span>Dimension:</span>
              <span id="dimensionValue" style="color: #fff;">1.0</span>
            </label>
            <input type="range" id="dimensionSlider" min="0.5" max="2.0" step="0.1" value="1.0" oninput="handleGalaxyDimensionChange(this.value)" style="width: 100%; accent-color: #8a4fff; cursor: pointer;" title="Adjust galaxy size">
          </div>

          <!-- Trim Slider -->
          <div style="display: flex; flex-direction: column; gap: 4px;">
            <label style="color: #8a4fff; font-family: 'Orbitron', monospace; font-size: 11px; display: flex; justify-content: space-between;">
              <span>Trim (Core):</span>
              <span id="trimValue" style="color: #fff;">0.2</span>
            </label>
            <input type="range" id="trimSlider" min="0.0" max="0.5" step="0.05" value="0.2" oninput="handleGalaxyTrimChange(this.value)" style="width: 100%; accent-color: #8a4fff; cursor: pointer;" title="Adjust core trim">
          </div>

          <!-- Curvature Slider -->
          <div style="display: flex; flex-direction: column; gap: 4px;">
            <label style="color: #8a4fff; font-family: 'Orbitron', monospace; font-size: 11px; display: flex; justify-content: space-between;">
              <span>Curvature:</span>
              <span id="curvatureValue" style="color: #fff;">2.0</span>
            </label>
            <input type="range" id="curvatureSlider" min="0.5" max="4.0" step="0.5" value="2.0" oninput="handleGalaxyCurvatureChange(this.value)" style="width: 100%; accent-color: #8a4fff; cursor: pointer;" title="Adjust spiral tightness">
          </div>

          <div style="color: #888; font-family: 'Courier New', monospace; font-size: 10px; padding: 8px; background: rgba(138, 79, 255, 0.1); border-radius: 4px; border: 1px solid rgba(138, 79, 255, 0.3);">
            <strong style="color: #8a4fff;">Note:</strong> Changes apply to all galaxies in the scene.
          </div>
        </div>
      </div>

      <!-- Layer Controls Section -->
      <div class="sidebar-section" style="margin-bottom: 15px;">
        <div class="section-header" onclick="toggleSidebarSection('layerControls')" style="background: rgba(0, 255, 255, 0.2); border: 2px solid #00ffff; border-radius: 8px; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
          <span style="color: #00ffff; font-family: 'Orbitron', monospace; font-weight: bold; font-size: 14px;">üëÅÔ∏è LAYERS</span>
          <span id="layerControlsArrow" style="color: #00ffff; font-size: 14px; transition: transform 0.3s;">‚ñº</span>
        </div>
        <div id="layerControlsContent" class="section-content" style="padding: 12px; background: rgba(0, 0, 0, 0.3); border: 2px solid #00ffff; border-top: none; border-radius: 0 0 8px 8px; display: flex; flex-direction: column; gap: 8px;">
          <button id="toggleOrbitsBtn" class="control-btn" style="background: rgba(0, 255, 255, 0.9); border: 2px solid #00ffff; border-radius: 6px; padding: 10px; color: #000; font-size: 14px; cursor: pointer; transition: all 0.3s; font-family: 'Courier New', monospace;" title="Toggle Orbital Paths">üåÄ Orbital Paths</button>
          <button id="toggleVelocityBtn" class="control-btn" style="background: rgba(0, 255, 255, 0.9); border: 2px solid #00ffff; border-radius: 6px; padding: 10px; color: #000; font-size: 14px; cursor: pointer; transition: all 0.3s; font-family: 'Courier New', monospace;" title="Toggle Velocity Arrows">‚û§ Velocity Arrows</button>
          <button id="toggleConnectionsBtn" class="control-btn" style="background: rgba(0, 255, 255, 0.9); border: 2px solid #00ffff; border-radius: 6px; padding: 10px; color: #000; font-size: 14px; cursor: pointer; transition: all 0.3s; font-family: 'Courier New', monospace;" title="Toggle Connections">‚ö° Connections</button>
        </div>
      </div>

      <% if (user && (user.isAdmin || user.userRole === 'tester')) { %>
      <!-- Debug/Admin Section -->
      <div class="sidebar-section" style="margin-bottom: 15px;">
        <div class="section-header" onclick="toggleSidebarSection('debugAdmin')" style="background: rgba(138, 79, 255, 0.2); border: 2px solid #8a4fff; border-radius: 8px; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
          <span style="color: #8a4fff; font-family: 'Orbitron', monospace; font-weight: bold; font-size: 14px;">üîß <%= user.isAdmin ? 'ADMIN' : 'DEBUG' %></span>
          <span id="debugAdminArrow" style="color: #8a4fff; font-size: 14px; transition: transform 0.3s;">‚ñ∂</span>
        </div>
        <div id="debugAdminContent" class="section-content" style="display: none; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 2px solid #8a4fff; border-top: none; border-radius: 0 0 8px 8px; flex-direction: column; gap: 8px;">
          <% if (user.isAdmin) { %>
          <button onclick="window.location.href='/admin'" style="background: rgba(138, 79, 255, 0.9); border: 2px solid #8a4fff; border-radius: 6px; padding: 10px; color: #ffffff; font-size: 12px; cursor: pointer; transition: all 0.3s; font-family: 'Orbitron', monospace;">Admin Dashboard</button>

          <!-- Simulation Speed Control -->
          <div style="margin-top: 10px; padding: 10px; background: rgba(138, 79, 255, 0.1); border-radius: 6px;">
            <label style="color: #8a4fff; font-family: 'Orbitron', monospace; font-size: 12px; display: block; margin-bottom: 8px;">
              ‚ö° Simulation Speed: <span id="simSpeedDisplay">1.0x</span>
            </label>
            <input
              type="range"
              id="simSpeedSlider"
              min="0.1"
              max="10"
              step="0.1"
              value="1.0"
              style="width: 100%; cursor: pointer;"
              oninput="updateSimulationSpeed(this.value)"
            />
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #8a4fff; margin-top: 4px; font-family: 'Courier New', monospace;">
              <span>0.1x</span>
              <span>1.0x</span>
              <span>10x</span>
            </div>
          </div>
          <% } %>

          <button onclick="console.log(window.galacticMap)" style="background: rgba(138, 79, 255, 0.7); border: 2px solid #8a4fff; border-radius: 6px; padding: 10px; color: #ffffff; font-size: 11px; cursor: pointer; transition: all 0.3s; font-family: 'Courier New', monospace;">Log Map Data</button>
          <button onclick="console.log(window.currentCharacter)" style="background: rgba(138, 79, 255, 0.7); border: 2px solid #8a4fff; border-radius: 6px; padding: 10px; color: #ffffff; font-size: 11px; cursor: pointer; transition: all 0.3s; font-family: 'Courier New', monospace;">Log Character Data</button>
        </div>
      </div>
      <% } %>

      <!-- Legend Section -->
      <div class="sidebar-section" style="margin-bottom: 15px;">
        <div class="section-header" onclick="toggleSidebarSection('legend')" style="background: rgba(0, 255, 170, 0.2); border: 2px solid #00ffaa; border-radius: 8px; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
          <span style="color: #00ffaa; font-family: 'Orbitron', monospace; font-weight: bold; font-size: 14px;">üìñ LEGEND</span>
          <span id="legendArrow" style="color: #00ffaa; font-size: 14px; transition: transform 0.3s;">‚ñ∂</span>
        </div>
        <div id="legendContent" class="section-content" style="display: none; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 2px solid #00ffaa; border-top: none; border-radius: 0 0 8px 8px; font-family: 'Courier New', monospace; color: #e0e0ff; font-size: 11px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <div style="width: 12px; height: 12px; background: #bb88ff; border-radius: 2px;"></div>
            <span>Galaxies</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <div style="width: 12px; height: 12px; background: #ffff00; border-radius: 2px;"></div>
            <span>Stars</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <div style="width: 12px; height: 12px; background: #00ff88; border-radius: 2px;"></div>
            <span>Planets</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <div style="width: 12px; height: 12px; background: #ff6600; border-radius: 2px;"></div>
            <span>Stations</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <div style="width: 12px; height: 12px; background: #00aaff; border-radius: 2px;"></div>
            <span>Ships</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <div style="width: 12px; height: 12px; background: #00ffff; border: 2px solid #00ffff; background: transparent; border-radius: 2px;"></div>
            <span>Zones</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <div style="width: 12px; height: 12px; background: #ff00ff; border-radius: 2px;"></div>
            <span>Anomalies</span>
          </div>
          <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid rgba(0, 255, 170, 0.3);">
            <div style="font-weight: bold; margin-bottom: 6px; color: #00ffaa;">Connection States:</div>
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div style="width: 24px; height: 2px; background: #00ff00;"></div>
              <span>Stable (3+ days)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div style="width: 24px; height: 2px; background: #ff4400;"></div>
              <span>Breaking (&lt;1 day)</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <div style="width: 24px; height: 2px; background: repeating-linear-gradient(to right, #0088ff 0, #0088ff 4px, transparent 4px, transparent 8px);"></div>
              <span>Forming (&lt;0.5 day)</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Collapsed Sidebar Toggle (Shown when sidebar is hidden) -->
  <button id="showSidebarBtn" class="zen-hideable" onclick="handleSidebarToggle()" style="position: fixed; left: 0; top: 50%; transform: translateY(-50%); background: rgba(138, 79, 255, 0.9); border: 2px solid #8a4fff; border-radius: 0 8px 8px 0; padding: 15px 10px; color: #ffffff; font-size: 20px; cursor: pointer; transition: all 0.3s; z-index: 999; display: flex; pointer-events: auto;" title="Show Sidebar">¬ª</button>

  <!-- Info Pane REMOVED - Direct navigation to galaxy/system views instead -->


  <!-- Overlay Menu System -->
  <div class="overlay-menu" id="overlayMenu" style="position: fixed; top: 0; right: -400px; width: 360px; height: 100vh; background: rgba(10, 10, 26, 0.98); backdrop-filter: blur(20px); border-left: 2px solid rgba(138, 79, 255, 0.4); z-index: 10000; transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; overflow-y: auto;">
    <div class="overlay-menu-header" style="padding: 20px; border-bottom: 1px solid rgba(138, 79, 255, 0.3); display: flex; justify-content: space-between; align-items: center;">
      <h2 class="overlay-menu-title" style="margin: 0; color: #8a4fff; font-family: 'Orbitron', monospace; font-size: 20px;">Navigation Hub</h2>
      <button class="overlay-menu-close" onclick="toggleOverlayMenu()" style="background: rgba(138, 79, 255, 0.2); border: 1px solid rgba(138, 79, 255, 0.4); border-radius: 50%; color: #8a4fff; width: 32px; height: 32px; font-size: 18px; cursor: pointer; transition: all 0.2s;">‚úï</button>
    </div>

    <nav class="overlay-menu-nav" style="flex: 1; padding: 10px 0;">
      <div class="overlay-menu-item" onclick="navigateWithConfirmation('/characters')" style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid rgba(138, 79, 255, 0.1);">
        <span class="menu-item-icon" style="font-size: 20px; margin-right: 15px;">‚öîÔ∏è</span>
        <span class="menu-item-label" style="flex: 1; color: #e0e0ff; font-family: 'Orbitron', monospace;">Characters</span>
        <span class="menu-item-arrow" style="color: #8a4fff; font-size: 18px;">‚Ä∫</span>
      </div>

      <div class="overlay-menu-item" onclick="navigateWithConfirmation('/universe/tome')" style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid rgba(138, 79, 255, 0.1);">
        <span class="menu-item-icon" style="font-size: 20px; margin-right: 15px;">üìñ</span>
        <span class="menu-item-label" style="flex: 1; color: #e0e0ff; font-family: 'Orbitron', monospace;">The Tome</span>
        <span class="menu-item-arrow" style="color: #8a4fff; font-size: 18px;">‚Ä∫</span>
      </div>

      <div class="overlay-menu-item" onclick="navigateWithConfirmation('/assets')" style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid rgba(138, 79, 255, 0.1);">
        <span class="menu-item-icon" style="font-size: 20px; margin-right: 15px;">üé®</span>
        <span class="menu-item-label" style="flex: 1; color: #e0e0ff; font-family: 'Orbitron', monospace;">Asset Workshop</span>
        <span class="menu-item-arrow" style="color: #8a4fff; font-size: 18px;">‚Ä∫</span>
      </div>

      <div class="overlay-menu-item" onclick="navigateWithConfirmation('/assets/voting')" style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid rgba(138, 79, 255, 0.1);">
        <span class="menu-item-icon" style="font-size: 20px; margin-right: 15px;">üó≥Ô∏è</span>
        <span class="menu-item-label" style="flex: 1; color: #e0e0ff; font-family: 'Orbitron', monospace;">Asset Governance</span>
        <span class="menu-item-arrow" style="color: #8a4fff; font-size: 18px;">‚Ä∫</span>
      </div>

      <div class="overlay-menu-item" onclick="navigateWithConfirmation('/profile')" style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid rgba(138, 79, 255, 0.1);">
        <span class="menu-item-icon" style="font-size: 20px; margin-right: 15px;">üìä</span>
        <span class="menu-item-label" style="flex: 1; color: #e0e0ff; font-family: 'Orbitron', monospace;">Profile</span>
        <span class="menu-item-arrow" style="color: #8a4fff; font-size: 18px;">‚Ä∫</span>
      </div>

      <div class="overlay-menu-divider" style="height: 1px; background: rgba(138, 79, 255, 0.3); margin: 10px 20px;"></div>

      <div class="overlay-menu-item" onclick="navigateWithConfirmation('/menu')" style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid rgba(138, 79, 255, 0.1);">
        <span class="menu-item-icon" style="font-size: 20px; margin-right: 15px;">üè†</span>
        <span class="menu-item-label" style="flex: 1; color: #e0e0ff; font-family: 'Orbitron', monospace;">Exit to Menu</span>
        <span class="menu-item-arrow" style="color: #8a4fff; font-size: 18px;">‚Ä∫</span>
      </div>

      <% if (user && user.isAdmin) { %>
      <div class="overlay-menu-divider" style="height: 1px; background: rgba(138, 79, 255, 0.3); margin: 10px 20px;"></div>
      <div class="overlay-menu-section-title" style="padding: 15px 20px; color: #8a4fff; font-family: 'Orbitron', monospace; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Admin</div>

      <div class="overlay-menu-item admin-item" onclick="navigateWithConfirmation('/admin')" style="padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; border-bottom: 1px solid rgba(138, 79, 255, 0.1);">
        <span class="menu-item-icon" style="font-size: 20px; margin-right: 15px;">‚öôÔ∏è</span>
        <span class="menu-item-label" style="flex: 1; color: #e0e0ff; font-family: 'Orbitron', monospace;">Admin Dashboard</span>
        <span class="menu-item-arrow" style="color: #8a4fff; font-size: 18px;">‚Ä∫</span>
      </div>
      <% } %>
    </nav>
  </div>

  <!-- Overlay backdrop for menu -->
  <div class="overlay-backdrop" id="overlayBackdrop" onclick="toggleOverlayMenu()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease;"></div>

  <!-- Navigation Confirmation Dialog -->
  <div id="navigationConfirmDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px); z-index: 20000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; display: flex; align-items: center; justify-content: center;">
    <div style="background: rgba(10, 10, 26, 0.98); border: 2px solid #ff6600; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 0 40px rgba(255, 102, 0, 0.4);">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
        <h2 style="margin: 0 0 10px 0; color: #ff6600; font-family: 'Orbitron', monospace; font-size: 20px;">Leave Galactic Map?</h2>
        <p style="color: #e0e0ff; font-family: 'Orbitron', monospace; font-size: 14px; margin: 0;">Your current position and progress will be saved, but you'll exit the 3D view.</p>
      </div>
      <div style="display: flex; gap: 15px; margin-top: 25px;">
        <button id="confirmNavigateBtn" style="flex: 1; background: linear-gradient(135deg, rgba(255, 102, 0, 0.3), rgba(255, 68, 0, 0.3)); border: 2px solid #ff6600; border-radius: 8px; padding: 12px 20px; color: #ff6600; font-family: 'Orbitron', monospace; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
          Leave
        </button>
        <button id="cancelNavigateBtn" style="flex: 1; background: linear-gradient(135deg, rgba(138, 79, 255, 0.3), rgba(74, 158, 255, 0.3)); border: 2px solid #8a4fff; border-radius: 8px; padding: 12px 20px; color: #8a4fff; font-family: 'Orbitron', monospace; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s;">
          Stay
        </button>
      </div>
    </div>
  </div>

  <!-- Socket.IO for real-time player updates -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- GameStateMonitor - Centralized coordinate management -->
  <script src="/javascripts/GameStateMonitor.js"></script>

  <!-- Three.js Library (ES Module) -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <!-- 3D Galactic Map Script -->
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // Make THREE available globally for the script
    window.THREE = THREE;
    window.OrbitControls = OrbitControls;
  </script>

  <script src="/javascripts/galactic-map-3d.js?v=8.0.1&t=<%= Date.now() %>"></script>
  <script src="/javascripts/activity-monitor.js"></script>
  <script src="/javascripts/global-chat.js"></script>

  <script>
    // ========================================
    // CRITICAL: Initialize Galactic Map 3D
    // ========================================
    // Wait for THREE.js to be loaded (module loading is async)
    function initializeGalacticMap() {
      if (typeof THREE === 'undefined' || typeof GalacticMap3D === 'undefined') {
        console.log('‚è≥ Waiting for THREE.js and GalacticMap3D to load...');
        setTimeout(initializeGalacticMap, 100);
        return;
      }

      console.log('üåå Initializing Galactic Map 3D...');
      window.galacticMap = new GalacticMap3D('mapContainer');

      // Initialize socket connection for physics updates (socket will be connected later)
      // Socket initialization happens after the map loads in the socket setup section below

      // Load and display all assets - use map-state-3d endpoint (includes all assets including planets)
      fetch('/api/v1/state/map-state-3d')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Transform map-state-3d format to legacy format for compatibility
            const allAssets = data.assets.map(asset => ({
              _id: asset.id,
              title: asset.title,
              assetType: asset.type,
              coordinates: {
                x: asset.x,
                y: asset.y,
                z: asset.z
              },
              renderData: asset.renderData,
              radius: asset.radius,
              parentId: asset.parentId,
              parentType: asset.parentType,
              parentGalaxy: asset.parentGalaxy,
              parentStar: asset.parentStar,
              orbitRadius: asset.orbitRadius,
              velocity: asset.velocity,
              localCoordinates: asset.localCoordinates,
              universalCoordinates: asset.universalCoordinates
            }));

            // Count asset types for logging
            const counts = allAssets.reduce((acc, a) => {
              acc[a.assetType] = (acc[a.assetType] || 0) + 1;
              return acc;
            }, {});

            console.log(`üì¶ Loaded ${allAssets.length} total assets:`, counts);
            window.galacticMap.allAssets = allAssets;

            // Display assets at universe level (galaxies and anomalies)
            window.galacticMap.showUniverseLevel();

            // Populate sidebar asset selector
            if (window.populateAssetSelector) {
              setTimeout(() => window.populateAssetSelector(), 100);
            }

            // Load current simulation speed
            if (window.loadSimulationSpeed) {
              setTimeout(() => window.loadSimulationSpeed(), 100);
            }

            // Start animation loop
            window.galacticMap.animate();

            console.log('‚úÖ Galactic Map 3D initialized and assets loaded');
          } else {
            console.error('‚ùå Failed to load assets: Invalid response', data);
          }
        })
        .catch(err => {
          console.error('‚ùå Failed to load assets:', err);
        });
    }

    // Start initialization check
    initializeGalacticMap();

    /**
     * Close info pane - DEPRECATED (info pane removed)
     */
    window.closeInfoPane = function() {
      console.log('‚ÑπÔ∏è closeInfoPane called but info pane has been removed');
    };

    /**
     * Show floating HUD next to star
     */
    window.showFloatingHUD = function(asset) {
      const hud = document.getElementById('floatingHUD');
      const canvas = document.getElementById('hudLineCanvas');

      // Get star position in 3D space
      const starObject = window.galacticMap?.assets?.get(asset._id);
      if (!starObject || !starObject.mesh) return;

      const starPos = starObject.mesh.position.clone();

      // Project 3D position to 2D screen coordinates
      const vector = starPos.clone();
      vector.project(window.galacticMap.camera);

      const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
      const y = (vector.y * -0.5 + 0.5) * window.innerHeight;

      // Position HUD offset to the right and slightly up from star
      const offsetX = 100;
      const offsetY = -50;

      hud.style.left = (x + offsetX) + 'px';
      hud.style.top = (y + offsetY) + 'px';
      hud.style.display = 'block';

      // Animate HUD entrance
      hud.style.opacity = '0';
      hud.style.transform = 'translateX(-20px) scale(0.9)';
      hud.style.transition = 'all 0.2s ease-out';

      setTimeout(() => {
        hud.style.opacity = '1';
        hud.style.transform = 'translateX(0) scale(1)';
      }, 10);

      // Update HUD content
      document.getElementById('hudTitle').textContent = `[${asset.title.toUpperCase()}]`;
      document.getElementById('hudType').textContent = `TYPE: ${asset.assetType.toUpperCase()}`;

      const coords = asset.localCoordinates || asset.coordinates;
      document.getElementById('hudCoords').textContent =
        `COORDS: [${Math.floor(coords.x)}, ${Math.floor(coords.y)}, ${Math.floor(coords.z)}]`;

      // Count assets within this star system
      const allAssets = window.galacticMap?.allAssets || [];
      const systemAssets = allAssets.filter(a => a.parentStar === asset._id);

      const planetCount = systemAssets.filter(a => a.assetType === 'planet').length;
      const stationCount = systemAssets.filter(a => a.assetType === 'station' || a.assetType === 'orbital').length;
      const shipCount = systemAssets.filter(a => a.assetType === 'ship').length;
      const totalCount = systemAssets.length;

      document.getElementById('hudPlanets').textContent = `PLANETS: ${planetCount}`;
      document.getElementById('hudStations').textContent = `STATIONS: ${stationCount}`;
      document.getElementById('hudShips').textContent = `SHIPS: ${shipCount}`;
      document.getElementById('hudTotal').textContent = `TOTAL: ${totalCount}`;

      // Draw connection line
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      canvas.style.display = 'block';

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw line from star to HUD
      ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
      ctx.lineWidth = 1;
      ctx.setLineDash([5, 5]);

      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + offsetX, y + offsetY + 20); // Connect to middle of HUD
      ctx.stroke();

      // Draw dot at star position
      ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
      ctx.beginPath();
      ctx.arc(x, y, 3, 0, Math.PI * 2);
      ctx.fill();
    };

    /**
     * Hide floating HUD
     */
    window.hideFloatingHUD = function() {
      const hud = document.getElementById('floatingHUD');
      const canvas = document.getElementById('hudLineCanvas');

      hud.style.display = 'none';
      canvas.style.display = 'none';

      // Clear canvas
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    /**
     * Display asset info - DEPRECATED (info pane removed)
     */
    window.displayAssetInfo = function(assetData) {
      console.log('‚ÑπÔ∏è displayAssetInfo called but info pane has been removed:', assetData.title, '| Type:', assetData.type);
      // Info pane functionality removed - all navigation is now direct
    };

    // Update UI based on map state - direct navigation only (info pane removed)
    window.addEventListener('assetSelected', (e) => {
      const assetData = e.detail;

      // Debug logging
      console.log('üìç Asset selected event:', {
        type: assetData.type,
        id: assetData.id,
        title: assetData.title,
        currentLevel: window.galacticMap?.currentLevel
      });

      // If clicking a galaxy at universe/galactic level, drill directly into galaxy view
      if (assetData.type === 'galaxy' && assetData.id &&
          (window.galacticMap?.currentLevel === 'universe' || window.galacticMap?.currentLevel === 'galactic')) {
        console.log(`üåå DRILL DOWN: Galaxy selected at ${window.galacticMap?.currentLevel} level - ${assetData.title}`);
        window.galacticMap.showGalaxyLevel(assetData.id);
        return; // EXIT
      }

      // If clicking a star in galaxy view, show modal instead of navigating
      // (The modal has a button to navigate to system-map-3d)
      if (assetData.type === 'star' && assetData.id) {
        if (window.galacticMap?.currentLevel === 'galaxy') {
          console.log(`‚≠ê MODAL: Star selected in galaxy view - ${assetData.title} (showing modal)`);
          // Modal is shown by galactic-map-3d.js, don't navigate here
          return; // EXIT
        } else {
          // For other levels (universe/galactic), navigate directly
          console.log(`üî≠ NAVIGATE: Star selected - ${assetData.title}`);
          window.location.href = `/universe/system-map-3d?star=${assetData.id}`;
          return; // EXIT
        }
      }

      // For other assets (anomalies, zones, etc.), just log - no info pane
      console.log(`‚ÑπÔ∏è Asset clicked: ${assetData.type} - ${assetData.title} (info pane removed)`);

      // OPTIONAL: Also update sidebar selected asset section (minimized version)
      const selectedAssetInfo = document.getElementById('selectedAssetInfo');
      const selectedAssetContent = document.getElementById('selectedAssetContent');
      const selectedAssetArrow = document.getElementById('selectedAssetArrow');

      if (selectedAssetInfo) {
        let html = `
          <h2 style="margin: 0 0 8px 0; font-size: 14px; color: #ff6600;">${assetData.title || 'Unknown Asset'}</h2>
          <span style="display: inline-block; padding: 2px 8px; background: rgba(255, 102, 0, 0.2); border: 1px solid #ff6600; border-radius: 3px; font-size: 10px; margin-bottom: 10px; color: #ff6600; text-transform: uppercase;">${assetData.type || 'unknown'}</span>
        `;

        if (assetData.data?.coordinates) {
          const { x, y, z } = assetData.data.coordinates;
          html += `
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span style="color: #888;">Position:</span>
              <span style="color: #00ddff; font-weight: bold;">${x.toFixed(1)}, ${y.toFixed(1)}, ${z.toFixed(1)}</span>
            </div>
          `;
        }

        selectedAssetInfo.innerHTML = html;

        // Auto-expand the section
        if (selectedAssetContent.style.display === 'none') {
          selectedAssetContent.style.display = 'block';
          selectedAssetArrow.textContent = '‚ñº';
          selectedAssetArrow.style.transform = 'rotate(0deg)';
        }

        console.log('‚úÖ Asset selected in sidebar:', assetData.title);
      }
    });

    window.addEventListener('assetDeselected', () => {
      // Reset sidebar selected asset section
      const selectedAssetInfo = document.getElementById('selectedAssetInfo');
      if (selectedAssetInfo) {
        selectedAssetInfo.innerHTML = '<div style="text-align: center; color: #888; padding: 20px 0;">Click an asset to view details</div>';
      }

      window.closeInfoPane();
    });

    // Hover events - DISABLED (unnecessary HUD)
    // window.addEventListener('assetHovered', (e) => {
    //   const asset = e.detail.asset;
    //   window.showFloatingHUD(asset);
    // });

    // window.addEventListener('assetHoverEnd', () => {
    //   window.hideFloatingHUD();
    // });

    // Backdrop click listener removed (info pane removed)


    // ESC to deselect
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && window.galacticMap) {
        window.galacticMap.deselectObject();
      }
    });

    // Wire up control buttons
    document.getElementById('zoomInBtn').addEventListener('click', () => {
      if (window.galacticMap) {
        window.galacticMap.camera.zoom *= 1.2;
        window.galacticMap.camera.updateProjectionMatrix();
      }
    });

    document.getElementById('zoomOutBtn').addEventListener('click', () => {
      if (window.galacticMap) {
        window.galacticMap.camera.zoom /= 1.2;
        window.galacticMap.camera.updateProjectionMatrix();
      }
    });

    // Locate Me button - focus on player character
    document.getElementById('locateMeBtn').addEventListener('click', () => {
      if (!window.currentCharacter || !window.currentCharacter.location) {
        alert('No character location available. Make sure you have an active character.');
        return;
      }

      if (!window.galacticMap) {
        return;
      }

      const location = window.currentCharacter.location;
      const playerPos = new THREE.Vector3(
        location.x || 0,
        location.y || 0,
        location.z || 0
      );

      console.log(`üìç Locating player at (${playerPos.x}, ${playerPos.y}, ${playerPos.z})`);

      // Focus camera on player with appropriate zoom
      window.galacticMap.focusCameraOn(playerPos, 1500);

      // Show notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 255, 0, 0.2);
        border: 1px solid #00ff00;
        border-radius: 8px;
        padding: 10px 20px;
        color: #00ff00;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        z-index: 10000;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      `;
      notification.textContent = `üìç Located: ${window.currentCharacter.name}`;
      document.body.appendChild(notification);

      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, 2000);
    });

    // toggleOverlayMenu is now defined earlier in the script (line 592)

    // Layer visibility controls
    let orbitsVisible = true;
    let velocityVisible = true;
    let connectionsVisible = true;

    document.getElementById('toggleOrbitsBtn').addEventListener('click', () => {
      orbitsVisible = !orbitsVisible;
      if (window.galacticMap && window.galacticMap.scene) {
        // Find all orbital path objects
        window.galacticMap.scene.traverse((obj) => {
          if (obj.userData && obj.userData.isOrbitalPath) {
            obj.visible = orbitsVisible;
          }
        });
      }
      const btn = document.getElementById('toggleOrbitsBtn');
      btn.style.opacity = orbitsVisible ? '1.0' : '0.5';
      console.log(`Orbital paths ${orbitsVisible ? 'shown' : 'hidden'}`);
    });

    document.getElementById('toggleVelocityBtn').addEventListener('click', () => {
      velocityVisible = !velocityVisible;
      if (window.galacticMap && window.galacticMap.scene) {
        // Find all velocity arrow objects
        window.galacticMap.scene.traverse((obj) => {
          if (obj.userData && obj.userData.isVelocityArrow) {
            obj.visible = velocityVisible;
          }
        });
      }
      const btn = document.getElementById('toggleVelocityBtn');
      btn.style.opacity = velocityVisible ? '1.0' : '0.5';
      console.log(`Velocity arrows ${velocityVisible ? 'shown' : 'hidden'}`);
    });

    document.getElementById('toggleConnectionsBtn').addEventListener('click', () => {
      connectionsVisible = !connectionsVisible;
      if (window.galacticMap && window.galacticMap.connectionsGroup) {
        window.galacticMap.connectionsGroup.visible = connectionsVisible;
      }
      const btn = document.getElementById('toggleConnectionsBtn');
      btn.style.opacity = connectionsVisible ? '1.0' : '0.5';
      console.log(`Connections ${connectionsVisible ? 'shown' : 'hidden'}`);
    });

    // Asset selector - view selected galaxy/anomaly with floating HUD
    const assetSelectorElement = document.getElementById('assetSelector');
    if (assetSelectorElement) {
      assetSelectorElement.addEventListener('change', (e) => {
        const assetId = e.target.value;
        if (!assetId || !window.galacticMap) return;

        console.log('üîç Asset selected from sidebar:', assetId);

        // Find the asset in the scene
        const assetObject = window.galacticMap.assets.get(assetId);
        if (assetObject && assetObject.mesh) {
          const assetPos = assetObject.mesh.position;
          const assetData = assetObject.mesh.userData;

          console.log(`üìç Focusing on ${assetData.title} at (${assetPos.x}, ${assetPos.y}, ${assetPos.z})`);

          // Focus camera on the asset
          window.galacticMap.camera.position.set(
            assetPos.x,
            assetPos.y + 1000,
            assetPos.z + 500
          );

          if (window.galacticMap.controls) {
            window.galacticMap.controls.target.copy(assetPos);
            window.galacticMap.controls.update();
          }

          // Select the object (highlights it)
          window.galacticMap.selectObject(assetObject.mesh);

          // Show the sleek floating HUD instead of info pane
          // Find the asset in allAssets to get full data
          const fullAssetData = window.galacticMap.allAssets.find(a => a._id === assetId);
          if (fullAssetData && window.showFloatingHUD) {
            window.showFloatingHUD(fullAssetData);
          }

          // Update sidebar selected section
          window.dispatchEvent(new CustomEvent('assetSelected', {
            detail: {
              title: assetData.title,
              type: assetData.type,
              data: {
                _id: assetData.id,
                coordinates: assetPos
              }
            }
          }));
        } else {
          console.warn('‚ö†Ô∏è Asset not found in scene:', assetId);
        }

        // Reset selector
        e.target.value = '';
      });
      console.log('‚úÖ Asset selector event listener attached');
    }

    // ========================================
    // Socket.IO Setup for Real-Time Players
    // ========================================
    console.log('üîç Socket.IO setup section reached! user=' + <%= user ? 'true' : 'false' %>);
    <% if (user) { %>
    console.log('üîå Initializing Socket.IO connection (logged in user)...');
    console.log('üîç typeof io:', typeof io);

    // Initialize Socket.IO
    const socket = io({
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      reconnectionAttempts: 10
    });

    console.log('‚úÖ Socket object created:', socket);

    socket.on('connect', () => {
      console.log('‚úÖ Socket.IO CONNECTED! ID:', socket.id);
    });

    socket.on('connect_error', (err) => {
      console.error('‚ùå Socket.IO connection error:', err.message);
    });

    socket.on('disconnect', (reason) => {
      console.warn('‚ö†Ô∏è Socket.IO disconnected:', reason);
    });

    const userObj = {
      _id: '<%= user._id %>',
      id: '<%= user._id %>',
      username: '<%= user.username %>',
      userRole: '<%= user.userRole %>'
    };

    // Handle Socket.IO connection events
    socket.on('connect_error', (error) => {
      console.error('‚ùå Socket.IO connection error:', error);
    });

    socket.on('disconnect', (reason) => {
      console.warn('‚ö†Ô∏è Socket.IO disconnected:', reason);
    });

    socket.on('reconnect', (attemptNumber) => {
      console.log('üîÑ Socket.IO reconnected after', attemptNumber, 'attempts');
    });

    // Load current character and emit join event
    socket.on('connect', async () => {
      console.log('‚úÖ Socket.IO connected:', socket.id);

      try {
        // Fetch current character
        const response = await fetch('/api/v1/characters/current');
        const data = await response.json();

        if (data.success && data.character) {
          const character = data.character;
          console.log('üìç Current character loaded:', character.name, 'at', character.location);

          // Store character globally
          window.currentCharacter = character;

          // Initialize GameStateMonitor with socket and current character
          if (window.gameStateMonitor && !window.gameStateMonitor.connected) {
            window.gameStateMonitor.init(socket, character._id);
            console.log('üéÆ GameStateMonitor initialized for galactic-map-3d (AUTHORITATIVE)');
          }

          // Initialize Global Chat for all users
          if (typeof initGlobalChat === 'function' && !window.globalChat) {
            window.globalChat = initGlobalChat(socket, userObj, character);
            console.log('üí¨ Global Chat initialized and available to all users');
          }

          // Add player character to 3D map
          if (window.galacticMap && character.location) {
            window.galacticMap.addPlayerCharacter(character);
          }

          // Emit character join event
          if (character.location) {
            socket.emit('characterJoin', {
              characterId: character._id,
              characterName: character.name,
              userId: userObj._id,
              location: character.location,
              assetId: character.location.assetId || null,
              stringDomain: character.stringDomain || 'Time String'
            });
          }
        } else {
          console.log('‚ö†Ô∏è No active character found');
        }
      } catch (error) {
        console.error('‚ùå Error loading character:', error);
      }
    });

    // GameStateMonitor handles socket events, but keep map updates here for galactic-map-3d (authoritative view)
    // Subscribe to GameStateMonitor events to update the 3D map
    if (window.gameStateMonitor) {
      // Update map when players join
      window.gameStateMonitor.on('playerJoined', (data) => {
        if (window.galacticMap && data.location) {
          window.galacticMap.updatePlayerPosition(data.characterId, data.location, data.characterName);
        }
      });

      // Update map when players move
      window.gameStateMonitor.on('playerPositionUpdate', (data) => {
        if (window.galacticMap && data.characterId !== window.currentCharacter?._id) {
          window.galacticMap.updatePlayerPosition(data.characterId, data.position, data.characterName);
        }
      });

      // Remove player from map when they leave
      window.gameStateMonitor.on('playerLeft', (data) => {
        if (window.galacticMap) {
          window.galacticMap.removePlayer(data.characterId);
        }
      });

      // Sync all players on state sync
      window.gameStateMonitor.on('stateSync', (data) => {
        if (window.galacticMap && data.players) {
          data.players.forEach(player => {
            if (player.characterId !== window.currentCharacter?._id) {
              window.galacticMap.updatePlayerPosition(player.characterId, player.position, player.characterName);
            }
          });
        }
      });
    }

    // Legacy socket listeners (GameStateMonitor handles the data, these are for backwards compatibility)
    socket.on('onlinePlayers', (players) => {
      console.log('üì° Received online players:', players.length);
      // GameStateMonitor will handle this
    });

    socket.on('playerMoved', (data) => {
      console.log('üì° Player moved:', data.characterName);
      // GameStateMonitor will handle this
    });

    // Note: galacticPhysicsUpdate listener is registered via initializeSocket() above
    // The centralized handler in GalacticMap3D will manage all physics updates

    // Listen for simulation speed changes from server
    socket.on('simulationSpeedChanged', (data) => {
      const slider = document.getElementById('simSpeedSlider');
      const display = document.getElementById('simSpeedDisplay');

      if (slider && display) {
        slider.value = data.speed;
        display.textContent = data.speed.toFixed(1) + 'x';
      }

      console.log(`‚ö° Simulation speed updated by server: ${data.speed.toFixed(1)}x`);
    });

    // Initialize socket connection with galactic map (if map is ready)
    if (window.galacticMap) {
      window.galacticMap.initializeSocket(socket);
      console.log('‚úÖ Socket initialized with galactic map');
    } else {
      console.warn('‚ö†Ô∏è Galactic map not ready yet, socket will be connected when map initializes');
      // Wait for map to be ready
      const checkMapInterval = setInterval(() => {
        if (window.galacticMap) {
          window.galacticMap.initializeSocket(socket);
          console.log('‚úÖ Socket initialized with galactic map (delayed)');
          clearInterval(checkMapInterval);
        }
      }, 100);
    }

    // Store socket globally for other components
    window.socket = socket;
    <% } else { %>
    // Socket.IO for non-logged-in users (physics updates only)
    console.log('üîå Initializing Socket.IO connection (guest mode)...');
    const socket = io({
      reconnection: true,
      reconnectionDelay: 1000
    });

    socket.on('connect', () => {
      console.log('‚úÖ Socket.IO connected (guest mode)');
    });

    socket.on('disconnect', () => {
      console.log('‚ùå Socket.IO disconnected');
    });

    // Listen for simulation speed changes (guest mode doesn't control, but can observe)
    socket.on('simulationSpeedChanged', (data) => {
      console.log(`‚ö° Simulation speed updated: ${data.speed.toFixed(1)}x`);
    });

    // Initialize socket connection for physics updates
    if (window.galacticMap) {
      window.galacticMap.initializeSocket(socket);
      console.log('‚úÖ Socket initialized with galactic map (guest mode)');
    } else {
      console.warn('‚ö†Ô∏è galacticMap not ready, socket will be initialized later (guest mode)');
      // Wait for map to be ready
      const checkMapInterval = setInterval(() => {
        if (window.galacticMap) {
          window.galacticMap.initializeSocket(socket);
          console.log('‚úÖ Socket initialized with galactic map (guest mode, delayed)');
          clearInterval(checkMapInterval);
        }
      }, 100);
    }

    window.socket = socket;
    <% } %>

    // ========================================
    // Travel Function
    // ========================================
    window.travelToLocation = async function(x, y, z, destinationName) {
      if (!window.currentCharacter) {
        alert('No active character. Please select a character first.');
        return;
      }

      const characterId = window.currentCharacter._id;
      const startPos = window.currentCharacter.location || { x: 0, y: 0, z: 0 };
      const endPos = { x, y, z };

      console.log(`üöÄ Traveling to ${destinationName} at (${x}, ${y}, ${z})`);

      // Close info pane
      window.closeInfoPane();

      // Show travel progress UI - Terminal HUD style
      const progressDiv = document.createElement('div');
      progressDiv.id = 'travelProgress';
      progressDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.85);
        border: 1px solid #00ff00;
        border-left: 4px solid #00ff00;
        font-family: 'Courier New', monospace;
        padding: 15px 20px;
        z-index: 10000;
        min-width: 350px;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        backdrop-filter: blur(5px);
      `;
      progressDiv.innerHTML = `
        <div style="color: #00ff00; font-size: 11px; margin-bottom: 8px; opacity: 0.7;">
          [NAVIGATION SYSTEM]
        </div>
        <div style="color: #00ff00; font-size: 14px; margin-bottom: 12px; font-weight: bold;">
          > DESTINATION: ${destinationName}
        </div>
        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">
          STATUS: <span style="color: #ffaa00;">IN_TRANSIT</span>
        </div>
        <div style="display: flex; align-items: center; margin: 10px 0;">
          <span style="color: #888; font-size: 12px; margin-right: 10px;">PROGRESS:</span>
          <div style="flex: 1; background: #111; border: 1px solid #00ff00; height: 18px; position: relative; overflow: hidden;">
            <div id="travelProgressBar" style="
              background: #00ff00;
              height: 100%;
              width: 0%;
              transition: width 0.1s linear;
              box-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
            "></div>
          </div>
          <span id="travelProgressText" style="color: #00ff00; font-size: 12px; margin-left: 10px; min-width: 45px;">
            0%
          </span>
        </div>
        <div style="color: #666; font-size: 11px; margin-top: 8px;">
          ETA: <span id="travelETA" style="color: #888;">15.0s</span>
        </div>
      `;
      document.body.appendChild(progressDiv);

      const progressBar = document.getElementById('travelProgressBar');
      const progressText = document.getElementById('travelProgressText');
      const etaText = document.getElementById('travelETA');

      try {
        // Start animated travel
        window.galacticMap.animateTravel(
          characterId,
          startPos,
          endPos,
          window.currentCharacter.name,
          // On progress callback
          (posData) => {
            const percent = Math.round(posData.progress * 100);
            progressBar.style.width = percent + '%';
            progressText.textContent = percent + '%';

            // Update ETA countdown
            const remainingTime = 15 * (1 - posData.progress);
            etaText.textContent = remainingTime.toFixed(1) + 's';

            // Emit position updates to Socket.IO every 500ms
            if (window.socket && Date.now() % 500 < 100) {
              window.socket.emit('playerMove', {
                characterId: characterId,
                characterName: window.currentCharacter.name,
                location: { x: posData.x, y: posData.y, z: posData.z, type: 'galactic' }
              });
            }
          },
          // On complete callback
          async () => {
            // Update character location in database
            const response = await fetch(`/api/v1/characters/${characterId}/location`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                x: x,
                y: y,
                z: z,
                type: 'galactic'
              })
            });

            const data = await response.json();

            if (data.success) {
              console.log(`‚úÖ Traveled to ${destinationName}`);

              // Update local character position
              window.currentCharacter.location = { x, y, z, type: 'galactic' };

              // Final position emit to Socket.IO
              if (window.socket) {
                window.socket.emit('playerMove', {
                  characterId: characterId,
                  characterName: window.currentCharacter.name,
                  location: { x, y, z, type: 'galactic' }
                });
              }

              // Remove progress UI
              if (progressDiv && progressDiv.parentNode) {
                document.body.removeChild(progressDiv);
              }

              // Remove any existing success notifications
              const existingSuccess = document.getElementById('arrivalNotification');
              if (existingSuccess && existingSuccess.parentNode) {
                document.body.removeChild(existingSuccess);
              }

              // Find the destination object
              const destinationObject = window.galacticMap.findObjectAtPosition({ x, y, z }, 100);

              if (destinationObject) {
                // Create dramatic arrival effect with spiral zoom
                window.galacticMap.createArrivalEffect(destinationObject, () => {
                  // After spiral effect, select the object to show info pane
                  window.galacticMap.selectObject(destinationObject);
                });
              }

              // Show success message - bottom-left terminal style
              const successDiv = document.createElement('div');
              successDiv.id = 'arrivalNotification';
              successDiv.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: rgba(0, 0, 0, 0.85);
                border: 1px solid #00ff00;
                border-left: 4px solid #00ff00;
                font-family: 'Courier New', monospace;
                padding: 15px 20px;
                color: #00ff00;
                z-index: 10000;
                box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
                backdrop-filter: blur(5px);
                min-width: 300px;
              `;

              // Safely escape destination name
              const safeDestName = String(destinationName).replace(/[<>&"']/g, (c) => {
                return {'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;', "'":"&#39;"}[c];
              });

              successDiv.innerHTML = `
                <div style="color: #00ff00; font-size: 11px; margin-bottom: 5px; opacity: 0.7;">
                  [NAVIGATION SYSTEM]
                </div>
                <div style="color: #00ff00; font-size: 13px;">
                  > ARRIVAL CONFIRMED
                </div>
                <div style="color: #888; font-size: 12px; margin-top: 5px;">
                  LOCATION: ${safeDestName}
                </div>
              `;
              document.body.appendChild(successDiv);

              setTimeout(() => {
                if (successDiv && successDiv.parentNode) {
                  document.body.removeChild(successDiv);
                }
              }, 3000);
            } else {
              document.body.removeChild(progressDiv);
              alert('Failed to save travel location: ' + (data.error || 'Unknown error'));
            }
          }
        );
      } catch (error) {
        console.error('Error traveling:', error);
        document.body.removeChild(progressDiv);
        alert('Failed to travel. Check console for details.');
      }
    };

    // ========================================
    // Breadcrumb Navigation System
    // ========================================
    window.updateBreadcrumb = function(level, galaxyName, starName) {
      const breadcrumb = document.getElementById('breadcrumbNav');
      if (!breadcrumb) return;

      // Clear current breadcrumb (except [LOCATION] label)
      breadcrumb.innerHTML = '<span style="color: #666; font-size: 10px;">[LOCATION]</span>';

      const separator = '<span style="color: #444; margin: 0 3px; font-size: 10px;">‚Ä∫</span>';

      // Universe level (always present)
      const universeSpan = document.createElement('span');
      universeSpan.className = 'breadcrumb-item';
      universeSpan.textContent = 'UNIVERSE';
      universeSpan.style.cssText = `
        color: ${level === 'universe' ? '#00ff00' : '#888'};
        cursor: pointer;
        padding: 3px 8px;
        border-radius: 6px;
        transition: all 0.2s;
        font-size: 11px;
        ${level === 'universe' ? 'background: rgba(0, 255, 0, 0.1);' : ''}
      `;
      universeSpan.onclick = () => {
        if (window.galacticMap) {
          window.galacticMap.showUniverseLevel();
        }
      };
      universeSpan.onmouseenter = function() {
        if (level !== 'universe') this.style.background = 'rgba(136, 136, 136, 0.1)';
      };
      universeSpan.onmouseleave = function() {
        if (level !== 'universe') this.style.background = 'transparent';
      };
      breadcrumb.appendChild(universeSpan);

      // Galaxy level
      if (level === 'galaxy' || level === 'system') {
        breadcrumb.innerHTML += separator;

        const galaxySpan = document.createElement('span');
        galaxySpan.className = 'breadcrumb-item';
        galaxySpan.textContent = galaxyName || 'GALAXY';
        galaxySpan.style.cssText = `
          color: ${level === 'galaxy' ? '#00ff00' : '#888'};
          cursor: pointer;
          padding: 3px 8px;
          border-radius: 6px;
          transition: all 0.2s;
          font-size: 11px;
          ${level === 'galaxy' ? 'background: rgba(0, 255, 0, 0.1);' : ''}
        `;
        galaxySpan.onclick = () => {
          if (window.galacticMap && window.galacticMap.selectedGalaxyId) {
            window.galacticMap.showGalaxyLevel(window.galacticMap.selectedGalaxyId);
          }
        };
        galaxySpan.onmouseenter = function() {
          if (level !== 'galaxy') this.style.background = 'rgba(136, 136, 136, 0.1)';
        };
        galaxySpan.onmouseleave = function() {
          if (level !== 'galaxy') this.style.background = 'transparent';
        };
        breadcrumb.appendChild(galaxySpan);
      }

      // Star system level
      if (level === 'system') {
        breadcrumb.innerHTML += separator;

        const systemSpan = document.createElement('span');
        systemSpan.className = 'breadcrumb-item';
        systemSpan.textContent = starName || 'SYSTEM';
        systemSpan.style.cssText = `
          color: #00ff00;
          padding: 3px 8px;
          border-radius: 6px;
          background: rgba(0, 255, 0, 0.1);
          font-size: 11px;
        `;
        breadcrumb.appendChild(systemSpan);
      }
    };

    // Override showGalaxyLevel to update breadcrumb
    const originalShowGalaxyLevel = window.galacticMap?.showGalaxyLevel?.bind(window.galacticMap);
    if (originalShowGalaxyLevel) {
      window.galacticMap.showGalaxyLevel = function(galaxyId) {
        originalShowGalaxyLevel(galaxyId);

        // Get galaxy name
        const galaxy = this.allAssets?.find(a => a._id === galaxyId);
        const galaxyName = galaxy?.title || 'GALAXY';

        window.updateBreadcrumb('galaxy', galaxyName);
      };
    }

    // Override showSystemLevel to update breadcrumb
    const originalShowSystemLevel = window.galacticMap?.showSystemLevel?.bind(window.galacticMap);
    if (originalShowSystemLevel) {
      window.galacticMap.showSystemLevel = function(starId) {
        originalShowSystemLevel(starId);

        // Get star and galaxy names
        const star = this.allAssets?.find(a => a._id === starId);
        const starName = star?.title || 'SYSTEM';

        const galaxy = this.allAssets?.find(a => a._id === this.selectedGalaxyId);
        const galaxyName = galaxy?.title || 'GALAXY';

        window.updateBreadcrumb('system', galaxyName, starName);
      };
    }

    // Override showUniverseLevel to update breadcrumb
    const originalShowUniverseLevel = window.galacticMap?.showUniverseLevel?.bind(window.galacticMap);
    if (originalShowUniverseLevel) {
      window.galacticMap.showUniverseLevel = function() {
        originalShowUniverseLevel();
        window.updateBreadcrumb('universe');
      };
    }

    // Initialize breadcrumb
    setTimeout(() => {
      window.updateBreadcrumb('universe');
    }, 100);

    // ========================================
    // Navigation Confirmation System
    // ========================================
    let pendingNavigationUrl = null;

    /**
     * Navigate with confirmation dialog
     */
    window.navigateWithConfirmation = function(url) {
      pendingNavigationUrl = url;
      const dialog = document.getElementById('navigationConfirmDialog');

      if (!dialog) {
        console.error('‚ùå navigationConfirmDialog not found! Navigating directly...');
        window.location.href = url;
        return;
      }

      // Show dialog with animation
      dialog.style.opacity = '0';
      dialog.style.pointerEvents = 'auto';

      setTimeout(() => {
        dialog.style.opacity = '1';
      }, 10);

      // Close the overlay menu
      if (window.toggleOverlayMenu) {
        window.toggleOverlayMenu();
      }

      console.log('üîî Navigation confirmation requested for:', url);
    };

    /**
     * Close confirmation dialog
     */
    window.closeNavigationDialog = function() {
      const dialog = document.getElementById('navigationConfirmDialog');

      if (!dialog) {
        console.warn('‚ö†Ô∏è navigationConfirmDialog not found when trying to close');
        pendingNavigationUrl = null;
        return;
      }

      dialog.style.opacity = '0';

      setTimeout(() => {
        dialog.style.pointerEvents = 'none';
        pendingNavigationUrl = null;
      }, 300);
    };

    // Confirm navigation button - with null check
    const confirmNavigateBtn = document.getElementById('confirmNavigateBtn');
    if (confirmNavigateBtn) {
      confirmNavigateBtn.addEventListener('click', () => {
        if (pendingNavigationUrl) {
          console.log('‚úÖ User confirmed navigation to:', pendingNavigationUrl);
          window.location.href = pendingNavigationUrl;
        }
      });
    } else {
      console.warn('‚ö†Ô∏è confirmNavigateBtn not found in DOM');
    }

    // Cancel navigation button - with null check
    const cancelNavigateBtn = document.getElementById('cancelNavigateBtn');
    if (cancelNavigateBtn) {
      cancelNavigateBtn.addEventListener('click', () => {
        console.log('‚ùå User cancelled navigation');
        window.closeNavigationDialog();
      });
    } else {
      console.warn('‚ö†Ô∏è cancelNavigateBtn not found in DOM');
    }

    // ESC key to close dialog
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const dialog = document.getElementById('navigationConfirmDialog');
        if (dialog && dialog.style.pointerEvents === 'auto') {
          window.closeNavigationDialog();
        }
      }
    });

    // Add hover effects to confirmation buttons - with null checks
    const confirmBtn = document.getElementById('confirmNavigateBtn');
    const cancelBtn = document.getElementById('cancelNavigateBtn');

    if (confirmBtn) {
      confirmBtn.addEventListener('mouseenter', () => {
        confirmBtn.style.background = 'linear-gradient(135deg, rgba(255, 102, 0, 0.5), rgba(255, 68, 0, 0.5))';
        confirmBtn.style.transform = 'translateY(-2px)';
        confirmBtn.style.boxShadow = '0 4px 15px rgba(255, 102, 0, 0.4)';
      });

      confirmBtn.addEventListener('mouseleave', () => {
        confirmBtn.style.background = 'linear-gradient(135deg, rgba(255, 102, 0, 0.3), rgba(255, 68, 0, 0.3))';
        confirmBtn.style.transform = 'translateY(0)';
        confirmBtn.style.boxShadow = 'none';
      });
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('mouseenter', () => {
        cancelBtn.style.background = 'linear-gradient(135deg, rgba(138, 79, 255, 0.5), rgba(74, 158, 255, 0.5))';
        cancelBtn.style.transform = 'translateY(-2px)';
        cancelBtn.style.boxShadow = '0 4px 15px rgba(138, 79, 255, 0.4)';
      });

      cancelBtn.addEventListener('mouseleave', () => {
        cancelBtn.style.background = 'linear-gradient(135deg, rgba(138, 79, 255, 0.3), rgba(74, 158, 255, 0.3))';
        cancelBtn.style.transform = 'translateY(0)';
        cancelBtn.style.boxShadow = 'none';
      });
    }

    // Add hover effects to menu items
    const menuItems = document.querySelectorAll('.overlay-menu-item');
    menuItems.forEach(item => {
      item.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(138, 79, 255, 0.15)';
        this.style.transform = 'translateX(5px)';
      });

      item.addEventListener('mouseleave', function() {
        this.style.background = 'transparent';
        this.style.transform = 'translateX(0)';
      });
    });

    // Verify all navigation elements are present
    const navDialog = document.getElementById('navigationConfirmDialog');
    const overlayMenu = document.getElementById('overlayMenu');
    const overlayBackdrop = document.getElementById('overlayBackdrop');

    console.log('‚úÖ Navigation confirmation system initialized');
    console.log('   üìã Dialog:', navDialog ? '‚úì' : '‚úó');
    console.log('   üìã Confirm Button:', confirmBtn ? '‚úì' : '‚úó');
    console.log('   üìã Cancel Button:', cancelBtn ? '‚úì' : '‚úó');
    console.log('   üìã Overlay Menu:', overlayMenu ? '‚úì' : '‚úó');
    console.log('   üìã Overlay Backdrop:', overlayBackdrop ? '‚úì' : '‚úó');
    console.log('   üìã Menu Items:', menuItems.length);

    // ========================================
    // LIVE UNIVERSE STATE INTEGRATION
    // ========================================

    /**
     * Live Universe State Manager
     * Connects to game-state-service for real-time universe simulation
     */
    class LiveUniverseManager {
      constructor() {
        this.gameStateUrl = 'http://localhost:3500';
        this.eventSource = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 10;
        this.reconnectDelay = 3000;
        this.isConnected = false;

        // State data
        this.galacticState = null;
        this.factions = null;
        this.events = [];
        this.resources = null;

        // UI elements
        this.statusIndicator = null;
        this.eventFeed = null;
        this.factionPanel = null;

        this.init();
      }

      init() {
        console.log('üåå Initializing Live Universe Manager...');
        this.createUI();
        this.connectToGameState();
      }

      createUI() {
        // Create status indicator
        this.statusIndicator = document.createElement('div');
        this.statusIndicator.id = 'liveUniverseStatus';
        this.statusIndicator.style.cssText = `
          position: fixed;
          bottom: 20px;
          left: 20px;
          background: rgba(0, 0, 0, 0.9);
          border: 2px solid #ff6600;
          border-radius: 8px;
          padding: 10px 15px;
          color: #ff6600;
          font-family: 'Courier New', monospace;
          font-size: 11px;
          z-index: 1000;
          display: flex;
          align-items: center;
          gap: 8px;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        `;
        this.statusIndicator.innerHTML = '<span id="statusDot" style="width: 8px; height: 8px; border-radius: 50%; background: #ff6600; animation: pulse 2s infinite;"></span><span id="statusText">Connecting to Universe...</span>';
        document.body.appendChild(this.statusIndicator);

        // Add pulse animation
        const style = document.createElement('style');
        style.textContent = `
          @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
          }
          @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);

        // Create live event feed
        this.eventFeed = document.createElement('div');
        this.eventFeed.id = 'liveEventFeed';
        this.eventFeed.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          width: 320px;
          max-height: 400px;
          background: rgba(0, 0, 0, 0.95);
          border: 2px solid #00ff9f;
          border-radius: 8px;
          padding: 15px;
          color: #00ff9f;
          font-family: 'Courier New', monospace;
          font-size: 10px;
          z-index: 999;
          overflow-y: auto;
          backdrop-filter: blur(10px);
          box-shadow: 0 0 30px rgba(0, 255, 159, 0.3);
        `;
        this.eventFeed.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid rgba(0, 255, 159, 0.3); padding-bottom: 8px;">
            <h3 style="margin: 0; font-size: 12px; color: #00ff9f;">üì° LIVE EVENTS</h3>
            <div id="galacticCycle" style="font-size: 10px; color: #00ff9f; opacity: 0.7;">Cycle: ---</div>
          </div>
          <div id="eventList" style="display: flex; flex-direction: column; gap: 8px;"></div>
        `;
        document.body.appendChild(this.eventFeed);

        // Create faction status panel
        this.factionPanel = document.createElement('div');
        this.factionPanel.id = 'liveFactionPanel';
        this.factionPanel.style.cssText = `
          position: fixed;
          bottom: 70px;
          left: 20px;
          width: 300px;
          background: rgba(0, 0, 0, 0.95);
          border: 2px solid #8a4fff;
          border-radius: 8px;
          padding: 15px;
          color: #8a4fff;
          font-family: 'Courier New', monospace;
          font-size: 10px;
          z-index: 999;
          backdrop-filter: blur(10px);
          box-shadow: 0 0 30px rgba(138, 79, 255, 0.3);
        `;
        this.factionPanel.innerHTML = `
          <h3 style="margin: 0 0 10px 0; font-size: 12px; color: #8a4fff; border-bottom: 1px solid rgba(138, 79, 255, 0.3); padding-bottom: 5px;">‚öîÔ∏è FACTION POWER</h3>
          <div id="factionBars"></div>
        `;
        document.body.appendChild(this.factionPanel);
      }

      connectToGameState() {
        if (this.eventSource) {
          this.eventSource.close();
        }

        console.log('üì° Connecting to Game State Service...');
        this.updateStatus('Connecting...', '#ff6600');

        try {
          // Connect to SSE stream
          this.eventSource = new EventSource(`${this.gameStateUrl}/api/stream/state`);

          this.eventSource.onopen = () => {
            console.log('‚úÖ Connected to Game State Service');
            this.isConnected = true;
            this.reconnectAttempts = 0;
            this.updateStatus('LIVE', '#00ff00');
          };

          this.eventSource.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              this.handleStateUpdate(data);
            } catch (error) {
              console.error('‚ùå Error parsing state update:', error);
            }
          };

          this.eventSource.onerror = (error) => {
            console.error('‚ùå Game State connection error:', error);
            this.isConnected = false;
            this.updateStatus('Disconnected', '#ff0000');
            this.eventSource.close();
            this.attemptReconnect();
          };

          // Also connect to event stream
          this.connectToEventStream();

        } catch (error) {
          console.error('‚ùå Failed to connect to Game State Service:', error);
          this.updateStatus('Error', '#ff0000');
          this.attemptReconnect();
        }
      }

      connectToEventStream() {
        const eventStream = new EventSource(`${this.gameStateUrl}/api/stream/events`);

        eventStream.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'event' && data.event) {
              this.addEvent(data.event);
            } else if (data.type === 'init' && data.events) {
              this.events = data.events;
              this.updateEventFeed();
            }
          } catch (error) {
            console.error('‚ùå Error parsing event:', error);
          }
        };
      }

      attemptReconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
          console.error('‚ùå Max reconnection attempts reached');
          this.updateStatus('Failed', '#ff0000');
          return;
        }

        this.reconnectAttempts++;
        const delay = this.reconnectDelay * this.reconnectAttempts;

        console.log(`üîÑ Reconnecting in ${delay/1000}s (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
        this.updateStatus(`Retry ${this.reconnectAttempts}...`, '#ffaa00');

        setTimeout(() => {
          this.connectToGameState();
        }, delay);
      }

      handleStateUpdate(data) {
        if (data.type === 'init') {
          console.log('üì¶ Received initial state:', data.state);
          this.galacticState = data.state.galactic;
          this.factions = data.state.factions;
          this.resources = data.state.resources;
          this.events = data.state.events || [];

          this.updateAllUI();
        } else if (data.type === 'update') {
          console.log('üîÑ Received state update');

          if (data.galactic) this.galacticState = data.galactic;
          if (data.factions) this.factions = data.factions;
          if (data.resources) this.resources = data.resources;

          this.updateAllUI();
        }
      }

      updateAllUI() {
        this.updateGalacticInfo();
        this.updateFactionBars();
        this.updateEventFeed();
      }

      updateGalacticInfo() {
        if (!this.galacticState) return;

        const cycleEl = document.getElementById('galacticCycle');
        if (cycleEl) {
          cycleEl.textContent = `Cycle: ${this.galacticState.cycle} | Year: ${this.galacticState.year}`;
        }
      }

      updateFactionBars() {
        if (!this.factions) return;

        const barsContainer = document.getElementById('factionBars');
        if (!barsContainer) return;

        barsContainer.innerHTML = '';

        // Sort factions by power
        const sortedFactions = Object.entries(this.factions)
          .sort((a, b) => b[1].power - a[1].power);

        sortedFactions.forEach(([name, data]) => {
          const factionEl = document.createElement('div');
          factionEl.style.marginBottom = '8px';

          const power = Math.round(data.power);
          const color = this.getFactionColor(name);

          factionEl.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 9px;">
              <span style="color: ${color};">${name}</span>
              <span style="color: #fff; font-weight: bold;">${power}%</span>
            </div>
            <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
              <div style="width: ${power}%; height: 100%; background: linear-gradient(90deg, ${color}, ${this.lightenColor(color)}); transition: width 0.5s ease;"></div>
            </div>
          `;

          barsContainer.appendChild(factionEl);
        });
      }

      updateEventFeed() {
        const eventList = document.getElementById('eventList');
        if (!eventList || !this.events) return;

        eventList.innerHTML = '';

        // Show last 5 events
        const recentEvents = this.events.slice(0, 5);

        recentEvents.forEach((event, index) => {
          const eventEl = document.createElement('div');
          eventEl.style.cssText = `
            padding: 8px;
            background: rgba(0, 255, 159, 0.05);
            border-left: 3px solid ${this.getEventColor(event.severity)};
            border-radius: 4px;
            font-size: 10px;
            animation: slideIn 0.3s ease forwards;
            animation-delay: ${index * 0.1}s;
            opacity: 0;
          `;

          const icon = this.getEventIcon(event.type);
          const time = new Date(event.timestamp).toLocaleTimeString();

          eventEl.innerHTML = `
            <div style="display: flex; justify-content: between; align-items: start; gap: 8px;">
              <span style="font-size: 14px;">${icon}</span>
              <div style="flex: 1;">
                <div style="color: ${this.getEventColor(event.severity)}; margin-bottom: 3px; font-weight: bold;">
                  ${event.type.toUpperCase()} [${event.severity.toUpperCase()}]
                </div>
                <div style="color: #00ff9f; line-height: 1.4;">${event.message}</div>
                <div style="color: #00ff9f; opacity: 0.5; font-size: 8px; margin-top: 3px;">${time}</div>
              </div>
            </div>
          `;

          eventList.appendChild(eventEl);
        });
      }

      addEvent(event) {
        this.events.unshift(event);
        if (this.events.length > 20) {
          this.events = this.events.slice(0, 20);
        }
        this.updateEventFeed();

        // Show toast notification for high severity events
        if (event.severity === 'high') {
          this.showToast(event);
        }
      }

      showToast(event) {
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 100px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 0, 0, 0.9);
          border: 2px solid #ff0000;
          border-radius: 8px;
          padding: 15px 20px;
          color: #fff;
          font-family: 'Courier New', monospace;
          font-size: 12px;
          z-index: 10000;
          box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
          animation: slideIn 0.3s ease;
        `;
        toast.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è ALERT: ${event.type.toUpperCase()}</div>
          <div>${event.message}</div>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(-50%) translateY(-20px)';
          toast.style.transition = 'all 0.3s ease';
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 5000);
      }

      updateStatus(text, color) {
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        if (statusText) statusText.textContent = text;
        if (statusDot) statusDot.style.background = color;
        if (this.statusIndicator) this.statusIndicator.style.borderColor = color;
      }

      getFactionColor(name) {
        const colors = {
          'Silicate Consortium': '#8a4fff',
          'Lantern Collective': '#00ff9f',
          'Devan Empire': '#ff6600',
          'Human Federation': '#00aaff',
          'Independent Systems': '#ffaa00'
        };
        return colors[name] || '#ffffff';
      }

      lightenColor(color) {
        // Simple color lightening
        const r = parseInt(color.slice(1,3), 16);
        const g = parseInt(color.slice(3,5), 16);
        const b = parseInt(color.slice(5,7), 16);
        return `rgb(${Math.min(255, r + 40)}, ${Math.min(255, g + 40)}, ${Math.min(255, b + 40)})`;
      }

      getEventColor(severity) {
        const colors = {
          'low': '#00ff9f',
          'medium': '#ffaa00',
          'high': '#ff0000'
        };
        return colors[severity] || '#ffffff';
      }

      getEventIcon(type) {
        const icons = {
          'discovery': 'üî≠',
          'conflict': '‚öîÔ∏è',
          'economic': 'üí∞',
          'environmental': 'üå™Ô∏è'
        };
        return icons[type] || 'üì°';
      }

      disconnect() {
        if (this.eventSource) {
          this.eventSource.close();
          this.isConnected = false;
          this.updateStatus('Disconnected', '#ff0000');
        }
      }
    }

    // Initialize Live Universe Manager
    let liveUniverse = null;

    // Wait for map to be ready, then start live universe
    setTimeout(() => {
      console.log('üåå Starting Live Universe Integration...');
      liveUniverse = new LiveUniverseManager();

      // Store globally for debugging
      window.liveUniverse = liveUniverse;
    }, 2000);

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (liveUniverse) {
        liveUniverse.disconnect();
      }
    });

    console.log('‚úÖ Live Universe system loaded');
  </script>
</body>
</html>

<!-- Emergency socket listener - runs independently -->
<script>
(function() {
  console.log('üö® EMERGENCY SOCKET LISTENER INITIALIZING...');

  // Wait for map object and io to be available
  function waitForMap(callback, attempts = 0) {
    if (attempts > 30) {
      console.error('‚ùå Gave up waiting for map after 30 attempts');
      return;
    }

    if (window.galacticMap && typeof io !== 'undefined') {
      console.log('‚úÖ Map and Socket.IO available!');
      console.log('   Map object:', !!window.galacticMap);
      console.log('   Assets Map exists:', !!window.galacticMap.assets);
      console.log('   Assets Map type:', window.galacticMap.assets ? window.galacticMap.assets.constructor.name : 'N/A');
      console.log('   Current assets count:', window.galacticMap.assets ? window.galacticMap.assets.size : 'N/A');
      console.log('   Scene children:', window.galacticMap.assetsGroup ? window.galacticMap.assetsGroup.children.length : 'N/A');
      callback();
    } else {
      console.log('‚è≥ Waiting attempt ' + (attempts + 1) + ': map=' + !!window.galacticMap + ', io=' + (typeof io !== 'undefined'));
      setTimeout(() => waitForMap(callback, attempts + 1), 200);
    }
  }

  waitForMap(() => {
    console.log('üîå Setting up emergency socket connection...');

    const socket = io();

    socket.on('connect', () => {
      console.log('‚úÖ‚úÖ‚úÖ EMERGENCY SOCKET CONNECTED! ID:', socket.id);
      console.log('   Assets currently in map:', window.galacticMap.assets.size);
      if (window.galacticMap.assets.size > 0) {
        console.log('   First 5 asset IDs:', Array.from(window.galacticMap.assets.keys()).slice(0, 5));
      }
    });

    socket.on('galacticPhysicsUpdate', (data) => {
      // Only update physics when at galactic/universe overview levels, NOT when viewing galaxy/system interiors
      if (window.galacticMap.currentLevel === 'galaxy' || window.galacticMap.currentLevel === 'system') {
        console.log('üåå Physics update skipped - viewing interior (current: ' + window.galacticMap.currentLevel + ')');
        return;
      }

      // Physics update logging disabled - too spammy
      // console.log('üååüååüåå PHYSICS UPDATE RECEIVED! ' + data.galaxies.length + ' galaxies');

      if (window.galacticMap.assets.size === 0) {
        console.warn('   ‚ö†Ô∏è Assets map is empty! Assets may not be loaded yet.');
        return;
      }

      let updated = 0;
      data.galaxies.forEach(g => {
        const asset = window.galacticMap.assets.get(g.id);
        if (asset && asset.mesh) {
          const oldPos = asset.mesh.position.clone();
          asset.mesh.position.set(g.position.x, g.position.y, g.position.z);

          // Force update flags
          asset.mesh.updateMatrixWorld(true);

          const distance = oldPos.distanceTo(asset.mesh.position);
          updated++;
          // console.log('   ‚úÖ ' + g.id.substring(0,8) + ': (' + g.position.x.toFixed(0) + ', ' + g.position.y.toFixed(0) + ', ' + g.position.z.toFixed(0) + ') moved ' + distance.toFixed(1) + ' units');
        } else {
          console.warn('   ‚ùå ' + g.id.substring(0,12) + ' not in map! Available IDs:', Array.from(window.galacticMap.assets.keys()).slice(0, 3).join(', '));
        }
      });

      // Update connection lines for all moved assets
      if (window.galacticMap && window.galacticMap.updateConnectionsForAsset) {
        data.galaxies.forEach(g => {
          window.galacticMap.updateConnectionsForAsset(g.id);
        });
      }

      // Force a render after updating positions
      if (window.galacticMap && window.galacticMap.renderer && window.galacticMap.scene && window.galacticMap.camera) {
        window.galacticMap.renderer.render(window.galacticMap.scene, window.galacticMap.camera);
      }

      // console.log('   Updated ' + updated + '/' + data.galaxies.length + ' positions, updated connections, and forced render.');
    });

    window.emergencySocket = socket;
    console.log('‚úÖ Emergency socket listener ready!');
  });
})();
</script>

<!-- Daily MOTD Lightbox -->
<% if (user) { %>
  <%- include('../partials/daily-motd-lightbox') %>
<% } %>
