<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - 3D View</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="/stylesheets/galactic-map.css">
  <link rel="stylesheet" href="/stylesheets/activity-monitor.css">
  <link rel="stylesheet" href="/stylesheets/global-chat.css">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Courier New', monospace;
      background: #000;
    }

    /* Show header on this page */
    header {
      display: block !important;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    nav.navbar {
      display: flex !important;
    }

    /* Info Pane Styles REMOVED - Direct navigation instead */

    #mapContainer {
      width: 100vw;
      height: calc(100vh - 60px);
      margin-top: 60px;
      position: relative;
    }

    /* Info Overlay */
    .info-overlay {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 20, 40, 0.9);
      border: 2px solid #00ffaa;
      border-radius: 8px;
      padding: 15px 20px;
      color: #00ffaa;
      font-size: 14px;
      z-index: 100;
      min-width: 250px;
      backdrop-filter: blur(10px);
    }

    .info-overlay h2 {
      margin: 0 0 10px 0;
      font-size: 18px;
      color: #ffaa00;
      text-shadow: 0 0 10px #ffaa00;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      padding: 3px 0;
      border-bottom: 1px solid rgba(0, 255, 170, 0.2);
    }

    .info-label {
      color: #66ccff;
    }

    .info-value {
      color: #ffffff;
      font-weight: bold;
    }

    /* Control Instructions */
    .controls-overlay {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 20, 40, 0.9);
      border: 2px solid #4488ff;
      border-radius: 8px;
      padding: 15px 20px;
      color: #4488ff;
      font-size: 12px;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .controls-overlay h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #ffaa00;
    }

    .controls-overlay p {
      margin: 5px 0;
      color: #aaccff;
    }

    .controls-overlay kbd {
      background: rgba(100, 150, 255, 0.3);
      padding: 2px 6px;
      border-radius: 3px;
      border: 1px solid #4488ff;
      color: #ffffff;
    }

    /* Selected Asset Panel */
    .selected-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 20, 40, 0.95);
      border: 2px solid #ff6600;
      border-radius: 8px;
      padding: 15px 20px;
      color: #ffffff;
      font-size: 13px;
      z-index: 100;
      min-width: 300px;
      max-width: 400px;
      display: none;
      backdrop-filter: blur(10px);
    }

    .selected-panel.visible {
      display: block;
    }

    .selected-panel h2 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #ff6600;
      text-shadow: 0 0 10px #ff6600;
    }

    .selected-panel .asset-type {
      display: inline-block;
      background: rgba(255, 102, 0, 0.3);
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 11px;
      text-transform: uppercase;
      margin-bottom: 10px;
      border: 1px solid #ff6600;
    }

    /* Toggle Button */
    .view-toggle {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(138, 79, 255, 0.9);
      border: 2px solid #8a4fff;
      border-radius: 20px;
      padding: 10px 20px;
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s;
      text-decoration: none;
      backdrop-filter: blur(10px);
    }

    .view-toggle:hover {
      background: rgba(138, 79, 255, 1);
      box-shadow: 0 0 20px rgba(138, 79, 255, 0.8);
      transform: translateX(-50%) scale(1.05);
    }

    .back-button {
      background: rgba(255, 100, 100, 0.8);
      border: 2px solid #ff6644;
      color: #fff;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      font-size: 13px;
    }

    .back-button:hover {
      background: rgba(255, 100, 100, 1);
      box-shadow: 0 0 15px rgba(255, 100, 100, 0.6);
      transform: scale(1.05);
    }

    .back-button:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Legend */
    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 20, 40, 0.9);
      border: 2px solid #00ffaa;
      border-radius: 8px;
      padding: 15px;
      color: #ffffff;
      font-size: 12px;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .legend h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #ffaa00;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Overlay Menu Active States */
    .overlay-menu.active {
      right: 0 !important;
    }

    .overlay-backdrop.active {
      opacity: 1 !important;
      pointer-events: auto !important;
    }

    /* Overlay menu hover effects */
    .overlay-menu-item:hover {
      background: rgba(138, 79, 255, 0.15) !important;
      border-left: 3px solid #8a4fff !important;
      padding-left: 17px !important;
    }

    .overlay-menu-item.admin-item:hover {
      background: rgba(255, 100, 100, 0.15) !important;
      border-left: 3px solid #ff6464 !important;
    }

    /* Loading Spinner - Left of Breadcrumb */
    .loading-spinner {
      position: fixed;
      top: 43px;
      right: 380px;
      z-index: 95;
      display: none; /* Hidden by default */
      width: 18px;
      height: 18px;
      border: 2px solid rgba(0, 255, 170, 0.2);
      border-top: 2px solid #00ffaa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-spinner.active {
      display: block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Location Info Display - Below Breadcrumb */
    .location-info {
      position: fixed;
      top: 70px;
      right: 20px;
      z-index: 90;
      font-family: 'Courier New', monospace;
      text-align: right;
      pointer-events: none;
      user-select: none;
    }

    .location-name {
      font-size: 16px;
      font-weight: bold;
      color: #00ffaa;
      text-shadow: 0 0 8px rgba(0, 255, 170, 0.5);
      margin: 0;
      padding: 0;
      line-height: 1.2;
    }

    .location-children {
      font-size: 10px;
      color: #888;
      margin-top: 4px;
      padding: 0;
      line-height: 1.3;
    }

    .location-children span {
      margin-right: 8px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .loading-spinner {
        top: 58px;
        right: 200px;
        width: 14px;
        height: 14px;
      }

      .location-info {
        top: 85px;
        right: 10px;
      }

      .location-name {
        font-size: 13px;
      }

      .location-children {
        font-size: 9px;
      }
    }

    @media (max-width: 480px) {
      .loading-spinner {
        right: 150px;
      }

      .location-name {
        font-size: 11px;
      }

      .location-children {
        font-size: 8px;
      }
    }
  </style>
</head>
<body>
  <%- include('../partials/header', { user: user }) %>
  <%- include('../partials/breadcrumb-nav', { currentView: 'galactic' }) %>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="loading-spinner"></div>

  <!-- Location Info Display -->
  <div class="location-info">
    <div id="locationName" class="location-name">UNIVERSE</div>
    <div id="locationChildren" class="location-children">Loading assets...</div>
  </div>

  <!-- Main Map Container -->
  <div id="mapContainer"></div>

  <!-- Floating HUD Info (appears next to hovered stars) -->
  <div id="floatingHUD" style="
    position: fixed;
    display: none;
    z-index: 9999;
    pointer-events: none;
    font-family: 'Courier New', monospace;
    font-size: 10px;
    min-width: 180px;
    max-width: 240px;
  ">
    <div style="
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid #00ff00;
      border-radius: 3px;
      padding: 10px;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.3),
                  inset 0 0 15px rgba(0, 255, 0, 0.05);
    ">
      <div style="color: #00ff00; font-weight: bold; margin-bottom: 6px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;" id="hudTitle">
        [STAR]
      </div>
      <div style="color: #00ff00; opacity: 0.7; margin-bottom: 3px; font-size: 9px;" id="hudType">
        TYPE: UNKNOWN
      </div>
      <div style="color: #00ff00; opacity: 0.7; margin-bottom: 3px; font-size: 9px;" id="hudCoords">
        COORDS: [0, 0, 0]
      </div>
      <div style="color: #00ff00; opacity: 0.85; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(0, 255, 0, 0.25); font-size: 9px;">
        <div style="margin-bottom: 2px;" id="hudPlanets">
          PLANETS: 0
        </div>
        <div style="margin-bottom: 2px;" id="hudStations">
          STATIONS: 0
        </div>
        <div style="margin-bottom: 2px;" id="hudShips">
          SHIPS: 0
        </div>
        <div id="hudTotal">
          TOTAL: 0
        </div>
      </div>
    </div>
  </div>

  <!-- HUD Connection Line Canvas -->
  <canvas id="hudLineCanvas" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9998;
    display: none;
  "></canvas>

  <!-- Inline Script: Define UI functions IMMEDIATELY BEFORE HTML -->
  <script>
    // CRITICAL: Define these functions BEFORE any onclick handlers try to use them

    // ========================================
    // Loading Spinner & Location Info System
    // DEFINED EARLY so they're available everywhere
    // ========================================

    /**
     * Show loading spinner
     */
    window.showLoadingSpinner = function() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.classList.add('active');
        console.log('üîÑ Loading spinner shown');
      }
    };

    /**
     * Hide loading spinner
     */
    window.hideLoadingSpinner = function() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) {
        spinner.classList.remove('active');
        console.log('‚úÖ Loading spinner hidden');
      }
    };

    /**
     * Update location info display
     * @param {string} name - Location name
     * @param {string} childrenText - Children assets text
     */
    window.updateLocationInfo = function(name, childrenText) {
      const locationName = document.getElementById('locationName');
      const locationChildren = document.getElementById('locationChildren');

      console.log('üìç Updating location:', name, '|', childrenText);

      if (locationName) {
        locationName.textContent = name || 'UNKNOWN';
      }

      if (locationChildren) {
        locationChildren.innerHTML = childrenText || '';
      }
    };

    /**
     * Count assets by type in current view
     */
    window.getAssetCounts = function() {
      if (!window.galacticMap?.allAssets) return {};

      const counts = {
        localGroups: 0,
        galaxies: 0,
        anomalies: 0,
        stars: 0,
        planets: 0,
        moons: 0
      };

      window.galacticMap.allAssets.forEach(asset => {
        if (asset.assetType === 'localGroup') counts.localGroups++;
        else if (asset.assetType === 'galaxy') counts.galaxies++;
        else if (asset.assetType === 'anomaly') counts.anomalies++;
        else if (asset.assetType === 'star') counts.stars++;
        else if (asset.assetType === 'planet') counts.planets++;
        else if (asset.assetType === 'moon') counts.moons++;
      });

      return counts;
    };

    /**
     * Setup view override functions
     * MUST be called BEFORE any showUniverseLevel/showGalaxyLevel/showSystemLevel calls
     */
    window.setupViewOverrides = function() {
      if (!window.galacticMap) {
        console.warn('‚ö†Ô∏è Cannot setup view overrides: galacticMap not found');
        return;
      }

      console.log('üîß Setting up view overrides...');

      // Override showGalaxyLevel to update breadcrumb and location info
      const originalShowGalaxyLevel = window.galacticMap.showGalaxyLevel?.bind(window.galacticMap);
      if (originalShowGalaxyLevel) {
        window.galacticMap.showGalaxyLevel = function(galaxyId) {
          originalShowGalaxyLevel(galaxyId);

          // Get galaxy name
          const galaxy = this.allAssets?.find(a => a._id === galaxyId);
          const galaxyName = galaxy?.title || 'GALAXY';

          // Count stars and anomalies in this galaxy
          const starsInGalaxy = this.allAssets?.filter(a =>
            a.assetType === 'star' && a.parentGalaxy === galaxyId
          ).length || 0;

          const anomaliesInGalaxy = this.allAssets?.filter(a =>
            a.assetType === 'anomaly' && a.parentGalaxy === galaxyId
          ).length || 0;

          // Build children text
          const childrenParts = [];
          if (starsInGalaxy > 0) childrenParts.push(`${starsInGalaxy} star${starsInGalaxy !== 1 ? 's' : ''}`);
          if (anomaliesInGalaxy > 0) childrenParts.push(`${anomaliesInGalaxy} anomal${anomaliesInGalaxy !== 1 ? 'ies' : 'y'}`);
          const childrenText = childrenParts.join(' ‚Ä¢ ') || 'No child assets';

          window.updateBreadcrumb && window.updateBreadcrumb('galaxy', galaxyName);
          window.updateLocationInfo(galaxyName.toUpperCase(), childrenText);
        };
      }

      // Override showSystemLevel to update breadcrumb and location info
      const originalShowSystemLevel = window.galacticMap.showSystemLevel?.bind(window.galacticMap);
      if (originalShowSystemLevel) {
        window.galacticMap.showSystemLevel = function(starId) {
          originalShowSystemLevel(starId);

          // Get star and galaxy names
          const star = this.allAssets?.find(a => a._id === starId);
          const starName = star?.title || 'SYSTEM';

          const galaxy = this.allAssets?.find(a => a._id === this.selectedGalaxyId);
          const galaxyName = galaxy?.title || 'GALAXY';

          // Count planets and moons in this system
          const planetsInSystem = this.allAssets?.filter(a =>
            a.assetType === 'planet' && a.parentStar === starId
          ).length || 0;

          const moonsInSystem = this.allAssets?.filter(a =>
            a.assetType === 'moon' && a.parentStar === starId
          ).length || 0;

          // Build children text
          const childrenParts = [];
          if (planetsInSystem > 0) childrenParts.push(`${planetsInSystem} planet${planetsInSystem !== 1 ? 's' : ''}`);
          if (moonsInSystem > 0) childrenParts.push(`${moonsInSystem} moon${moonsInSystem !== 1 ? 's' : ''}`);
          const childrenText = childrenParts.join(' ‚Ä¢ ') || 'No child assets';

          window.updateBreadcrumb && window.updateBreadcrumb('system', galaxyName, starName);
          window.updateLocationInfo(starName.toUpperCase(), childrenText);
        };
      }

      // Override showGalacticLevel to update breadcrumb and location info
      const originalShowGalacticLevel = window.galacticMap.showGalacticLevel?.bind(window.galacticMap);
      if (originalShowGalacticLevel) {
        window.galacticMap.showGalacticLevel = function() {
          originalShowGalacticLevel();

          console.log('üåå showGalacticLevel called - allAssets:', this.allAssets?.length);

          // Count all galaxies, stars, and anomalies at galactic level
          const galaxiesCount = this.allAssets?.filter(a => a.assetType === 'galaxy').length || 0;
          const starsCount = this.allAssets?.filter(a => a.assetType === 'star').length || 0;
          const anomaliesCount = this.allAssets?.filter(a => a.assetType === 'anomaly').length || 0;

          // Build children text
          const childrenParts = [];
          if (galaxiesCount > 0) childrenParts.push(`${galaxiesCount} gala${galaxiesCount !== 1 ? 'xies' : 'xy'}`);
          if (starsCount > 0) childrenParts.push(`${starsCount} star${starsCount !== 1 ? 's' : ''}`);
          if (anomaliesCount > 0) childrenParts.push(`${anomaliesCount} anomal${anomaliesCount !== 1 ? 'ies' : 'y'}`);
          const childrenText = childrenParts.join(' ‚Ä¢ ') || 'No assets loaded';

          console.log('üìç Will update location to: GALACTIC |', childrenText);
          window.updateBreadcrumb && window.updateBreadcrumb('galactic');
          window.updateLocationInfo('GALACTIC', childrenText);
        };
      }

      // Override showUniverseLevel to update breadcrumb and location info (FUTURE FEATURE)
      const originalShowUniverseLevel = window.galacticMap.showUniverseLevel?.bind(window.galacticMap);
      if (originalShowUniverseLevel) {
        window.galacticMap.showUniverseLevel = function() {
          originalShowUniverseLevel();

          console.log('üåå showUniverseLevel called - allAssets:', this.allAssets?.length);

          // Check if there's a Local Group asset
          const localGroup = this.allAssets?.find(a => a.assetType === 'localGroup');
          const locationName = localGroup ? `Local Group: ${localGroup.title}` : 'UNIVERSE';

          // Count all galaxies and anomalies at universe level
          const galaxiesCount = this.allAssets?.filter(a => a.assetType === 'galaxy').length || 0;
          const anomaliesCount = this.allAssets?.filter(a => a.assetType === 'anomaly').length || 0;

          // Build children text
          const childrenParts = [];
          if (galaxiesCount > 0) childrenParts.push(`${galaxiesCount} gala${galaxiesCount !== 1 ? 'xies' : 'xy'}`);
          if (anomaliesCount > 0) childrenParts.push(`${anomaliesCount} anomal${anomaliesCount !== 1 ? 'ies' : 'y'}`);
          const childrenText = childrenParts.join(' ‚Ä¢ ') || 'No assets loaded';

          console.log('üìç Will update location to:', locationName, '|', childrenText);
          window.updateBreadcrumb && window.updateBreadcrumb('universe');
          window.updateLocationInfo(locationName, childrenText);
        };
      }

      console.log('‚úÖ View overrides setup complete');
    };

    console.log('‚úÖ Location info and spinner functions loaded');

    // Quick access toolbar handlers
    let zenModeActive = false;

    /**
     * Toggle Overlay Menu - Define early so handleMenuToggle can call it
     */
    window.toggleOverlayMenu = function() {
      const menu = document.getElementById('overlayMenu');
      const backdrop = document.getElementById('overlayBackdrop');
      const btn = document.getElementById('toggleMenuBtn');

      const isActive = menu.classList.contains('active');

      if (isActive) {
        menu.classList.remove('active');
        backdrop.classList.remove('active');
        if (btn) btn.classList.remove('active');
      } else {
        menu.classList.add('active');
        backdrop.classList.add('active');
        if (btn) btn.classList.add('active');
      }
    };

    window.handleMenuToggle = function() {
      console.log('‚ò∞ Menu button clicked');
      // toggleOverlayMenu is defined later in this page - call it when user clicks
      window.toggleOverlayMenu();
    };

    window.handleZenToggle = function() {
      console.log('üëÅÔ∏è Zen mode clicked');
      zenModeActive = !zenModeActive;
      const zenBtn = document.getElementById('zenModeBtn');
      const hideables = document.querySelectorAll('.zen-hideable');

      if (zenModeActive) {
        hideables.forEach(el => {
          el.style.opacity = '0';
          el.style.pointerEvents = 'none';
        });
        zenBtn.style.background = 'rgba(255, 100, 100, 0.9)';
        zenBtn.style.borderColor = '#ff6464';
        zenBtn.textContent = 'üö´';
        zenBtn.title = 'Exit Zen Mode';
      } else {
        hideables.forEach(el => {
          el.style.opacity = '1';
          el.style.pointerEvents = 'auto';
        });
        zenBtn.style.background = 'rgba(100, 200, 255, 0.9)';
        zenBtn.style.borderColor = '#64c8ff';
        zenBtn.textContent = 'üëÅÔ∏è';
        zenBtn.title = 'Zen Mode';
      }
    };

    window.handleLocatePlayer = function() {
      console.log('üìç Locate player clicked');
      // This will be connected to the existing locateMeBtn handler later
      const btn = document.getElementById('locateMeBtn');
      if (btn) {
        btn.click();
      }
    };

    window.handleResetView = function() {
      console.log('‚ü≤ Reset view clicked');
      if (window.galacticMap) {
        // If we're in galaxy or system view, go back to galactic level
        if (window.galacticMap.currentLevel === 'galaxy' || window.galacticMap.currentLevel === 'system') {
          window.galacticMap.showGalacticLevel();
        } else {
          // Otherwise just reset camera position
          window.galacticMap.camera.zoom = 1;
          const center = window.galacticMap.universeCenter;
          window.galacticMap.camera.position.set(
            center.x,
            center.y + 3000,
            center.z + 2000
          );
          if (window.galacticMap.controls) {
            window.galacticMap.controls.target.copy(center);
          }
          window.galacticMap.camera.updateProjectionMatrix();
          if (window.galacticMap.controls) {
            window.galacticMap.controls.update();
          }
        }
      }
    };

    window.handleChatToggle = function() {
      console.log('üí¨ Chat toggle clicked');
      if (window.globalChat) {
        window.globalChat.toggleChat();
        console.log('‚úÖ Chat toggled');
      } else {
        console.warn('‚ö†Ô∏è Chat not initialized yet. Socket may not be connected.');
        // Show user-friendly message
        const notice = document.createElement('div');
        notice.style.cssText = `
          position: fixed;
          top: 80px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 170, 0, 0.95);
          border: 2px solid #ffaa00;
          border-radius: 8px;
          padding: 15px 25px;
          color: #000;
          font-family: 'Courier New', monospace;
          font-size: 14px;
          z-index: 10000;
          box-shadow: 0 4px 20px rgba(255, 170, 0, 0.4);
        `;
        notice.textContent = '‚ö†Ô∏è Chat loading... Please wait for connection.';
        document.body.appendChild(notice);
        setTimeout(() => {
          if (notice.parentNode) {
            notice.style.opacity = '0';
            notice.style.transition = 'opacity 0.3s';
            setTimeout(() => document.body.removeChild(notice), 300);
          }
        }, 3000);
      }
    };

    window.handleZoomIn = function() {
      console.log('üîç Zoom in clicked');
      if (window.galacticMap) {
        window.galacticMap.camera.zoom *= 1.2;
        window.galacticMap.camera.updateProjectionMatrix();
        console.log('Zoom level:', window.galacticMap.camera.zoom);
      }
    };

    window.handleZoomOut = function() {
      console.log('üîç Zoom out clicked');
      if (window.galacticMap) {
        window.galacticMap.camera.zoom /= 1.2;
        window.galacticMap.camera.updateProjectionMatrix();
        console.log('Zoom level:', window.galacticMap.camera.zoom);
      }
    };

    console.log('‚úÖ All UI functions defined globally');
  </script>



  <!-- Overlay Menu System -->
  <div class="overlay-menu" id="overlayMenu">
    <div class="overlay-menu-header">
      <h2 class="overlay-menu-title">
        <span class="menu-icon">üéÆ</span>
        Navigation Hub
      </h2>
      <button class="overlay-menu-close" onclick="toggleOverlayMenu()" aria-label="Close menu">
        <span>‚úï</span>
      </button>
    </div>

    <nav class="overlay-menu-nav">
      <!-- In-Game Section -->
      <div class="overlay-menu-section">
        <div class="overlay-menu-section-title">
          <span class="section-icon">üåå</span>
          In-Game
        </div>

        <% if (typeof character !== 'undefined' && character) { %>
        <button class="overlay-menu-item" onclick="event.preventDefault(); window.openCharacterOverlay && window.openCharacterOverlay(); toggleOverlayMenu();">
          <span class="menu-item-icon">‚öîÔ∏è</span>
          <div class="menu-item-content">
            <span class="menu-item-label">My Character</span>
            <span class="menu-item-desc">View stats & equipment</span>
          </div>
          <span class="menu-item-arrow">‚Ä∫</span>
        </button>

        <button class="overlay-menu-item" onclick="event.preventDefault(); window.openInventoryOverlay && window.openInventoryOverlay(); toggleOverlayMenu();">
          <span class="menu-item-icon">üéí</span>
          <div class="menu-item-content">
            <span class="menu-item-label">Inventory</span>
            <span class="menu-item-desc">Manage items & gear</span>
          </div>
          <span class="menu-item-arrow">‚Ä∫</span>
        </button>
        <% } %>

        <button class="overlay-menu-item" onclick="event.preventDefault(); window.openProfileOverlay && window.openProfileOverlay(); toggleOverlayMenu();">
          <span class="menu-item-icon">üë§</span>
          <div class="menu-item-content">
            <span class="menu-item-label">Profile</span>
            <span class="menu-item-desc">View your stats</span>
          </div>
          <span class="menu-item-arrow">‚Ä∫</span>
        </button>

        <button class="overlay-menu-item" onclick="event.preventDefault(); window.openTomeOverlay(); toggleOverlayMenu();">
          <span class="menu-item-icon">üìñ</span>
          <div class="menu-item-content">
            <span class="menu-item-label">The Tome</span>
            <span class="menu-item-desc">Lore database</span>
          </div>
          <span class="menu-item-arrow">‚Ä∫</span>
        </button>
      </div>

      <div class="overlay-menu-divider"></div>

      <!-- Main Menu -->
      <div class="overlay-menu-section">
        <div class="overlay-menu-item out-of-game menu-exit-item" onclick="navigateWithConfirmation('/menu')">
          <span class="menu-item-icon">üè†</span>
          <div class="menu-item-content">
            <span class="menu-item-label">Main Menu</span>
            <span class="menu-item-desc">Exit to navigation hub</span>
          </div>
          <span class="menu-item-badge exit-badge">Exit Game</span>
        </div>
      </div>
    </nav>
  </div>

  <!-- Overlay backdrop for menu -->
  <div class="overlay-backdrop" id="overlayBackdrop" onclick="toggleOverlayMenu()"></div>

  <style>
    /* Overlay Menu Styling */
    .overlay-menu {
      position: fixed;
      top: 0;
      right: -420px;
      width: 380px;
      height: 100vh;
      background: linear-gradient(135deg, rgba(10, 10, 26, 0.98) 0%, rgba(26, 26, 52, 0.98) 100%);
      backdrop-filter: blur(20px);
      border-left: 2px solid rgba(102, 126, 234, 0.4);
      box-shadow: -10px 0 40px rgba(0, 0, 0, 0.5);
      z-index: 10000;
      transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .overlay-menu.active {
      right: 0;
    }

    .overlay-menu-header {
      padding: 24px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    }

    .overlay-menu-title {
      margin: 0;
      color: #ffffff;
      font-family: 'Orbitron', 'Courier New', monospace;
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      text-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
    }

    .menu-icon {
      font-size: 24px;
      filter: drop-shadow(0 0 10px rgba(102, 126, 234, 0.8));
    }

    .overlay-menu-close {
      background: rgba(255, 107, 107, 0.2);
      border: 2px solid rgba(255, 107, 107, 0.4);
      border-radius: 50%;
      color: #ff6b6b;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .overlay-menu-close:hover {
      background: rgba(255, 107, 107, 0.3);
      border-color: #ff6b6b;
      transform: rotate(90deg);
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
    }

    .overlay-menu-nav {
      flex: 1;
      padding: 16px 0;
    }

    .overlay-menu-section {
      margin-bottom: 8px;
    }

    .overlay-menu-section-title {
      padding: 16px 24px 12px;
      color: #667eea;
      font-family: 'Orbitron', 'Courier New', monospace;
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      display: flex;
      align-items: center;
      gap: 8px;
      opacity: 0.8;
    }

    .section-icon {
      font-size: 16px;
      filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.6));
    }

    .overlay-menu-item {
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      text-decoration: none;
      color: inherit;
      position: relative;
      overflow: hidden;
    }

    .overlay-menu-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0;
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.15) 0%, transparent 100%);
      transition: width 0.3s ease;
    }

    .overlay-menu-item:hover::before {
      width: 100%;
    }

    .overlay-menu-item:hover {
      background: rgba(102, 126, 234, 0.1);
      transform: translateX(4px);
    }

    .overlay-menu-item.out-of-game:hover {
      background: rgba(255, 136, 0, 0.08);
    }

    .overlay-menu-item.menu-exit-item:hover {
      background: rgba(255, 68, 0, 0.1);
    }

    .menu-item-icon {
      font-size: 24px;
      min-width: 28px;
      text-align: center;
      filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.4));
      transition: transform 0.3s;
    }

    .overlay-menu-item:hover .menu-item-icon {
      transform: scale(1.15) rotate(-5deg);
    }

    .menu-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .menu-item-label {
      color: #e0e0ff;
      font-family: 'Orbitron', 'Courier New', monospace;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .menu-item-desc {
      color: rgba(255, 255, 255, 0.5);
      font-family: 'Courier New', monospace;
      font-size: 12px;
      letter-spacing: 0.2px;
    }

    .menu-item-arrow {
      color: #667eea;
      font-size: 20px;
      transition: transform 0.3s;
      opacity: 0.6;
    }

    .overlay-menu-item:hover .menu-item-arrow {
      transform: translateX(4px);
      opacity: 1;
    }

    .menu-item-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .out-of-game-badge {
      background: rgba(255, 136, 0, 0.2);
      border: 1px solid rgba(255, 136, 0, 0.4);
      color: #ff8800;
    }

    .exit-badge {
      background: rgba(255, 68, 0, 0.2);
      border: 1px solid rgba(255, 68, 0, 0.4);
      color: #ff4400;
    }

    .overlay-menu-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
      margin: 16px 24px;
    }

    .overlay-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(8px);
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .overlay-backdrop.active {
      opacity: 1;
      pointer-events: all;
    }

    /* Mobile responsive */
    @media (max-width: 480px) {
      .overlay-menu {
        width: 100%;
        right: -100%;
      }

      .overlay-menu-title {
        font-size: 18px;
      }

      .menu-item-label {
        font-size: 14px;
      }

      .menu-item-desc {
        font-size: 11px;
      }
    }

    /* Admin item styling */
    .admin-item {
      border-left: 3px solid rgba(255, 136, 0, 0.3);
    }

    .admin-item:hover {
      border-left-color: rgba(255, 136, 0, 0.6);
      background: rgba(255, 136, 0, 0.08);
    }

    /* Scrollbar styling */
    .overlay-menu::-webkit-scrollbar {
      width: 6px;
    }

    .overlay-menu::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }

    .overlay-menu::-webkit-scrollbar-thumb {
      background: rgba(102, 126, 234, 0.4);
      border-radius: 3px;
    }

    .overlay-menu::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 126, 234, 0.6);
    }
  </style>

  <!-- Navigation Confirmation Dialog -->
  <div id="navigationConfirmDialog" class="nav-confirm-dialog">
    <div class="nav-confirm-content">
      <div class="nav-confirm-icon">‚ö†Ô∏è</div>
      <h2 class="nav-confirm-title">Exit Game?</h2>
      <p class="nav-confirm-message">You're about to leave the game. Your progress will be saved automatically.</p>
      <div class="nav-confirm-buttons">
        <button id="cancelNavigateBtn" class="nav-btn nav-btn-stay">
          <span class="nav-btn-icon">üéÆ</span>
          Stay in Game
        </button>
        <button id="confirmNavigateBtn" class="nav-btn nav-btn-leave">
          <span class="nav-btn-icon">üö™</span>
          Exit Game
        </button>
      </div>
    </div>
  </div>

  <style>
    /* Navigation Confirmation Dialog */
    .nav-confirm-dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(15px);
      z-index: 20000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .nav-confirm-dialog.active {
      opacity: 1;
      pointer-events: all;
    }

    .nav-confirm-content {
      background: linear-gradient(135deg, rgba(10, 10, 26, 0.98) 0%, rgba(26, 26, 52, 0.98) 100%);
      border: 3px solid #ff6600;
      border-radius: 16px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 0 60px rgba(255, 102, 0, 0.5), 0 20px 40px rgba(0, 0, 0, 0.8);
      text-align: center;
      animation: dialogSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes dialogSlideIn {
      from {
        transform: scale(0.9) translateY(-30px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .nav-confirm-icon {
      font-size: 64px;
      margin-bottom: 20px;
      filter: drop-shadow(0 0 20px rgba(255, 102, 0, 0.8));
      animation: iconPulse 2s ease-in-out infinite;
    }

    @keyframes iconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .nav-confirm-title {
      margin: 0 0 16px 0;
      color: #ff6600;
      font-family: 'Orbitron', 'Courier New', monospace;
      font-size: 28px;
      font-weight: 700;
      text-shadow: 0 0 20px rgba(255, 102, 0, 0.5);
    }

    .nav-confirm-message {
      color: rgba(255, 255, 255, 0.8);
      font-family: 'Courier New', monospace;
      font-size: 15px;
      line-height: 1.6;
      margin: 0 0 32px 0;
    }

    .nav-confirm-buttons {
      display: flex;
      gap: 16px;
      flex-direction: column;
    }

    .nav-btn {
      flex: 1;
      padding: 16px 24px;
      border-radius: 12px;
      font-family: 'Orbitron', 'Courier New', monospace;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .nav-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .nav-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .nav-btn-icon {
      font-size: 20px;
      position: relative;
      z-index: 1;
    }

    .nav-btn span:not(.nav-btn-icon) {
      position: relative;
      z-index: 1;
    }

    .nav-btn-stay {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
      border: 2px solid #667eea;
      color: #a0b4ff;
      order: 1;
    }

    .nav-btn-stay:hover {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.5), rgba(118, 75, 162, 0.5));
      border-color: #7e92ff;
      box-shadow: 0 0 30px rgba(102, 126, 234, 0.6);
      transform: translateY(-2px);
    }

    .nav-btn-leave {
      background: linear-gradient(135deg, rgba(255, 102, 0, 0.2), rgba(255, 68, 0, 0.2));
      border: 2px solid rgba(255, 102, 0, 0.5);
      color: #ff8844;
      order: 2;
    }

    .nav-btn-leave:hover {
      background: linear-gradient(135deg, rgba(255, 102, 0, 0.4), rgba(255, 68, 0, 0.4));
      border-color: #ff6600;
      box-shadow: 0 0 30px rgba(255, 102, 0, 0.6);
      transform: translateY(-2px);
    }

    @media (min-width: 600px) {
      .nav-confirm-buttons {
        flex-direction: row;
      }

      .nav-btn-stay {
        order: 2;
      }

      .nav-btn-leave {
        order: 1;
      }
    }

    @media (max-width: 480px) {
      .nav-confirm-content {
        padding: 30px 20px;
      }

      .nav-confirm-icon {
        font-size: 48px;
      }

      .nav-confirm-title {
        font-size: 22px;
      }

      .nav-confirm-message {
        font-size: 13px;
      }

      .nav-btn {
        padding: 14px 20px;
        font-size: 14px;
      }
    }
  </style>

  <!-- Tome Terminal Overlay -->
  <div id="tomeOverlay" class="tome-overlay">
    <div class="tome-terminal">
      <div class="tome-terminal-header">
        <div class="terminal-title">
          <span class="terminal-icon">üìñ</span>
          <span>THE TOME</span>
          <span class="terminal-subtitle">// UNIVERSE DATABASE v2.1.4</span>
        </div>
        <button class="tome-close" onclick="closeTomeOverlay()" aria-label="Close Tome">
          <span>‚úï</span>
        </button>
      </div>

      <div class="tome-terminal-body">
        <!-- Sidebar Navigation -->
        <div class="tome-nav">
          <div class="tome-nav-item active" onclick="switchTomeTab('species')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Species</span>
            <span class="nav-count" id="speciesCount">0</span>
          </div>
          <div class="tome-nav-item" onclick="switchTomeTab('galaxies')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Galaxies</span>
            <span class="nav-count" id="galaxiesCount">0</span>
          </div>
          <div class="tome-nav-item" onclick="switchTomeTab('stars')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Stars</span>
            <span class="nav-count" id="starsCount">0</span>
          </div>
          <div class="tome-nav-item" onclick="switchTomeTab('planets')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Planets</span>
            <span class="nav-count" id="planetsCount">0</span>
          </div>
          <div class="tome-nav-item" onclick="switchTomeTab('anomalies')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Anomalies</span>
            <span class="nav-count" id="anomaliesCount">0</span>
          </div>
          <div class="tome-nav-item" onclick="switchTomeTab('ships')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Ships</span>
            <span class="nav-count" id="shipsCount">0</span>
          </div>
        </div>

        <!-- Content Area -->
        <div class="tome-content">
          <div class="tome-content-header">
            <div class="terminal-prompt">
              <span class="prompt-user">root@stringborn</span>
              <span class="prompt-separator">:</span>
              <span class="prompt-path">~/tome/<span id="currentTomeTab">species</span></span>
              <span class="prompt-symbol">$</span>
              <span class="prompt-cursor">_</span>
            </div>
          </div>

          <div class="tome-content-body" id="tomeContentBody">
            <div class="terminal-loading">
              <span class="loading-text">> Accessing database...</span>
              <span class="loading-cursor">_</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHARACTER TERMINAL OVERLAY -->
  <div id="characterOverlay" class="terminal-overlay">
    <div class="terminal-window character-terminal">
      <div class="terminal-header">
        <div class="terminal-title">
          <span class="terminal-icon">‚öîÔ∏è</span>
          <span>CHARACTER DATA</span>
          <span class="terminal-subtitle">// PERSONNEL FILE v3.2.1</span>
        </div>
        <button class="terminal-close" onclick="closeCharacterOverlay()">
          <span>‚úï</span>
        </button>
      </div>
      <div class="terminal-body">
        <div class="terminal-sidebar">
          <div class="terminal-nav-item active" onclick="switchCharacterTab('overview')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Overview</span>
          </div>
          <div class="terminal-nav-item" onclick="switchCharacterTab('attributes')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Attributes</span>
          </div>
          <div class="terminal-nav-item" onclick="switchCharacterTab('skills')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Skills</span>
          </div>
          <div class="terminal-nav-item" onclick="switchCharacterTab('bio')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Biography</span>
          </div>
        </div>
        <div class="terminal-content">
          <div class="terminal-content-header">
            <div class="terminal-prompt">
              <span class="prompt-user">root@stringborn</span>
              <span class="prompt-separator">:</span>
              <span class="prompt-path">~/character/<span id="currentCharacterTab">overview</span></span>
              <span class="prompt-symbol">$</span>
              <span class="prompt-cursor">_</span>
            </div>
          </div>
          <div class="terminal-content-body" id="characterContentBody">
            <div class="terminal-loading">
              <span class="loading-text">> Loading character data...</span>
              <span class="loading-cursor">_</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- INVENTORY TERMINAL OVERLAY -->
  <div id="inventoryOverlay" class="terminal-overlay">
    <div class="terminal-window inventory-terminal">
      <div class="terminal-header">
        <div class="terminal-title">
          <span class="terminal-icon">üéí</span>
          <span>INVENTORY SYSTEM</span>
          <span class="terminal-subtitle">// CARGO MANAGEMENT v2.8.3</span>
        </div>
        <button class="terminal-close" onclick="closeInventoryOverlay()">
          <span>‚úï</span>
        </button>
      </div>
      <div class="terminal-body">
        <div class="terminal-sidebar">
          <div class="terminal-nav-item active" onclick="switchInventoryTab('backpack')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Backpack</span>
            <span class="nav-count" id="backpackCount">0</span>
          </div>
          <div class="terminal-nav-item" onclick="switchInventoryTab('ship')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Ship Cargo</span>
            <span class="nav-count" id="shipCargoCount">0</span>
          </div>
          <div class="terminal-nav-item" onclick="switchInventoryTab('storehouse')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Storehouse</span>
            <span class="nav-count" id="storehouseCount">0</span>
          </div>
        </div>
        <div class="terminal-content">
          <div class="terminal-content-header">
            <div class="terminal-prompt">
              <span class="prompt-user">root@stringborn</span>
              <span class="prompt-separator">:</span>
              <span class="prompt-path">~/inventory/<span id="currentInventoryTab">backpack</span></span>
              <span class="prompt-symbol">$</span>
              <span class="prompt-cursor">_</span>
            </div>
          </div>
          <div class="terminal-split-view">
            <!-- Left: Equipment/Fittings/Locations -->
            <div class="terminal-panel" id="inventoryLeftPanel">
              <div class="panel-header">
                <span class="panel-title" id="leftPanelTitle">Equipment</span>
              </div>
              <div class="panel-content" id="leftPanelContent">
                <!-- Dynamically populated -->
              </div>
            </div>
            <!-- Right: Items Grid -->
            <div class="terminal-panel" id="inventoryRightPanel">
              <div class="panel-header">
                <span class="panel-title" id="rightPanelTitle">Items</span>
                <span class="panel-capacity" id="inventoryCapacity">0/50</span>
              </div>
              <div class="panel-content-grid" id="inventoryItemsGrid">
                <div class="terminal-loading">
                  <span class="loading-text">> Loading inventory...</span>
                  <span class="loading-cursor">_</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE TERMINAL OVERLAY -->
  <div id="profileOverlay" class="terminal-overlay">
    <div class="terminal-window profile-terminal">
      <div class="terminal-header">
        <div class="terminal-title">
          <span class="terminal-icon">üë§</span>
          <span>USER PROFILE</span>
          <span class="terminal-subtitle">// ACCOUNT INFO v1.5.7</span>
        </div>
        <button class="terminal-close" onclick="closeProfileOverlay()">
          <span>‚úï</span>
        </button>
      </div>
      <div class="terminal-body">
        <div class="terminal-sidebar">
          <div class="terminal-nav-item active" onclick="switchProfileTab('account')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Account</span>
          </div>
          <div class="terminal-nav-item" onclick="switchProfileTab('characters')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Characters</span>
          </div>
          <div class="terminal-nav-item" onclick="switchProfileTab('achievements')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Achievements</span>
          </div>
          <div class="terminal-nav-item" onclick="switchProfileTab('stats')">
            <span class="nav-prefix">&gt;</span>
            <span class="nav-text">Statistics</span>
          </div>
        </div>
        <div class="terminal-content">
          <div class="terminal-content-header">
            <div class="terminal-prompt">
              <span class="prompt-user">root@stringborn</span>
              <span class="prompt-separator">:</span>
              <span class="prompt-path">~/profile/<span id="currentProfileTab">account</span></span>
              <span class="prompt-symbol">$</span>
              <span class="prompt-cursor">_</span>
            </div>
          </div>
          <div class="terminal-content-body" id="profileContentBody">
            <div class="terminal-loading">
              <span class="loading-text">> Loading profile data...</span>
              <span class="loading-cursor">_</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Tome Terminal Overlay */
    .tome-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(2px);
      z-index: 15000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .tome-overlay.active {
      display: flex;
      opacity: 1;
    }

    .tome-terminal {
      width: 100%;
      max-width: 1400px;
      max-height: 90vh;
      background: rgba(0, 20, 0, 0.95);
      border: 2px solid #00ff00;
      border-radius: 8px;
      box-shadow: 0 0 60px rgba(0, 255, 0, 0.3), inset 0 0 40px rgba(0, 255, 0, 0.05);
      display: flex;
      flex-direction: column;
      font-family: 'Courier New', monospace;
      animation: terminalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes terminalSlideIn {
      from {
        transform: scale(0.95) translateY(-30px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .tome-terminal-header {
      padding: 16px 20px;
      background: rgba(0, 40, 0, 0.8);
      border-bottom: 2px solid #00ff00;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .terminal-title {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #00ff00;
      font-size: 18px;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
    }

    .terminal-icon {
      font-size: 24px;
      filter: drop-shadow(0 0 10px rgba(0, 255, 0, 0.8));
    }

    .terminal-subtitle {
      color: #00aa00;
      font-size: 12px;
      font-weight: normal;
      opacity: 0.7;
    }

    .tome-close {
      background: rgba(255, 0, 0, 0.1);
      border: 2px solid #ff0000;
      border-radius: 4px;
      color: #ff0000;
      width: 36px;
      height: 36px;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .tome-close:hover {
      background: rgba(255, 0, 0, 0.2);
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
      transform: scale(1.1);
    }

    .tome-terminal-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .tome-nav {
      width: 220px;
      background: rgba(0, 30, 0, 0.6);
      border-right: 1px solid #00ff00;
      padding: 12px 0;
      overflow-y: auto;
    }

    .tome-nav-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #00dd00;
      border-left: 3px solid transparent;
      user-select: none;
    }

    .tome-nav-item:hover {
      background: rgba(0, 255, 0, 0.1);
      border-left-color: #00ff00;
    }

    .tome-nav-item.active {
      background: rgba(0, 255, 0, 0.15);
      border-left-color: #00ff00;
      color: #00ff00;
      font-weight: bold;
    }

    .nav-prefix {
      font-weight: bold;
      opacity: 0.7;
    }

    .nav-text {
      flex: 1;
      font-size: 14px;
    }

    .nav-count {
      background: rgba(0, 255, 0, 0.2);
      border: 1px solid #00ff00;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      min-width: 24px;
      text-align: center;
    }

    .tome-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .tome-content-header {
      padding: 16px 20px;
      background: rgba(0, 35, 0, 0.6);
      border-bottom: 1px solid #00aa00;
    }

    .terminal-prompt {
      color: #00ff00;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .prompt-user {
      color: #00dd00;
      font-weight: bold;
    }

    .prompt-separator {
      color: #00aa00;
    }

    .prompt-path {
      color: #00bbff;
    }

    .prompt-symbol {
      color: #00ff00;
      font-weight: bold;
    }

    .prompt-cursor {
      animation: cursorBlink 1s steps(2) infinite;
      color: #00ff00;
    }

    @keyframes cursorBlink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .tome-content-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      color: #00dd00;
      line-height: 1.6;
    }

    .terminal-loading {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #00ff00;
      font-size: 14px;
    }

    .loading-cursor {
      animation: cursorBlink 0.8s steps(2) infinite;
    }

    .tome-entry {
      background: rgba(0, 40, 0, 0.4);
      border: 1px solid #00aa00;
      border-radius: 4px;
      padding: 16px;
      margin-bottom: 16px;
      transition: all 0.3s;
    }

    .tome-entry:hover {
      background: rgba(0, 50, 0, 0.6);
      border-color: #00ff00;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.2);
    }

    .tome-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #00aa00;
    }

    .tome-entry-title {
      color: #00ff00;
      font-size: 16px;
      font-weight: bold;
      text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
    }

    .tome-entry-type {
      color: #00aa00;
      font-size: 12px;
      background: rgba(0, 255, 0, 0.1);
      padding: 3px 8px;
      border-radius: 3px;
      border: 1px solid #00aa00;
    }

    .tome-entry-description {
      color: #00cc00;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .tome-entry-meta {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 12px;
      color: #00aa00;
    }

    .tome-entry-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Scrollbar styling */
    .tome-nav::-webkit-scrollbar,
    .tome-content-body::-webkit-scrollbar {
      width: 8px;
    }

    .tome-nav::-webkit-scrollbar-track,
    .tome-content-body::-webkit-scrollbar-track {
      background: rgba(0, 20, 0, 0.4);
    }

    .tome-nav::-webkit-scrollbar-thumb,
    .tome-content-body::-webkit-scrollbar-thumb {
      background: rgba(0, 255, 0, 0.4);
      border-radius: 4px;
    }

    .tome-nav::-webkit-scrollbar-thumb:hover,
    .tome-content-body::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 255, 0, 0.6);
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
      .tome-terminal {
        max-height: 95vh;
        border-radius: 0;
      }

      .tome-nav {
        width: 160px;
      }

      .tome-nav-item {
        padding: 10px 12px;
        font-size: 13px;
      }

      .terminal-title {
        font-size: 14px;
      }

      .terminal-subtitle {
        display: none;
      }

      .tome-content-body {
        padding: 12px;
      }
    }

    /* ==========================================
       UNIVERSAL TERMINAL OVERLAY STYLES
       ========================================== */

    .terminal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(2px);
      z-index: 15000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .terminal-overlay.active {
      display: flex;
      opacity: 1;
    }

    .terminal-window {
      width: 100%;
      max-width: 1400px;
      max-height: 90vh;
      border: 2px solid;
      border-radius: 8px;
      box-shadow: 0 0 60px, inset 0 0 40px;
      display: flex;
      flex-direction: column;
      font-family: 'Courier New', monospace;
      animation: terminalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Character Terminal - Blue Theme */
    .character-terminal {
      background: rgba(0, 15, 30, 0.95);
      border-color: #0066ff;
      box-shadow: 0 0 60px rgba(0, 102, 255, 0.3), inset 0 0 40px rgba(0, 102, 255, 0.05);
    }

    .character-terminal .terminal-header {
      background: rgba(0, 20, 40, 0.9);
      border-bottom: 2px solid rgba(0, 102, 255, 0.5);
    }

    .character-terminal .terminal-icon,
    .character-terminal .terminal-title > span:first-of-type + span,
    .character-terminal .nav-prefix,
    .character-terminal .prompt-symbol {
      color: #0066ff;
    }

    .character-terminal .terminal-nav-item.active,
    .character-terminal .terminal-nav-item:hover {
      background: rgba(0, 102, 255, 0.15);
      border-left-color: #0066ff;
    }

    /* Inventory Terminal - Cyan Theme */
    .inventory-terminal {
      background: rgba(0, 20, 20, 0.95);
      border-color: #00ffff;
      box-shadow: 0 0 60px rgba(0, 255, 255, 0.3), inset 0 0 40px rgba(0, 255, 255, 0.05);
    }

    .inventory-terminal .terminal-header {
      background: rgba(0, 30, 30, 0.9);
      border-bottom: 2px solid rgba(0, 255, 255, 0.5);
    }

    .inventory-terminal .terminal-icon,
    .inventory-terminal .terminal-title > span:first-of-type + span,
    .inventory-terminal .nav-prefix,
    .inventory-terminal .prompt-symbol {
      color: #00ffff;
    }

    .inventory-terminal .terminal-nav-item.active,
    .inventory-terminal .terminal-nav-item:hover {
      background: rgba(0, 255, 255, 0.15);
      border-left-color: #00ffff;
    }

    /* Profile Terminal - Purple Theme */
    .profile-terminal {
      background: rgba(20, 0, 30, 0.95);
      border-color: #8a4fff;
      box-shadow: 0 0 60px rgba(138, 79, 255, 0.3), inset 0 0 40px rgba(138, 79, 255, 0.05);
    }

    .profile-terminal .terminal-header {
      background: rgba(30, 0, 40, 0.9);
      border-bottom: 2px solid rgba(138, 79, 255, 0.5);
    }

    .profile-terminal .terminal-icon,
    .profile-terminal .terminal-title > span:first-of-type + span,
    .profile-terminal .nav-prefix,
    .profile-terminal .prompt-symbol {
      color: #8a4fff;
    }

    .profile-terminal .terminal-nav-item.active,
    .profile-terminal .terminal-nav-item:hover {
      background: rgba(138, 79, 255, 0.15);
      border-left-color: #8a4fff;
    }

    /* Terminal Header */
    .terminal-header {
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .terminal-title {
      display: flex;
      align-items: center;
      gap: 12px;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      letter-spacing: 1px;
    }

    .terminal-icon {
      font-size: 20px;
    }

    .terminal-subtitle {
      color: rgba(255, 255, 255, 0.5);
      font-size: 11px;
      font-weight: normal;
      letter-spacing: 0.5px;
    }

    .terminal-close {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      color: #ff4444;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Courier New', monospace;
    }

    .terminal-close:hover {
      background: rgba(255, 0, 0, 0.2);
      border-color: #ff4444;
      transform: scale(1.05);
    }

    /* Terminal Body */
    .terminal-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Terminal Sidebar */
    .terminal-sidebar {
      width: 200px;
      background: rgba(0, 0, 0, 0.3);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 12px;
      overflow-y: auto;
    }

    .terminal-nav-item {
      padding: 12px;
      margin-bottom: 4px;
      background: rgba(0, 0, 0, 0.2);
      border-left: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .terminal-nav-item .nav-prefix {
      font-size: 14px;
      font-weight: bold;
    }

    .terminal-nav-item .nav-text {
      flex: 1;
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
    }

    .terminal-nav-item .nav-count {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
    }

    .terminal-nav-item.active .nav-text {
      color: #fff;
      font-weight: bold;
    }

    /* Terminal Content */
    .terminal-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .terminal-content-header {
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .terminal-prompt {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      font-family: 'Courier New', monospace;
    }

    .prompt-user {
      color: #4ade80;
    }

    .prompt-separator {
      color: rgba(255, 255, 255, 0.5);
    }

    .prompt-path {
      color: #60a5fa;
    }

    .prompt-cursor {
      animation: blink 1s infinite;
      color: #fff;
    }

    .terminal-content-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      color: #fff;
      font-size: 14px;
      line-height: 1.6;
    }

    .terminal-content-body::-webkit-scrollbar {
      width: 12px;
    }

    .terminal-content-body::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
    }

    .terminal-content-body::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
    }

    .terminal-content-body::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Terminal Split View (for Inventory) */
    .terminal-split-view {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 16px;
      padding: 20px;
      height: 100%;
      overflow: hidden;
    }

    .terminal-panel {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.4);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-title {
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    .panel-capacity {
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
    }

    .panel-content {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    .panel-content-grid {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      align-content: start;
    }

    /* Terminal Loading State */
    .terminal-loading {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255, 255, 255, 0.7);
    }

    .loading-text {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .loading-cursor {
      animation: blink 1s infinite;
    }

    /* Terminal Data Display */
    .data-row {
      display: flex;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .data-row:last-child {
      border-bottom: none;
    }

    .data-label {
      width: 180px;
      color: rgba(255, 255, 255, 0.6);
      font-size: 13px;
    }

    .data-value {
      flex: 1;
      color: #fff;
      font-size: 13px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .terminal-window {
        max-height: 95vh;
        border-radius: 0;
      }

      .terminal-sidebar {
        width: 160px;
        padding: 8px;
      }

      .terminal-nav-item {
        padding: 10px;
        font-size: 13px;
      }

      .terminal-title {
        font-size: 14px;
      }

      .terminal-subtitle {
        display: none;
      }

      .terminal-split-view {
        grid-template-columns: 1fr;
      }

      .panel-content-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }
  </style>

  <!-- Socket.IO for real-time player updates -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- GameStateMonitor - Centralized coordinate management -->
  <script src="/javascripts/GameStateMonitor.js"></script>

  <!-- Tome Overlay Functions - Must be defined early for onclick handlers -->
  <script>
    // ========================================
    // TOME OVERLAY SYSTEM - Early Definition
    // ========================================
    let tomeData = null;
    let currentTomeTab = 'species';

    /**
     * Open Tome Overlay
     */
    window.openTomeOverlay = function() {
      console.log('üìñ Opening Tome overlay');
      const overlay = document.getElementById('tomeOverlay');
      if (overlay) {
        overlay.classList.add('active');

        // Load tome data if not already loaded
        if (!tomeData) {
          loadTomeData();
        } else {
          renderTomeContent(currentTomeTab);
        }
      } else {
        console.error('‚ùå Tome overlay element not found');
      }
    };

    /**
     * Close Tome Overlay
     */
    window.closeTomeOverlay = function() {
      console.log('üìñ Closing Tome overlay');
      const overlay = document.getElementById('tomeOverlay');
      if (overlay) {
        overlay.classList.remove('active');
      }
    };

    /**
     * Load Tome Data from API
     */
    async function loadTomeData() {
      const contentBody = document.getElementById('tomeContentBody');

      try {
        contentBody.innerHTML = `
          <div class="terminal-loading">
            <span class="loading-text">> Accessing universe database...</span>
            <span class="loading-cursor">_</span>
          </div>
        `;

        const response = await fetch('/api/v1/universe/tome-data');
        const data = await response.json();

        if (data.success) {
          tomeData = data;

          // Update counts
          document.getElementById('speciesCount').textContent = data.species?.length || 0;
          document.getElementById('galaxiesCount').textContent = data.assets?.galaxies?.length || 0;
          document.getElementById('starsCount').textContent = data.assets?.stars?.length || 0;
          document.getElementById('planetsCount').textContent = data.assets?.planets?.length || 0;
          document.getElementById('anomaliesCount').textContent = data.assets?.anomalies?.length || 0;
          document.getElementById('shipsCount').textContent = data.assets?.ships?.length || 0;

          // Render initial content
          renderTomeContent(currentTomeTab);
        } else {
          contentBody.innerHTML = `
            <div style="color: #ff0000;">
              <p>> ERROR: Failed to load tome data</p>
              <p>> ${data.error || 'Unknown error'}</p>
            </div>
          `;
        }
      } catch (err) {
        console.error('Error loading tome data:', err);
        contentBody.innerHTML = `
          <div style="color: #ff0000;">
            <p>> ERROR: Connection to database failed</p>
            <p>> ${err.message}</p>
          </div>
        `;
      }
    }

    /**
     * Switch Tome Tab
     */
    window.switchTomeTab = function(tab) {
      currentTomeTab = tab;

      // Update active nav item
      document.querySelectorAll('.tome-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');

      // Update terminal path
      document.getElementById('currentTomeTab').textContent = tab;

      // Render content
      renderTomeContent(tab);
    };

    /**
     * Render Tome Content
     */
    function renderTomeContent(tab) {
      const contentBody = document.getElementById('tomeContentBody');

      if (!tomeData) {
        contentBody.innerHTML = `
          <div class="terminal-loading">
            <span class="loading-text">> Loading...</span>
            <span class="loading-cursor">_</span>
          </div>
        `;
        return;
      }

      let html = '';

      if (tab === 'species') {
        const species = tomeData.species || [];
        if (species.length === 0) {
          html = '<p style="color: #00aa00;">> No species data available</p>';
        } else {
          species.forEach(s => {
            html += `
              <div class="tome-entry">
                <div class="tome-entry-header">
                  <div class="tome-entry-title">${s.name || 'Unknown Species'}</div>
                  <div class="tome-entry-type">SPECIES</div>
                </div>
                <div class="tome-entry-description">${s.description || 'No description available.'}</div>
                ${s.homeworld ? `<div class="tome-entry-meta"><span>üè† Homeworld: ${s.homeworld}</span></div>` : ''}
              </div>
            `;
          });
        }
      } else {
        // Handle asset types
        const assets = tomeData.assets?.[tab] || [];
        if (assets.length === 0) {
          html = `<p style="color: #00aa00;">> No ${tab} data available</p>`;
        } else {
          assets.forEach(asset => {
            const coordinates = asset.coordinates || asset.sceneCoordinates || {};
            html += `
              <div class="tome-entry">
                <div class="tome-entry-header">
                  <div class="tome-entry-title">${asset.title || asset.name || 'Unknown'}</div>
                  <div class="tome-entry-type">${asset.assetType?.toUpperCase() || tab.toUpperCase()}</div>
                </div>
                ${asset.description ? `<div class="tome-entry-description">${asset.description}</div>` : ''}
                <div class="tome-entry-meta">
                  ${coordinates.x !== undefined ? `<span>üìç Coords: (${Math.round(coordinates.x)}, ${Math.round(coordinates.y)}, ${Math.round(coordinates.z)})</span>` : ''}
                  ${asset.mass ? `<span>‚öñÔ∏è Mass: ${asset.mass}</span>` : ''}
                  ${asset.radius ? `<span>üìè Radius: ${asset.radius}</span>` : ''}
                </div>
              </div>
            `;
          });
        }
      }

      contentBody.innerHTML = html || '<p style="color: #00aa00;">> No data available</p>';
    }

    // Close tome on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const overlay = document.getElementById('tomeOverlay');
        if (overlay && overlay.classList.contains('active')) {
          closeTomeOverlay();
        }
      }
    });

    console.log('‚úÖ Tome overlay system initialized (early)');
  </script>

  <!-- Three.js Library (ES Module) -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
      }
    }
  </script>

  <!-- Terminal Overlay Systems -->
  <script>
    // ========================================
    // CHARACTER OVERLAY SYSTEM
    // ========================================
    let characterData = null;
    let currentCharacterTab = 'overview';

    window.openCharacterOverlay = function() {
      console.log('‚öîÔ∏è Opening Character overlay');
      const overlay = document.getElementById('characterOverlay');
      if (overlay) {
        overlay.classList.add('active');
        if (!characterData) {
          loadCharacterData();
        } else {
          renderCharacterContent(currentCharacterTab);
        }
      }
    };

    window.closeCharacterOverlay = function() {
      console.log('‚öîÔ∏è Closing Character overlay');
      const overlay = document.getElementById('characterOverlay');
      if (overlay) {
        overlay.classList.remove('active');
      }
    };

    async function loadCharacterData() {
      const contentBody = document.getElementById('characterContentBody');
      try {
        contentBody.innerHTML = `
          <div class="terminal-loading">
            <span class="loading-text">> Accessing personnel records...</span>
            <span class="loading-cursor">_</span>
          </div>
        `;

        <% if (typeof character !== 'undefined' && character && character._id) { %>
        const response = await fetch('/api/v1/characters/<%= character._id %>');
        const data = await response.json();

        if (data.character || data.success) {
          characterData = data.character || data;
          renderCharacterContent(currentCharacterTab);
        } else {
          contentBody.innerHTML = `
            <div style="color: #ff0000;">
              <p>> ERROR: Failed to load character data</p>
              <p>> ${data.error || 'Unknown error'}</p>
            </div>
          `;
        }
        <% } else { %>
        contentBody.innerHTML = `
          <div style="color: #ffaa00;">
            <p>> WARNING: No character selected</p>
            <p>> Please create or select a character first</p>
          </div>
        `;
        <% } %>
      } catch (err) {
        console.error('Error loading character data:', err);
        contentBody.innerHTML = `
          <div style="color: #ff0000;">
            <p>> ERROR: Connection failed</p>
            <p>> ${err.message}</p>
          </div>
        `;
      }
    }

    window.switchCharacterTab = function(tab) {
      currentCharacterTab = tab;
      document.querySelectorAll('#characterOverlay .terminal-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      document.getElementById('currentCharacterTab').textContent = tab;
      renderCharacterContent(tab);
    };

    function renderCharacterContent(tab) {
      const contentBody = document.getElementById('characterContentBody');
      if (!characterData) {
        contentBody.innerHTML = '<div class="terminal-loading"><span class="loading-text">> Loading...</span></div>';
        return;
      }

      let html = '';
      switch(tab) {
        case 'overview':
          html = `
            <div class="data-row"><div class="data-label">> NAME</div><div class="data-value">${characterData.name || 'Unknown'}</div></div>
            <div class="data-row"><div class="data-label">> SPECIES</div><div class="data-value">${characterData.species || 'Unknown'}</div></div>
            <div class="data-row"><div class="data-label">> LEVEL</div><div class="data-value">${characterData.level || 1}</div></div>
            <div class="data-row"><div class="data-label">> LOCATION</div><div class="data-value">${characterData.location?.zone || 'Unknown'}</div></div>
            <div class="data-row"><div class="data-label">> CREDITS</div><div class="data-value">${characterData.credits || 0} ISK</div></div>
          `;
          break;
        case 'attributes':
          html = `
            <div class="data-row"><div class="data-label">> STRENGTH</div><div class="data-value">${characterData.attributes?.strength || 10}</div></div>
            <div class="data-row"><div class="data-label">> INTELLIGENCE</div><div class="data-value">${characterData.attributes?.intelligence || 10}</div></div>
            <div class="data-row"><div class="data-label">> CHARISMA</div><div class="data-value">${characterData.attributes?.charisma || 10}</div></div>
            <div class="data-row"><div class="data-label">> PERCEPTION</div><div class="data-value">${characterData.attributes?.perception || 10}</div></div>
            <div class="data-row"><div class="data-label">> WILLPOWER</div><div class="data-value">${characterData.attributes?.willpower || 10}</div></div>
          `;
          break;
        case 'skills':
          html = '<div><p>> Skills system coming soon...</p></div>';
          break;
        case 'bio':
          html = `<div><p>${characterData.bio || '> No biography on file...'}</p></div>`;
          break;
      }
      contentBody.innerHTML = html;
    }

    // ========================================
    // INVENTORY OVERLAY SYSTEM
    // ========================================
    let inventoryData = null;
    let currentInventoryTab = 'backpack';

    window.openInventoryOverlay = function() {
      console.log('üéí Opening Inventory overlay');
      const overlay = document.getElementById('inventoryOverlay');
      if (overlay) {
        overlay.classList.add('active');
        if (!inventoryData) {
          loadInventoryData();
        } else {
          renderInventoryContent(currentInventoryTab);
        }
      }
    };

    window.closeInventoryOverlay = function() {
      console.log('üéí Closing Inventory overlay');
      const overlay = document.getElementById('inventoryOverlay');
      if (overlay) {
        overlay.classList.remove('active');
      }
    };

    async function loadInventoryData() {
      const itemsGrid = document.getElementById('inventoryItemsGrid');
      try {
        itemsGrid.innerHTML = `
          <div class="terminal-loading">
            <span class="loading-text">> Scanning cargo manifest...</span>
            <span class="loading-cursor">_</span>
          </div>
        `;

        <% if (typeof character !== 'undefined' && character && character._id) { %>
        const [invResponse, shipResponse, fittingsResponse] = await Promise.all([
          fetch('/api/v1/characters/<%= character._id %>/inventory'),
          fetch('/api/v1/characters/<%= character._id %>/ship/cargo'),
          fetch('/api/v1/characters/<%= character._id %>/ship/fittings')
        ]);

        const invData = await invResponse.json();
        const shipData = shipResponse.ok ? await shipResponse.json() : null;
        const fittingsData = fittingsResponse.ok ? await fittingsResponse.json() : null;

        inventoryData = {
          backpack: invData.backpack || { items: [], capacity: 50 },
          equipped: invData.equipped || {},
          ship: shipData || { cargo: { items: [], capacity: 200 }},
          fittings: fittingsData || {},
          character: invData.character || {}
        };

        // Update counts
        document.getElementById('backpackCount').textContent = (invData.backpack?.items?.length || 0);
        document.getElementById('shipCargoCount').textContent = (shipData?.cargo?.items?.length || 0);
        document.getElementById('storehouseCount').textContent = '0';

        renderInventoryContent(currentInventoryTab);
        <% } else { %>
        itemsGrid.innerHTML = `
          <div style="color: #ffaa00; padding: 20px;">
            <p>> WARNING: No character selected</p>
          </div>
        `;
        <% } %>
      } catch (err) {
        console.error('Error loading inventory:', err);
        itemsGrid.innerHTML = `
          <div style="color: #ff0000; padding: 20px;">
            <p>> ERROR: Failed to load inventory</p>
            <p>> ${err.message}</p>
          </div>
        `;
      }
    }

    window.switchInventoryTab = function(tab) {
      currentInventoryTab = tab;
      document.querySelectorAll('#inventoryOverlay .terminal-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      document.getElementById('currentInventoryTab').textContent = tab;
      renderInventoryContent(tab);
    };

    function renderInventoryContent(tab) {
      if (!inventoryData) return;

      const leftPanel = document.getElementById('leftPanelContent');
      const rightPanel = document.getElementById('inventoryItemsGrid');
      const leftTitle = document.getElementById('leftPanelTitle');
      const rightTitle = document.getElementById('rightPanelTitle');
      const capacity = document.getElementById('inventoryCapacity');

      switch(tab) {
        case 'backpack':
          leftTitle.textContent = 'Equipment';
          rightTitle.textContent = 'Backpack Items';
          const items = inventoryData.backpack.items || [];
          capacity.textContent = `${items.length}/${inventoryData.backpack.capacity || 50}`;

          // Render equipment slots
          leftPanel.innerHTML = `
            <div style="font-size: 13px; color: rgba(255,255,255,0.7);">
              <p>> Character equipment loadout</p>
              <p style="margin-top: 10px; color: rgba(255,255,255,0.5);">[Equipment system in development]</p>
            </div>
          `;

          // Render backpack items
          if (items.length === 0) {
            rightPanel.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">> Backpack empty</div>';
          } else {
            rightPanel.innerHTML = items.map(item => `
              <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(0,255,255,0.3); border-radius: 4px; padding: 12px; text-align: center;">
                <div style="font-size: 20px; margin-bottom: 8px;">${getItemIcon(item.itemDetails?.itemType)}</div>
                <div style="color: #fff; font-size: 12px; font-weight: bold;">${item.itemDetails?.name || 'Unknown'}</div>
                ${item.quantity > 1 ? `<div style="color: rgba(255,255,255,0.6); font-size: 11px;">x${item.quantity}</div>` : ''}
              </div>
            `).join('');
          }
          break;

        case 'ship':
          leftTitle.textContent = 'Ship Fittings';
          rightTitle.textContent = 'Ship Cargo';
          const cargoItems = inventoryData.ship.cargo?.items || [];
          const cargoCapacity = inventoryData.ship.cargo?.capacity || 200;
          const usedSpace = inventoryData.ship.cargo?.usedSpace || 0;
          capacity.textContent = `${usedSpace.toFixed(1)}/${cargoCapacity} m¬≥`;

          // Render ship fittings
          leftPanel.innerHTML = `
            <div style="font-size: 13px; color: rgba(255,255,255,0.7);">
              <p>> Ship module fittings</p>
              <p style="margin-top: 10px; color: rgba(255,255,255,0.5);">[Fittings system in development]</p>
            </div>
          `;

          // Render cargo items
          if (cargoItems.length === 0) {
            rightPanel.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">> Cargo bay empty</div>';
          } else {
            rightPanel.innerHTML = cargoItems.map(item => `
              <div style="background: rgba(0,0,0,0.4); border: 1px solid rgba(0,255,255,0.3); border-radius: 4px; padding: 12px; text-align: center;">
                <div style="font-size: 20px; margin-bottom: 8px;">${getItemIcon(item.itemDetails?.itemType)}</div>
                <div style="color: #fff; font-size: 12px; font-weight: bold;">${item.itemDetails?.name || 'Unknown'}</div>
                ${item.quantity > 1 ? `<div style="color: rgba(255,255,255,0.6); font-size: 11px;">x${item.quantity}</div>` : ''}
              </div>
            `).join('');
          }
          break;

        case 'storehouse':
          leftTitle.textContent = 'Storage Locations';
          rightTitle.textContent = 'Stored Items';
          capacity.textContent = '0/1000';

          leftPanel.innerHTML = `
            <div style="font-size: 13px; color: rgba(255,255,255,0.7);">
              <p>> Available storage facilities:</p>
              <p style="margin-top: 10px; color: rgba(255,255,255,0.5);">[Storehouse system in development]</p>
            </div>
          `;

          rightPanel.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">> No items in storage</div>';
          break;
      }
    }

    function getItemIcon(itemType) {
      const icons = {
        consumable: 'üíä',
        weapon: '‚öîÔ∏è',
        module: 'üîß',
        resource: '‚õèÔ∏è',
        trade_good: 'üì¶',
        equipment: 'üõ°Ô∏è'
      };
      return icons[itemType] || 'üì¶';
    }

    // ========================================
    // PROFILE OVERLAY SYSTEM
    // ========================================
    let profileData = null;
    let currentProfileTab = 'account';

    window.openProfileOverlay = function() {
      console.log('üë§ Opening Profile overlay');
      const overlay = document.getElementById('profileOverlay');
      if (overlay) {
        overlay.classList.add('active');
        if (!profileData) {
          loadProfileData();
        } else {
          renderProfileContent(currentProfileTab);
        }
      }
    };

    window.closeProfileOverlay = function() {
      console.log('üë§ Closing Profile overlay');
      const overlay = document.getElementById('profileOverlay');
      if (overlay) {
        overlay.classList.remove('active');
      }
    };

    async function loadProfileData() {
      const contentBody = document.getElementById('profileContentBody');
      try {
        contentBody.innerHTML = `
          <div class="terminal-loading">
            <span class="loading-text">> Accessing user records...</span>
            <span class="loading-cursor">_</span>
          </div>
        `;

        <% if (typeof user !== 'undefined' && user) { %>
        profileData = {
          username: '<%= user.username %>',
          email: '<%= user.email || "" %>',
          createdAt: '<%= user.createdAt %>',
          <% if (typeof user.characters !== 'undefined') { %>
          characterCount: <%= user.characters?.length || 0 %>,
          <% } else { %>
          characterCount: 0,
          <% } %>
        };
        renderProfileContent(currentProfileTab);
        <% } else { %>
        contentBody.innerHTML = `
          <div style="color: #ffaa00;">
            <p>> WARNING: No user session found</p>
          </div>
        `;
        <% } %>
      } catch (err) {
        console.error('Error loading profile:', err);
        contentBody.innerHTML = `
          <div style="color: #ff0000;">
            <p>> ERROR: Failed to load profile</p>
            <p>> ${err.message}</p>
          </div>
        `;
      }
    }

    window.switchProfileTab = function(tab) {
      currentProfileTab = tab;
      document.querySelectorAll('#profileOverlay .terminal-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      event.currentTarget.classList.add('active');
      document.getElementById('currentProfileTab').textContent = tab;
      renderProfileContent(tab);
    };

    function renderProfileContent(tab) {
      const contentBody = document.getElementById('profileContentBody');
      if (!profileData) {
        contentBody.innerHTML = '<div class="terminal-loading"><span class="loading-text">> Loading...</span></div>';
        return;
      }

      let html = '';
      switch(tab) {
        case 'account':
          html = `
            <div class="data-row"><div class="data-label">> USERNAME</div><div class="data-value">${profileData.username}</div></div>
            <div class="data-row"><div class="data-label">> EMAIL</div><div class="data-value">${profileData.email || 'Not set'}</div></div>
            <div class="data-row"><div class="data-label">> MEMBER SINCE</div><div class="data-value">${new Date(profileData.createdAt).toLocaleDateString()}</div></div>
            <div class="data-row"><div class="data-label">> CHARACTERS</div><div class="data-value">${profileData.characterCount}</div></div>
          `;
          break;
        case 'characters':
          html = '<div><p>> Character list feature coming soon...</p></div>';
          break;
        case 'achievements':
          html = '<div><p>> Achievements system coming soon...</p></div>';
          break;
        case 'stats':
          html = '<div><p>> Statistics tracking coming soon...</p></div>';
          break;
      }
      contentBody.innerHTML = html;
    }

    // ========================================
    // NAVIGATION CONFIRMATION SYSTEM
    // ========================================
    let pendingNavigationUrl = null;

    window.navigateWithConfirmation = function(url) {
      pendingNavigationUrl = url;
      const dialog = document.getElementById('navigationConfirmDialog');

      if (!dialog) {
        console.error('‚ùå navigationConfirmDialog not found! Navigating directly...');
        window.location.href = url;
        return;
      }

      // Show dialog with class-based animation
      dialog.classList.add('active');

      // Close the overlay menu
      if (window.toggleOverlayMenu) {
        const menu = document.getElementById('overlayMenu');
        if (menu && menu.classList.contains('active')) {
          window.toggleOverlayMenu();
        }
      }

      console.log('üîî Navigation confirmation requested for:', url);
    };

    window.closeNavigationDialog = function() {
      const dialog = document.getElementById('navigationConfirmDialog');

      if (!dialog) {
        console.warn('‚ö†Ô∏è navigationConfirmDialog not found when trying to close');
        pendingNavigationUrl = null;
        return;
      }

      dialog.classList.remove('active');
      pendingNavigationUrl = null;
    };

    // Set up confirm/cancel buttons when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      const confirmNavigateBtn = document.getElementById('confirmNavigateBtn');
      if (confirmNavigateBtn) {
        confirmNavigateBtn.addEventListener('click', () => {
          if (pendingNavigationUrl) {
            console.log('‚úÖ User confirmed navigation to:', pendingNavigationUrl);
            window.location.href = pendingNavigationUrl;
          }
        });
      }

      const cancelNavigateBtn = document.getElementById('cancelNavigateBtn');
      if (cancelNavigateBtn) {
        cancelNavigateBtn.addEventListener('click', () => {
          console.log('‚ùå User cancelled navigation');
          window.closeNavigationDialog();
        });
      }

      // ESC key to close dialog
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const dialog = document.getElementById('navigationConfirmDialog');
          if (dialog && dialog.classList.contains('active')) {
            window.closeNavigationDialog();
          }
        }
      });
    });

    console.log('‚úÖ Navigation confirmation system initialized');
  </script>

  <!-- 3D Galactic Map Script -->
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // Make THREE available globally for the script
    window.THREE = THREE;
    window.OrbitControls = OrbitControls;
  </script>

  <script src="/javascripts/galactic-map-3d.js?v=8.0.1&t=<%= Date.now() %>"></script>
  <script src="/javascripts/activity-monitor.js"></script>
  <script src="/javascripts/global-chat.js"></script>

  <script>
    // ========================================
    // CRITICAL: Initialize Galactic Map 3D
    // ========================================
    // Wait for THREE.js to be loaded (module loading is async)
    function initializeGalacticMap() {
      if (typeof THREE === 'undefined' || typeof GalacticMap3D === 'undefined') {
        console.log('‚è≥ Waiting for THREE.js and GalacticMap3D to load...');
        setTimeout(initializeGalacticMap, 100);
        return;
      }

      console.log('üåå Initializing Galactic Map 3D...');
      window.galacticMap = new GalacticMap3D('mapContainer');

      // Initialize socket connection for physics updates (socket will be connected later)
      // Socket initialization happens after the map loads in the socket setup section below

      // Load and display all assets - use map-state-3d endpoint (includes all assets including planets)
      window.showLoadingSpinner && window.showLoadingSpinner();

      fetch('/api/v1/state/map-state-3d')
        .then(response => response.json())
        .then(data => {
          window.hideLoadingSpinner && window.hideLoadingSpinner();

          if (data.success) {
            // Transform map-state-3d format to legacy format for compatibility
            const allAssets = data.assets.map(asset => ({
              _id: asset.id,
              title: asset.title,
              assetType: asset.type,
              coordinates: {
                x: asset.x,
                y: asset.y,
                z: asset.z
              },
              renderData: asset.renderData,
              radius: asset.radius,
              parentId: asset.parentId,
              parentType: asset.parentType,
              parentGalaxy: asset.parentGalaxy,
              parentStar: asset.parentStar,
              orbitRadius: asset.orbitRadius,
              velocity: asset.velocity,
              localCoordinates: asset.localCoordinates,
              universalCoordinates: asset.universalCoordinates
            }));

            // Count asset types for logging
            const counts = allAssets.reduce((acc, a) => {
              acc[a.assetType] = (acc[a.assetType] || 0) + 1;
              return acc;
            }, {});

            console.log(`üì¶ Loaded ${allAssets.length} total assets:`, counts);
            window.galacticMap.allAssets = allAssets;

            // Setup view overrides BEFORE calling showGalacticLevel
            if (window.setupViewOverrides) {
              window.setupViewOverrides();
            }

            // Display assets at galactic level (galaxies and anomalies only, no stars)
            window.galacticMap.showGalacticLevel();

            // Populate sidebar asset selector
            if (window.populateAssetSelector) {
              setTimeout(() => window.populateAssetSelector(), 100);
            }

            // Load current simulation speed
            if (window.loadSimulationSpeed) {
              setTimeout(() => window.loadSimulationSpeed(), 100);
            }

            // Start animation loop
            window.galacticMap.animate();

            console.log('‚úÖ Galactic Map 3D initialized and assets loaded');
          } else {
            console.error('‚ùå Failed to load assets: Invalid response', data);
            window.updateLocationInfo && window.updateLocationInfo('UNIVERSE', 'Failed to load assets');
          }
        })
        .catch(err => {
          window.hideLoadingSpinner && window.hideLoadingSpinner();
          console.error('‚ùå Failed to load assets:', err);
          window.updateLocationInfo && window.updateLocationInfo('UNIVERSE', 'Error loading assets');
        });
    }

    // Start initialization check
    initializeGalacticMap();

    /**
     * Close info pane - DEPRECATED (info pane removed)
     */
    window.closeInfoPane = function() {
      console.log('‚ÑπÔ∏è closeInfoPane called but info pane has been removed');
    };

    /**
     * Show floating HUD next to star
     */
    window.showFloatingHUD = function(asset) {
      const hud = document.getElementById('floatingHUD');
      const canvas = document.getElementById('hudLineCanvas');

      // Get star position in 3D space
      const starObject = window.galacticMap?.assets?.get(asset._id);
      if (!starObject || !starObject.mesh) return;

      const starPos = starObject.mesh.position.clone();

      // Project 3D position to 2D screen coordinates
      const vector = starPos.clone();
      vector.project(window.galacticMap.camera);

      const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
      const y = (vector.y * -0.5 + 0.5) * window.innerHeight;

      // Position HUD offset to the right and slightly up from star
      const offsetX = 100;
      const offsetY = -50;

      hud.style.left = (x + offsetX) + 'px';
      hud.style.top = (y + offsetY) + 'px';
      hud.style.display = 'block';

      // Animate HUD entrance
      hud.style.opacity = '0';
      hud.style.transform = 'translateX(-20px) scale(0.9)';
      hud.style.transition = 'all 0.2s ease-out';

      setTimeout(() => {
        hud.style.opacity = '1';
        hud.style.transform = 'translateX(0) scale(1)';
      }, 10);

      // Update HUD content
      document.getElementById('hudTitle').textContent = `[${asset.title.toUpperCase()}]`;
      document.getElementById('hudType').textContent = `TYPE: ${asset.assetType.toUpperCase()}`;

      const coords = asset.localCoordinates || asset.coordinates;
      document.getElementById('hudCoords').textContent =
        `COORDS: [${Math.floor(coords.x)}, ${Math.floor(coords.y)}, ${Math.floor(coords.z)}]`;

      // Count assets within this star system
      const allAssets = window.galacticMap?.allAssets || [];
      const systemAssets = allAssets.filter(a => a.parentStar === asset._id);

      const planetCount = systemAssets.filter(a => a.assetType === 'planet').length;
      const stationCount = systemAssets.filter(a => a.assetType === 'station' || a.assetType === 'orbital').length;
      const shipCount = systemAssets.filter(a => a.assetType === 'ship').length;
      const totalCount = systemAssets.length;

      document.getElementById('hudPlanets').textContent = `PLANETS: ${planetCount}`;
      document.getElementById('hudStations').textContent = `STATIONS: ${stationCount}`;
      document.getElementById('hudShips').textContent = `SHIPS: ${shipCount}`;
      document.getElementById('hudTotal').textContent = `TOTAL: ${totalCount}`;

      // Draw connection line
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      canvas.style.display = 'block';

      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw line from star to HUD
      ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
      ctx.lineWidth = 1;
      ctx.setLineDash([5, 5]);

      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x + offsetX, y + offsetY + 20); // Connect to middle of HUD
      ctx.stroke();

      // Draw dot at star position
      ctx.fillStyle = 'rgba(0, 255, 0, 0.8)';
      ctx.beginPath();
      ctx.arc(x, y, 3, 0, Math.PI * 2);
      ctx.fill();
    };

    /**
     * Hide floating HUD
     */
    window.hideFloatingHUD = function() {
      const hud = document.getElementById('floatingHUD');
      const canvas = document.getElementById('hudLineCanvas');

      hud.style.display = 'none';
      canvas.style.display = 'none';

      // Clear canvas
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    /**
     * Display asset info - DEPRECATED (info pane removed)
     */
    window.displayAssetInfo = function(assetData) {
      console.log('‚ÑπÔ∏è displayAssetInfo called but info pane has been removed:', assetData.title, '| Type:', assetData.type);
      // Info pane functionality removed - all navigation is now direct
    };

    // Update UI based on map state - direct navigation only (info pane removed)
    window.addEventListener('assetSelected', (e) => {
      const assetData = e.detail;

      // Debug logging
      console.log('üìç Asset selected event:', {
        type: assetData.type,
        id: assetData.id,
        title: assetData.title,
        currentLevel: window.galacticMap?.currentLevel
      });

      // If clicking a galaxy at universe/galactic level, drill directly into galaxy view
      if (assetData.type === 'galaxy' && assetData.id &&
          (window.galacticMap?.currentLevel === 'universe' || window.galacticMap?.currentLevel === 'galactic')) {
        console.log(`üåå DRILL DOWN: Galaxy selected at ${window.galacticMap?.currentLevel} level - ${assetData.title}`);
        window.galacticMap.showGalaxyLevel(assetData.id);
        return; // EXIT
      }

      // If clicking a star in galaxy view, show modal instead of navigating
      // (The modal has a button to navigate to system-map-3d)
      if (assetData.type === 'star' && assetData.id) {
        if (window.galacticMap?.currentLevel === 'galaxy') {
          console.log(`‚≠ê MODAL: Star selected in galaxy view - ${assetData.title} (showing modal)`);
          // Modal is shown by galactic-map-3d.js, don't navigate here
          return; // EXIT
        } else {
          // For other levels (universe/galactic), navigate directly
          console.log(`üî≠ NAVIGATE: Star selected - ${assetData.title}`);
          window.location.href = `/universe/system-map-3d?star=${assetData.id}`;
          return; // EXIT
        }
      }

      // For other assets (anomalies, zones, etc.), just log - no info pane
      console.log(`‚ÑπÔ∏è Asset clicked: ${assetData.type} - ${assetData.title} (info pane removed)`);

      // OPTIONAL: Also update sidebar selected asset section (minimized version)
      const selectedAssetInfo = document.getElementById('selectedAssetInfo');
      const selectedAssetContent = document.getElementById('selectedAssetContent');
      const selectedAssetArrow = document.getElementById('selectedAssetArrow');

      if (selectedAssetInfo) {
        let html = `
          <h2 style="margin: 0 0 8px 0; font-size: 14px; color: #ff6600;">${assetData.title || 'Unknown Asset'}</h2>
          <span style="display: inline-block; padding: 2px 8px; background: rgba(255, 102, 0, 0.2); border: 1px solid #ff6600; border-radius: 3px; font-size: 10px; margin-bottom: 10px; color: #ff6600; text-transform: uppercase;">${assetData.type || 'unknown'}</span>
        `;

        if (assetData.data?.coordinates) {
          const { x, y, z } = assetData.data.coordinates;
          html += `
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span style="color: #888;">Position:</span>
              <span style="color: #00ddff; font-weight: bold;">${x.toFixed(1)}, ${y.toFixed(1)}, ${z.toFixed(1)}</span>
            </div>
          `;
        }

        selectedAssetInfo.innerHTML = html;

        // Auto-expand the section
        if (selectedAssetContent.style.display === 'none') {
          selectedAssetContent.style.display = 'block';
          selectedAssetArrow.textContent = '‚ñº';
          selectedAssetArrow.style.transform = 'rotate(0deg)';
        }

        console.log('‚úÖ Asset selected in sidebar:', assetData.title);
      }
    });

    window.addEventListener('assetDeselected', () => {
      // Reset sidebar selected asset section
      const selectedAssetInfo = document.getElementById('selectedAssetInfo');
      if (selectedAssetInfo) {
        selectedAssetInfo.innerHTML = '<div style="text-align: center; color: #888; padding: 20px 0;">Click an asset to view details</div>';
      }

      window.closeInfoPane();
    });

    // Hover events - DISABLED (unnecessary HUD)
    // window.addEventListener('assetHovered', (e) => {
    //   const asset = e.detail.asset;
    //   window.showFloatingHUD(asset);
    // });

    // window.addEventListener('assetHoverEnd', () => {
    //   window.hideFloatingHUD();
    // });

    // Backdrop click listener removed (info pane removed)


    // ESC to deselect
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && window.galacticMap) {
        window.galacticMap.deselectObject();
      }
      // Home key or 'H' - Focus on current player
      if ((e.key === 'Home' || e.key === 'h' || e.key === 'H') && window.galacticMap) {
        console.log('üéØ Keyboard shortcut: Focus on player');
        window.galacticMap.focusOnCurrentPlayer();
      }
    });

    // Wire up control buttons
    document.getElementById('zoomInBtn').addEventListener('click', () => {
      if (window.galacticMap) {
        window.galacticMap.camera.zoom *= 1.2;
        window.galacticMap.camera.updateProjectionMatrix();
      }
    });

    document.getElementById('zoomOutBtn').addEventListener('click', () => {
      if (window.galacticMap) {
        window.galacticMap.camera.zoom /= 1.2;
        window.galacticMap.camera.updateProjectionMatrix();
      }
    });

    // Locate Me button - focus on player character
    document.getElementById('locateMeBtn').addEventListener('click', () => {
      if (!window.currentCharacter || !window.currentCharacter.location) {
        alert('No character location available. Make sure you have an active character.');
        return;
      }

      if (!window.galacticMap) {
        return;
      }

      console.log(`üìç Locating player: ${window.currentCharacter.name}`);

      // Use the new focusOnCurrentPlayer method
      window.galacticMap.focusOnCurrentPlayer();

      // Show notification
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 255, 0, 0.2);
        border: 1px solid #00ff00;
        border-radius: 8px;
        padding: 10px 20px;
        color: #00ff00;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        z-index: 10000;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      `;
      notification.textContent = `üìç Located: ${window.currentCharacter.name}`;
      document.body.appendChild(notification);

      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, 2000);
    });

    // toggleOverlayMenu is now defined earlier in the script (line 592)

    // Layer visibility controls
    let orbitsVisible = true;
    let velocityVisible = true;
    let connectionsVisible = true;

    document.getElementById('toggleOrbitsBtn').addEventListener('click', () => {
      orbitsVisible = !orbitsVisible;
      if (window.galacticMap && window.galacticMap.scene) {
        // Find all orbital path objects
        window.galacticMap.scene.traverse((obj) => {
          if (obj.userData && obj.userData.isOrbitalPath) {
            obj.visible = orbitsVisible;
          }
        });
      }
      const btn = document.getElementById('toggleOrbitsBtn');
      btn.style.opacity = orbitsVisible ? '1.0' : '0.5';
      console.log(`Orbital paths ${orbitsVisible ? 'shown' : 'hidden'}`);
    });

    document.getElementById('toggleVelocityBtn').addEventListener('click', () => {
      velocityVisible = !velocityVisible;
      if (window.galacticMap && window.galacticMap.scene) {
        // Find all velocity arrow objects
        window.galacticMap.scene.traverse((obj) => {
          if (obj.userData && obj.userData.isVelocityArrow) {
            obj.visible = velocityVisible;
          }
        });
      }
      const btn = document.getElementById('toggleVelocityBtn');
      btn.style.opacity = velocityVisible ? '1.0' : '0.5';
      console.log(`Velocity arrows ${velocityVisible ? 'shown' : 'hidden'}`);
    });

    document.getElementById('toggleConnectionsBtn').addEventListener('click', () => {
      connectionsVisible = !connectionsVisible;
      if (window.galacticMap && window.galacticMap.connectionsGroup) {
        window.galacticMap.connectionsGroup.visible = connectionsVisible;
      }
      const btn = document.getElementById('toggleConnectionsBtn');
      btn.style.opacity = connectionsVisible ? '1.0' : '0.5';
      console.log(`Connections ${connectionsVisible ? 'shown' : 'hidden'}`);
    });

    // Asset selector - view selected galaxy/anomaly with floating HUD
    const assetSelectorElement = document.getElementById('assetSelector');
    if (assetSelectorElement) {
      assetSelectorElement.addEventListener('change', (e) => {
        const assetId = e.target.value;
        if (!assetId || !window.galacticMap) return;

        console.log('üîç Asset selected from sidebar:', assetId);

        // Find the asset in the scene
        const assetObject = window.galacticMap.assets.get(assetId);
        if (assetObject && assetObject.mesh) {
          const assetPos = assetObject.mesh.position;
          const assetData = assetObject.mesh.userData;

          console.log(`üìç Focusing on ${assetData.title} at (${assetPos.x}, ${assetPos.y}, ${assetPos.z})`);

          // Focus camera on the asset
          window.galacticMap.camera.position.set(
            assetPos.x,
            assetPos.y + 1000,
            assetPos.z + 500
          );

          if (window.galacticMap.controls) {
            window.galacticMap.controls.target.copy(assetPos);
            window.galacticMap.controls.update();
          }

          // Select the object (highlights it)
          window.galacticMap.selectObject(assetObject.mesh);

          // Show the sleek floating HUD instead of info pane
          // Find the asset in allAssets to get full data
          const fullAssetData = window.galacticMap.allAssets.find(a => a._id === assetId);
          if (fullAssetData && window.showFloatingHUD) {
            window.showFloatingHUD(fullAssetData);
          }

          // Update sidebar selected section
          window.dispatchEvent(new CustomEvent('assetSelected', {
            detail: {
              title: assetData.title,
              type: assetData.type,
              data: {
                _id: assetData.id,
                coordinates: assetPos
              }
            }
          }));
        } else {
          console.warn('‚ö†Ô∏è Asset not found in scene:', assetId);
        }

        // Reset selector
        e.target.value = '';
      });
      console.log('‚úÖ Asset selector event listener attached');
    }

    // ========================================
    // Socket.IO Setup for Real-Time Players
    // ========================================
    console.log('üîç Socket.IO setup section reached! user=' + <%= user ? 'true' : 'false' %>);
    <% if (user) { %>
    console.log('üîå Initializing Socket.IO connection (logged in user)...');
    console.log('üîç typeof io:', typeof io);

    // Initialize Socket.IO
    const socket = io({
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      reconnectionAttempts: 10
    });

    console.log('‚úÖ Socket object created:', socket);

    socket.on('connect', () => {
      console.log('‚úÖ Socket.IO CONNECTED! ID:', socket.id);
    });

    socket.on('connect_error', (err) => {
      console.error('‚ùå Socket.IO connection error:', err.message);
    });

    socket.on('disconnect', (reason) => {
      console.warn('‚ö†Ô∏è Socket.IO disconnected:', reason);
    });

    const userObj = {
      _id: '<%= user._id %>',
      id: '<%= user._id %>',
      username: '<%= user.username %>',
      userRole: '<%= user.userRole %>'
    };

    // Handle Socket.IO connection events
    socket.on('connect_error', (error) => {
      console.error('‚ùå Socket.IO connection error:', error);
    });

    socket.on('disconnect', (reason) => {
      console.warn('‚ö†Ô∏è Socket.IO disconnected:', reason);
    });

    socket.on('reconnect', (attemptNumber) => {
      console.log('üîÑ Socket.IO reconnected after', attemptNumber, 'attempts');
    });

    // Load current character and emit join event
    socket.on('connect', async () => {
      console.log('‚úÖ Socket.IO connected - CHARACTER LOADING HANDLER:', socket.id);

      try {
        console.log('üîç Fetching current character from /api/v1/characters/current...');
        // Fetch current character
        const response = await fetch('/api/v1/characters/current');
        console.log('üì• Character API response status:', response.status);
        const data = await response.json();
        console.log('üì¶ Character API data:', data);

        if (data.success && data.character) {
          const character = data.character;
          console.log('üìç Current character loaded:', character.name, 'at', character.location);

          // Store character globally
          window.currentCharacter = character;
          window.currentCharacterId = character._id; // For easy comparison in rendering

          // Initialize GameStateMonitor with socket and current character
          if (window.gameStateMonitor && !window.gameStateMonitor.connected) {
            window.gameStateMonitor.init(socket, character._id);
            console.log('üéÆ GameStateMonitor initialized for galactic-map-3d (AUTHORITATIVE)');
          }

          // Initialize Global Chat for all users
          if (typeof initGlobalChat === 'function' && !window.globalChat) {
            window.globalChat = initGlobalChat(socket, userObj, character);
            console.log('üí¨ Global Chat initialized and available to all users');
          }

          // Add player character to 3D map
          console.log('üó∫Ô∏è Attempting to add character to galactic map...', {
            hasMap: !!window.galacticMap,
            hasLocation: !!character.location,
            location: character.location
          });
          if (window.galacticMap && character.location) {
            window.galacticMap.addPlayerCharacter(character);
            console.log('‚úÖ Character added to galactic map!');
          } else {
            console.warn('‚ö†Ô∏è Cannot add character to map:', {
              mapExists: !!window.galacticMap,
              locationExists: !!character.location
            });
          }

          // Emit character join event
          if (character.location) {
            socket.emit('characterJoin', {
              characterId: character._id,
              characterName: character.name,
              userId: userObj._id,
              location: character.location,
              assetId: character.location.assetId || null,
              stringDomain: character.stringDomain || 'Time String'
            });
          }
        } else {
          console.log('‚ö†Ô∏è No active character found');
        }
      } catch (error) {
        console.error('‚ùå Error loading character:', error);
      }
    });

    // GameStateMonitor handles socket events, but keep map updates here for galactic-map-3d (authoritative view)
    // Subscribe to GameStateMonitor events to update the 3D map
    if (window.gameStateMonitor) {
      // Update map when players join
      window.gameStateMonitor.on('playerJoined', (data) => {
        if (window.galacticMap && data.location) {
          window.galacticMap.updatePlayerPosition(data.characterId, data.location, data.characterName);
        }
      });

      // Update map when players move
      window.gameStateMonitor.on('playerPositionUpdate', (data) => {
        if (window.galacticMap && data.characterId !== window.currentCharacter?._id) {
          window.galacticMap.updatePlayerPosition(data.characterId, data.position, data.characterName);
        }
      });

      // Remove player from map when they leave
      window.gameStateMonitor.on('playerLeft', (data) => {
        if (window.galacticMap) {
          window.galacticMap.removePlayer(data.characterId);
        }
      });

      // Sync all players on state sync
      window.gameStateMonitor.on('stateSync', (data) => {
        if (window.galacticMap && data.players) {
          data.players.forEach(player => {
            if (player.characterId !== window.currentCharacter?._id) {
              window.galacticMap.updatePlayerPosition(player.characterId, player.position, player.characterName);
            }
          });
        }
      });
    }

    // Legacy socket listeners (GameStateMonitor handles the data, these are for backwards compatibility)
    socket.on('onlinePlayers', (players) => {
      console.log('üì° Received online players:', players.length);
      // GameStateMonitor will handle this
    });

    socket.on('playerMoved', (data) => {
      console.log('üì° Player moved:', data.characterName);
      // GameStateMonitor will handle this
    });

    // Note: galacticPhysicsUpdate listener is registered via initializeSocket() above
    // The centralized handler in GalacticMap3D will manage all physics updates

    // Listen for simulation speed changes from server
    socket.on('simulationSpeedChanged', (data) => {
      const slider = document.getElementById('simSpeedSlider');
      const display = document.getElementById('simSpeedDisplay');

      if (slider && display) {
        slider.value = data.speed;
        display.textContent = data.speed.toFixed(1) + 'x';
      }

      console.log(`‚ö° Simulation speed updated by server: ${data.speed.toFixed(1)}x`);
    });

    // Initialize socket connection with galactic map (if map is ready)
    if (window.galacticMap) {
      window.galacticMap.initializeSocket(socket);
      console.log('‚úÖ Socket initialized with galactic map');
    } else {
      console.warn('‚ö†Ô∏è Galactic map not ready yet, socket will be connected when map initializes');
      // Wait for map to be ready
      const checkMapInterval = setInterval(() => {
        if (window.galacticMap) {
          window.galacticMap.initializeSocket(socket);
          console.log('‚úÖ Socket initialized with galactic map (delayed)');
          clearInterval(checkMapInterval);
        }
      }, 100);
    }

    // Store socket globally for other components
    window.socket = socket;
    <% } else { %>
    // Socket.IO for non-logged-in users (physics updates only)
    console.log('üîå Initializing Socket.IO connection (guest mode)...');
    const socket = io({
      reconnection: true,
      reconnectionDelay: 1000
    });

    socket.on('connect', () => {
      console.log('‚úÖ Socket.IO connected (guest mode)');
    });

    socket.on('disconnect', () => {
      console.log('‚ùå Socket.IO disconnected');
    });

    // Listen for simulation speed changes (guest mode doesn't control, but can observe)
    socket.on('simulationSpeedChanged', (data) => {
      console.log(`‚ö° Simulation speed updated: ${data.speed.toFixed(1)}x`);
    });

    // Initialize socket connection for physics updates
    if (window.galacticMap) {
      window.galacticMap.initializeSocket(socket);
      console.log('‚úÖ Socket initialized with galactic map (guest mode)');
    } else {
      console.warn('‚ö†Ô∏è galacticMap not ready, socket will be initialized later (guest mode)');
      // Wait for map to be ready
      const checkMapInterval = setInterval(() => {
        if (window.galacticMap) {
          window.galacticMap.initializeSocket(socket);
          console.log('‚úÖ Socket initialized with galactic map (guest mode, delayed)');
          clearInterval(checkMapInterval);
        }
      }, 100);
    }

    window.socket = socket;
    <% } %>

    // ========================================
    // Travel Function
    // ========================================
    window.travelToLocation = async function(x, y, z, destinationName) {
      if (!window.currentCharacter) {
        alert('No active character. Please select a character first.');
        return;
      }

      const characterId = window.currentCharacter._id;
      const startPos = window.currentCharacter.location || { x: 0, y: 0, z: 0 };
      const endPos = { x, y, z };

      console.log(`üöÄ Traveling to ${destinationName} at (${x}, ${y}, ${z})`);

      // Close info pane
      window.closeInfoPane();

      // Show travel progress UI - Terminal HUD style
      const progressDiv = document.createElement('div');
      progressDiv.id = 'travelProgress';
      progressDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.85);
        border: 1px solid #00ff00;
        border-left: 4px solid #00ff00;
        font-family: 'Courier New', monospace;
        padding: 15px 20px;
        z-index: 10000;
        min-width: 350px;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        backdrop-filter: blur(5px);
      `;
      progressDiv.innerHTML = `
        <div style="color: #00ff00; font-size: 11px; margin-bottom: 8px; opacity: 0.7;">
          [NAVIGATION SYSTEM]
        </div>
        <div style="color: #00ff00; font-size: 14px; margin-bottom: 12px; font-weight: bold;">
          > DESTINATION: ${destinationName}
        </div>
        <div style="color: #888; font-size: 12px; margin-bottom: 5px;">
          STATUS: <span style="color: #ffaa00;">IN_TRANSIT</span>
        </div>
        <div style="display: flex; align-items: center; margin: 10px 0;">
          <span style="color: #888; font-size: 12px; margin-right: 10px;">PROGRESS:</span>
          <div style="flex: 1; background: #111; border: 1px solid #00ff00; height: 18px; position: relative; overflow: hidden;">
            <div id="travelProgressBar" style="
              background: #00ff00;
              height: 100%;
              width: 0%;
              transition: width 0.1s linear;
              box-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
            "></div>
          </div>
          <span id="travelProgressText" style="color: #00ff00; font-size: 12px; margin-left: 10px; min-width: 45px;">
            0%
          </span>
        </div>
        <div style="color: #666; font-size: 11px; margin-top: 8px;">
          ETA: <span id="travelETA" style="color: #888;">15.0s</span>
        </div>
      `;
      document.body.appendChild(progressDiv);

      const progressBar = document.getElementById('travelProgressBar');
      const progressText = document.getElementById('travelProgressText');
      const etaText = document.getElementById('travelETA');

      try {
        // Start animated travel
        window.galacticMap.animateTravel(
          characterId,
          startPos,
          endPos,
          window.currentCharacter.name,
          // On progress callback
          (posData) => {
            const percent = Math.round(posData.progress * 100);
            progressBar.style.width = percent + '%';
            progressText.textContent = percent + '%';

            // Update ETA countdown
            const remainingTime = 15 * (1 - posData.progress);
            etaText.textContent = remainingTime.toFixed(1) + 's';

            // Emit position updates to Socket.IO every 500ms
            if (window.socket && Date.now() % 500 < 100) {
              window.socket.emit('playerMove', {
                characterId: characterId,
                characterName: window.currentCharacter.name,
                location: { x: posData.x, y: posData.y, z: posData.z, type: 'galactic' }
              });
            }
          },
          // On complete callback
          async () => {
            // Update character location in database
            const response = await fetch(`/api/v1/characters/${characterId}/location`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                x: x,
                y: y,
                z: z,
                type: 'galactic'
              })
            });

            const data = await response.json();

            if (data.success) {
              console.log(`‚úÖ Traveled to ${destinationName}`);

              // Update local character position
              window.currentCharacter.location = { x, y, z, type: 'galactic' };

              // Final position emit to Socket.IO
              if (window.socket) {
                window.socket.emit('playerMove', {
                  characterId: characterId,
                  characterName: window.currentCharacter.name,
                  location: { x, y, z, type: 'galactic' }
                });
              }

              // Remove progress UI
              if (progressDiv && progressDiv.parentNode) {
                document.body.removeChild(progressDiv);
              }

              // Remove any existing success notifications
              const existingSuccess = document.getElementById('arrivalNotification');
              if (existingSuccess && existingSuccess.parentNode) {
                document.body.removeChild(existingSuccess);
              }

              // Find the destination object
              const destinationObject = window.galacticMap.findObjectAtPosition({ x, y, z }, 100);

              if (destinationObject) {
                // Create dramatic arrival effect with spiral zoom
                window.galacticMap.createArrivalEffect(destinationObject, () => {
                  // After spiral effect, select the object to show info pane
                  window.galacticMap.selectObject(destinationObject);
                });
              }

              // Show success message - bottom-left terminal style
              const successDiv = document.createElement('div');
              successDiv.id = 'arrivalNotification';
              successDiv.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: rgba(0, 0, 0, 0.85);
                border: 1px solid #00ff00;
                border-left: 4px solid #00ff00;
                font-family: 'Courier New', monospace;
                padding: 15px 20px;
                color: #00ff00;
                z-index: 10000;
                box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
                backdrop-filter: blur(5px);
                min-width: 300px;
              `;

              // Safely escape destination name
              const safeDestName = String(destinationName).replace(/[<>&"']/g, (c) => {
                return {'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;', "'":"&#39;"}[c];
              });

              successDiv.innerHTML = `
                <div style="color: #00ff00; font-size: 11px; margin-bottom: 5px; opacity: 0.7;">
                  [NAVIGATION SYSTEM]
                </div>
                <div style="color: #00ff00; font-size: 13px;">
                  > ARRIVAL CONFIRMED
                </div>
                <div style="color: #888; font-size: 12px; margin-top: 5px;">
                  LOCATION: ${safeDestName}
                </div>
              `;
              document.body.appendChild(successDiv);

              setTimeout(() => {
                if (successDiv && successDiv.parentNode) {
                  document.body.removeChild(successDiv);
                }
              }, 3000);
            } else {
              document.body.removeChild(progressDiv);
              alert('Failed to save travel location: ' + (data.error || 'Unknown error'));
            }
          }
        );
      } catch (error) {
        console.error('Error traveling:', error);
        document.body.removeChild(progressDiv);
        alert('Failed to travel. Check console for details.');
      }
    };

    // ========================================
    // Breadcrumb Navigation System
    // ========================================
    window.updateBreadcrumb = function(level, galaxyName, starName) {
      const breadcrumb = document.getElementById('breadcrumbNav');
      if (!breadcrumb) return;

      // Clear current breadcrumb (except [LOCATION] label)
      breadcrumb.innerHTML = '<span style="color: #666; font-size: 10px;">[LOCATION]</span>';

      const separator = '<span style="color: #444; margin: 0 3px; font-size: 10px;">‚Ä∫</span>';

      // Galactic level (always present - top level in current implementation)
      const galacticSpan = document.createElement('span');
      galacticSpan.className = 'breadcrumb-item';
      galacticSpan.textContent = 'GALACTIC';
      galacticSpan.style.cssText = `
        color: ${level === 'galactic' ? '#00ff00' : '#888'};
        cursor: pointer;
        padding: 3px 8px;
        border-radius: 6px;
        transition: all 0.2s;
        font-size: 11px;
        ${level === 'galactic' ? 'background: rgba(0, 255, 0, 0.1);' : ''}
      `;
      galacticSpan.onclick = () => {
        if (window.galacticMap) {
          window.galacticMap.showGalacticLevel();
        }
      };
      galacticSpan.onmouseenter = function() {
        if (level !== 'galactic') this.style.background = 'rgba(136, 136, 136, 0.1)';
      };
      galacticSpan.onmouseleave = function() {
        if (level !== 'galactic') this.style.background = 'transparent';
      };
      breadcrumb.appendChild(galacticSpan);

      // Galaxy level
      if (level === 'galaxy' || level === 'system') {
        breadcrumb.innerHTML += separator;

        const galaxySpan = document.createElement('span');
        galaxySpan.className = 'breadcrumb-item';
        galaxySpan.textContent = galaxyName || 'GALAXY';
        galaxySpan.style.cssText = `
          color: ${level === 'galaxy' ? '#00ff00' : '#888'};
          cursor: pointer;
          padding: 3px 8px;
          border-radius: 6px;
          transition: all 0.2s;
          font-size: 11px;
          ${level === 'galaxy' ? 'background: rgba(0, 255, 0, 0.1);' : ''}
        `;
        galaxySpan.onclick = () => {
          if (window.galacticMap && window.galacticMap.selectedGalaxyId) {
            window.galacticMap.showGalaxyLevel(window.galacticMap.selectedGalaxyId);
          }
        };
        galaxySpan.onmouseenter = function() {
          if (level !== 'galaxy') this.style.background = 'rgba(136, 136, 136, 0.1)';
        };
        galaxySpan.onmouseleave = function() {
          if (level !== 'galaxy') this.style.background = 'transparent';
        };
        breadcrumb.appendChild(galaxySpan);
      }

      // Star system level
      if (level === 'system') {
        breadcrumb.innerHTML += separator;

        const systemSpan = document.createElement('span');
        systemSpan.className = 'breadcrumb-item';
        systemSpan.textContent = starName || 'SYSTEM';
        systemSpan.style.cssText = `
          color: #00ff00;
          padding: 3px 8px;
          border-radius: 6px;
          background: rgba(0, 255, 0, 0.1);
          font-size: 11px;
        `;
        breadcrumb.appendChild(systemSpan);
      }
    };

    // Initialize breadcrumb (deferred to allow DOM to load)
    setTimeout(() => {
      if (window.updateBreadcrumb) {
        window.updateBreadcrumb('galactic');
      }
    }, 100);

    // Navigation confirmation system already initialized early in the page

    // Add hover effects to confirmation buttons - with null checks
    const confirmBtn = document.getElementById('confirmNavigateBtn');
    const cancelBtn = document.getElementById('cancelNavigateBtn');

    if (confirmBtn) {
      confirmBtn.addEventListener('mouseenter', () => {
        confirmBtn.style.background = 'linear-gradient(135deg, rgba(255, 102, 0, 0.5), rgba(255, 68, 0, 0.5))';
        confirmBtn.style.transform = 'translateY(-2px)';
        confirmBtn.style.boxShadow = '0 4px 15px rgba(255, 102, 0, 0.4)';
      });

      confirmBtn.addEventListener('mouseleave', () => {
        confirmBtn.style.background = 'linear-gradient(135deg, rgba(255, 102, 0, 0.3), rgba(255, 68, 0, 0.3))';
        confirmBtn.style.transform = 'translateY(0)';
        confirmBtn.style.boxShadow = 'none';
      });
    }

    if (cancelBtn) {
      cancelBtn.addEventListener('mouseenter', () => {
        cancelBtn.style.background = 'linear-gradient(135deg, rgba(138, 79, 255, 0.5), rgba(74, 158, 255, 0.5))';
        cancelBtn.style.transform = 'translateY(-2px)';
        cancelBtn.style.boxShadow = '0 4px 15px rgba(138, 79, 255, 0.4)';
      });

      cancelBtn.addEventListener('mouseleave', () => {
        cancelBtn.style.background = 'linear-gradient(135deg, rgba(138, 79, 255, 0.3), rgba(74, 158, 255, 0.3))';
        cancelBtn.style.transform = 'translateY(0)';
        cancelBtn.style.boxShadow = 'none';
      });
    }

    // Add hover effects to menu items
    const menuItems = document.querySelectorAll('.overlay-menu-item');
    menuItems.forEach(item => {
      item.addEventListener('mouseenter', function() {
        this.style.background = 'rgba(138, 79, 255, 0.15)';
        this.style.transform = 'translateX(5px)';
      });

      item.addEventListener('mouseleave', function() {
        this.style.background = 'transparent';
        this.style.transform = 'translateX(0)';
      });
    });

    // Tome overlay system already initialized early in the page

    // Verify all navigation elements are present
    const navDialog = document.getElementById('navigationConfirmDialog');
    const overlayMenu = document.getElementById('overlayMenu');
    const overlayBackdrop = document.getElementById('overlayBackdrop');

    console.log('‚úÖ Navigation confirmation system initialized');
    console.log('   üìã Dialog:', navDialog ? '‚úì' : '‚úó');
    console.log('   üìã Confirm Button:', confirmBtn ? '‚úì' : '‚úó');
    console.log('   üìã Cancel Button:', cancelBtn ? '‚úì' : '‚úó');
    console.log('   üìã Overlay Menu:', overlayMenu ? '‚úì' : '‚úó');
    console.log('   üìã Overlay Backdrop:', overlayBackdrop ? '‚úì' : '‚úó');
    console.log('   üìã Menu Items:', menuItems.length);

    // ========================================
    // LIVE UNIVERSE STATE INTEGRATION
    // ========================================

    /**
     * Live Universe State Manager
     * Connects to game-state-service for real-time universe simulation
     */
    class LiveUniverseManager {
      constructor() {
        this.gameStateUrl = 'http://localhost:3500';
        this.eventSource = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 10;
        this.reconnectDelay = 3000;
        this.isConnected = false;

        // State data
        this.galacticState = null;
        this.factions = null;
        this.events = [];
        this.resources = null;

        // UI elements
        this.statusIndicator = null;
        this.eventFeed = null;
        this.factionPanel = null;

        this.init();
      }

      init() {
        console.log('üåå Initializing Live Universe Manager...');
        this.createUI();
        this.connectToGameState();
      }

      createUI() {
        // Create status indicator
        this.statusIndicator = document.createElement('div');
        this.statusIndicator.id = 'liveUniverseStatus';
        this.statusIndicator.style.cssText = `
          position: fixed;
          bottom: 20px;
          left: 20px;
          background: rgba(0, 0, 0, 0.9);
          border: 2px solid #ff6600;
          border-radius: 8px;
          padding: 10px 15px;
          color: #ff6600;
          font-family: 'Courier New', monospace;
          font-size: 11px;
          z-index: 1000;
          display: flex;
          align-items: center;
          gap: 8px;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        `;
        this.statusIndicator.innerHTML = '<span id="statusDot" style="width: 8px; height: 8px; border-radius: 50%; background: #ff6600; animation: pulse 2s infinite;"></span><span id="statusText">Connecting to Universe...</span>';
        document.body.appendChild(this.statusIndicator);

        // Add pulse animation
        const style = document.createElement('style');
        style.textContent = `
          @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
          }
          @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);

        // Create live event feed
        this.eventFeed = document.createElement('div');
        this.eventFeed.id = 'liveEventFeed';
        this.eventFeed.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          width: 320px;
          max-height: 400px;
          background: rgba(0, 0, 0, 0.95);
          border: 2px solid #00ff9f;
          border-radius: 8px;
          padding: 15px;
          color: #00ff9f;
          font-family: 'Courier New', monospace;
          font-size: 10px;
          z-index: 999;
          overflow-y: auto;
          backdrop-filter: blur(10px);
          box-shadow: 0 0 30px rgba(0, 255, 159, 0.3);
        `;
        this.eventFeed.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid rgba(0, 255, 159, 0.3); padding-bottom: 8px;">
            <h3 style="margin: 0; font-size: 12px; color: #00ff9f;">üì° LIVE EVENTS</h3>
            <div id="galacticCycle" style="font-size: 10px; color: #00ff9f; opacity: 0.7;">Cycle: ---</div>
          </div>
          <div id="eventList" style="display: flex; flex-direction: column; gap: 8px;"></div>
        `;
        document.body.appendChild(this.eventFeed);

        // Create faction status panel
        this.factionPanel = document.createElement('div');
        this.factionPanel.id = 'liveFactionPanel';
        this.factionPanel.style.cssText = `
          position: fixed;
          bottom: 70px;
          left: 20px;
          width: 300px;
          background: rgba(0, 0, 0, 0.95);
          border: 2px solid #8a4fff;
          border-radius: 8px;
          padding: 15px;
          color: #8a4fff;
          font-family: 'Courier New', monospace;
          font-size: 10px;
          z-index: 999;
          backdrop-filter: blur(10px);
          box-shadow: 0 0 30px rgba(138, 79, 255, 0.3);
        `;
        this.factionPanel.innerHTML = `
          <h3 style="margin: 0 0 10px 0; font-size: 12px; color: #8a4fff; border-bottom: 1px solid rgba(138, 79, 255, 0.3); padding-bottom: 5px;">‚öîÔ∏è FACTION POWER</h3>
          <div id="factionBars"></div>
        `;
        document.body.appendChild(this.factionPanel);
      }

      connectToGameState() {
        if (this.eventSource) {
          this.eventSource.close();
        }

        console.log('üì° Connecting to Game State Service...');
        this.updateStatus('Connecting...', '#ff6600');

        try {
          // Connect to SSE stream
          this.eventSource = new EventSource(`${this.gameStateUrl}/api/stream/state`);

          this.eventSource.onopen = () => {
            console.log('‚úÖ Connected to Game State Service');
            this.isConnected = true;
            this.reconnectAttempts = 0;
            this.updateStatus('LIVE', '#00ff00');
          };

          this.eventSource.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              this.handleStateUpdate(data);
            } catch (error) {
              console.error('‚ùå Error parsing state update:', error);
            }
          };

          this.eventSource.onerror = (error) => {
            console.error('‚ùå Game State connection error:', error);
            this.isConnected = false;
            this.updateStatus('Disconnected', '#ff0000');
            this.eventSource.close();
            this.attemptReconnect();
          };

          // Also connect to event stream
          this.connectToEventStream();

        } catch (error) {
          console.error('‚ùå Failed to connect to Game State Service:', error);
          this.updateStatus('Error', '#ff0000');
          this.attemptReconnect();
        }
      }

      connectToEventStream() {
        const eventStream = new EventSource(`${this.gameStateUrl}/api/stream/events`);

        eventStream.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === 'event' && data.event) {
              this.addEvent(data.event);
            } else if (data.type === 'init' && data.events) {
              this.events = data.events;
              this.updateEventFeed();
            }
          } catch (error) {
            console.error('‚ùå Error parsing event:', error);
          }
        };
      }

      attemptReconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
          console.error('‚ùå Max reconnection attempts reached');
          this.updateStatus('Failed', '#ff0000');
          return;
        }

        this.reconnectAttempts++;
        const delay = this.reconnectDelay * this.reconnectAttempts;

        console.log(`üîÑ Reconnecting in ${delay/1000}s (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
        this.updateStatus(`Retry ${this.reconnectAttempts}...`, '#ffaa00');

        setTimeout(() => {
          this.connectToGameState();
        }, delay);
      }

      handleStateUpdate(data) {
        if (data.type === 'init') {
          console.log('üì¶ Received initial state:', data.state);
          this.galacticState = data.state.galactic;
          this.factions = data.state.factions;
          this.resources = data.state.resources;
          this.events = data.state.events || [];

          this.updateAllUI();
        } else if (data.type === 'update') {
          console.log('üîÑ Received state update');

          if (data.galactic) this.galacticState = data.galactic;
          if (data.factions) this.factions = data.factions;
          if (data.resources) this.resources = data.resources;

          this.updateAllUI();
        }
      }

      updateAllUI() {
        this.updateGalacticInfo();
        this.updateFactionBars();
        this.updateEventFeed();
      }

      updateGalacticInfo() {
        if (!this.galacticState) return;

        const cycleEl = document.getElementById('galacticCycle');
        if (cycleEl) {
          cycleEl.textContent = `Cycle: ${this.galacticState.cycle} | Year: ${this.galacticState.year}`;
        }
      }

      updateFactionBars() {
        if (!this.factions) return;

        const barsContainer = document.getElementById('factionBars');
        if (!barsContainer) return;

        barsContainer.innerHTML = '';

        // Sort factions by power
        const sortedFactions = Object.entries(this.factions)
          .sort((a, b) => b[1].power - a[1].power);

        sortedFactions.forEach(([name, data]) => {
          const factionEl = document.createElement('div');
          factionEl.style.marginBottom = '8px';

          const power = Math.round(data.power);
          const color = this.getFactionColor(name);

          factionEl.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 9px;">
              <span style="color: ${color};">${name}</span>
              <span style="color: #fff; font-weight: bold;">${power}%</span>
            </div>
            <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
              <div style="width: ${power}%; height: 100%; background: linear-gradient(90deg, ${color}, ${this.lightenColor(color)}); transition: width 0.5s ease;"></div>
            </div>
          `;

          barsContainer.appendChild(factionEl);
        });
      }

      updateEventFeed() {
        const eventList = document.getElementById('eventList');
        if (!eventList || !this.events) return;

        eventList.innerHTML = '';

        // Show last 5 events
        const recentEvents = this.events.slice(0, 5);

        recentEvents.forEach((event, index) => {
          const eventEl = document.createElement('div');
          eventEl.style.cssText = `
            padding: 8px;
            background: rgba(0, 255, 159, 0.05);
            border-left: 3px solid ${this.getEventColor(event.severity)};
            border-radius: 4px;
            font-size: 10px;
            animation: slideIn 0.3s ease forwards;
            animation-delay: ${index * 0.1}s;
            opacity: 0;
          `;

          const icon = this.getEventIcon(event.type);
          const time = new Date(event.timestamp).toLocaleTimeString();

          eventEl.innerHTML = `
            <div style="display: flex; justify-content: between; align-items: start; gap: 8px;">
              <span style="font-size: 14px;">${icon}</span>
              <div style="flex: 1;">
                <div style="color: ${this.getEventColor(event.severity)}; margin-bottom: 3px; font-weight: bold;">
                  ${event.type.toUpperCase()} [${event.severity.toUpperCase()}]
                </div>
                <div style="color: #00ff9f; line-height: 1.4;">${event.message}</div>
                <div style="color: #00ff9f; opacity: 0.5; font-size: 8px; margin-top: 3px;">${time}</div>
              </div>
            </div>
          `;

          eventList.appendChild(eventEl);
        });
      }

      addEvent(event) {
        this.events.unshift(event);
        if (this.events.length > 20) {
          this.events = this.events.slice(0, 20);
        }
        this.updateEventFeed();

        // Show toast notification for high severity events
        if (event.severity === 'high') {
          this.showToast(event);
        }
      }

      showToast(event) {
        const toast = document.createElement('div');
        toast.style.cssText = `
          position: fixed;
          top: 100px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(255, 0, 0, 0.9);
          border: 2px solid #ff0000;
          border-radius: 8px;
          padding: 15px 20px;
          color: #fff;
          font-family: 'Courier New', monospace;
          font-size: 12px;
          z-index: 10000;
          box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
          animation: slideIn 0.3s ease;
        `;
        toast.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è ALERT: ${event.type.toUpperCase()}</div>
          <div>${event.message}</div>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(-50%) translateY(-20px)';
          toast.style.transition = 'all 0.3s ease';
          setTimeout(() => document.body.removeChild(toast), 300);
        }, 5000);
      }

      updateStatus(text, color) {
        const statusText = document.getElementById('statusText');
        const statusDot = document.getElementById('statusDot');

        if (statusText) statusText.textContent = text;
        if (statusDot) statusDot.style.background = color;
        if (this.statusIndicator) this.statusIndicator.style.borderColor = color;
      }

      getFactionColor(name) {
        const colors = {
          'Silicate Consortium': '#8a4fff',
          'Lantern Collective': '#00ff9f',
          'Devan Empire': '#ff6600',
          'Human Federation': '#00aaff',
          'Independent Systems': '#ffaa00'
        };
        return colors[name] || '#ffffff';
      }

      lightenColor(color) {
        // Simple color lightening
        const r = parseInt(color.slice(1,3), 16);
        const g = parseInt(color.slice(3,5), 16);
        const b = parseInt(color.slice(5,7), 16);
        return `rgb(${Math.min(255, r + 40)}, ${Math.min(255, g + 40)}, ${Math.min(255, b + 40)})`;
      }

      getEventColor(severity) {
        const colors = {
          'low': '#00ff9f',
          'medium': '#ffaa00',
          'high': '#ff0000'
        };
        return colors[severity] || '#ffffff';
      }

      getEventIcon(type) {
        const icons = {
          'discovery': 'üî≠',
          'conflict': '‚öîÔ∏è',
          'economic': 'üí∞',
          'environmental': 'üå™Ô∏è'
        };
        return icons[type] || 'üì°';
      }

      disconnect() {
        if (this.eventSource) {
          this.eventSource.close();
          this.isConnected = false;
          this.updateStatus('Disconnected', '#ff0000');
        }
      }
    }

    // Initialize Live Universe Manager
    let liveUniverse = null;

    // Wait for map to be ready, then start live universe
    setTimeout(() => {
      console.log('üåå Starting Live Universe Integration...');
      liveUniverse = new LiveUniverseManager();

      // Store globally for debugging
      window.liveUniverse = liveUniverse;
    }, 2000);

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (liveUniverse) {
        liveUniverse.disconnect();
      }
    });

    console.log('‚úÖ Live Universe system loaded');
  </script>
</body>
</html>

<!-- Emergency socket listener - runs independently -->
<script>
(function() {
  console.log('üö® EMERGENCY SOCKET LISTENER INITIALIZING...');

  // Wait for map object and io to be available
  function waitForMap(callback, attempts = 0) {
    if (attempts > 30) {
      console.error('‚ùå Gave up waiting for map after 30 attempts');
      return;
    }

    if (window.galacticMap && typeof io !== 'undefined') {
      console.log('‚úÖ Map and Socket.IO available!');
      console.log('   Map object:', !!window.galacticMap);
      console.log('   Assets Map exists:', !!window.galacticMap.assets);
      console.log('   Assets Map type:', window.galacticMap.assets ? window.galacticMap.assets.constructor.name : 'N/A');
      console.log('   Current assets count:', window.galacticMap.assets ? window.galacticMap.assets.size : 'N/A');
      console.log('   Scene children:', window.galacticMap.assetsGroup ? window.galacticMap.assetsGroup.children.length : 'N/A');
      callback();
    } else {
      console.log('‚è≥ Waiting attempt ' + (attempts + 1) + ': map=' + !!window.galacticMap + ', io=' + (typeof io !== 'undefined'));
      setTimeout(() => waitForMap(callback, attempts + 1), 200);
    }
  }

  waitForMap(() => {
    console.log('üîå Setting up emergency socket connection...');

    const socket = io();

    socket.on('connect', async () => {
      console.log('‚úÖ‚úÖ‚úÖ EMERGENCY SOCKET CONNECTED! ID:', socket.id);
      console.log('   Assets currently in map:', window.galacticMap.assets.size);
      if (window.galacticMap.assets.size > 0) {
        console.log('   First 5 asset IDs:', Array.from(window.galacticMap.assets.keys()).slice(0, 5));
      }

      // Load current character and add to map
      try {
        console.log('üîç Fetching current character from /api/v1/characters/current...');
        const response = await fetch('/api/v1/characters/current');
        console.log('üì• Character API response status:', response.status);
        const data = await response.json();
        console.log('üì¶ Character API data:', data);

        if (data.success && data.character) {
          const character = data.character;
          console.log('üìç Current character loaded:', character.name, 'at', character.location);

          // Store character globally
          window.currentCharacter = character;
          window.currentCharacterId = character._id;

          // Add player character to 3D map
          console.log('üó∫Ô∏è Attempting to add character to galactic map...', {
            hasMap: !!window.galacticMap,
            hasLocation: !!character.location,
            location: character.location
          });
          if (window.galacticMap && character.location) {
            window.galacticMap.addPlayerCharacter(character);
            console.log('‚úÖ Character added to galactic map!');
          } else {
            console.warn('‚ö†Ô∏è Cannot add character to map:', {
              mapExists: !!window.galacticMap,
              locationExists: !!character.location
            });
          }

          // Emit character join event
          if (character.location) {
            socket.emit('characterJoin', {
              characterId: character._id,
              characterName: character.name,
              userId: character.userId,
              location: character.location,
              assetId: character.location.assetId || null
            });
            console.log('üì° Character join event emitted');
          }
        } else {
          console.log('‚ö†Ô∏è No active character found');
        }
      } catch (error) {
        console.error('‚ùå Error loading character:', error);
      }
    });

    // NOTE: galacticPhysicsUpdate handler is registered via GalacticMap3D.initializeSocket()
    // The handler in galactic-map-3d.js (handleServerPhysicsUpdate) processes galaxies, stars, connections, AND characters
    // Do NOT add duplicate handlers here as they will intercept the event

    window.emergencySocket = socket;
    console.log('‚úÖ Emergency socket listener ready!');
  });
})();
</script>

<!-- Daily MOTD Lightbox -->
<% if (user) { %>
  <%- include('../partials/daily-motd-lightbox') %>
<% } %>
