<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planetary Exploration - Zones</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #00ff88;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    /* Main Game Area */
    #game-container {
      width: 100%;
      height: 100%;
      position: relative;
      background: #000;
    }

    #game-canvas {
      width: 100%;
      height: 100%;
      display: block;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    /* Info Panel - Compact Top Right */
    .info-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(2px);
      border: none;
      padding: 3px 6px;
      font-family: 'Courier New', monospace;
      color: #00ff88;
      z-index: 100;
      font-size: 0.55em;
      line-height: 1.2;
      font-weight: 300;
    }

    .info-panel h2 {
      margin: 0 0 2px 0;
      color: #00ff88;
      font-size: 0.9em;
      font-weight: 300;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .info-panel {
        top: 10px;
        right: 10px;
        font-size: 0.5em;
        padding: 2px 4px;
      }

      #hudPanel {
        bottom: 10px !important;
        left: 10px !important;
        right: 10px !important;
        font-size: 0.65em !important;
      }

      #hudPanel > div {
        grid-template-columns: 1fr !important;
        gap: 4px !important;
      }
    }

    @media (max-width: 480px) {
      .info-panel {
        font-size: 0.45em;
      }

      #hudPanel {
        font-size: 0.6em !important;
      }
    }

    /* Loading */
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      text-align: center;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* Tooltips */
    .tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.95);
      border: 1px solid #00ff88;
      padding: 0.5rem;
      font-size: 0.8rem;
      pointer-events: none;
      z-index: 1000;
      display: none;
    }
  </style>
  <link rel="stylesheet" href="/stylesheets/tester-toolbar.css">
</head>
<body>
  <!-- Game Canvas -->
  <div id="game-container">
    <canvas id="game-canvas"></canvas>
    <div id="loading">INITIALIZING PLANETARY SCAN...</div>

    <!-- Info Panel - Top Right -->
    <div class="info-panel">
      <% if (planet) { %>
      <h2 id="planetTitle"><%= planet.title %></h2>
      <div id="planetInfo">
        Type: <%= planet.subType || 'Planet' %><br>
        Climate: <%= typeof planet.climate === 'string' ? planet.climate : (planet.climate && planet.climate.type ? planet.climate.type : 'Unknown') %><br>
        Atmosphere: <%= planet.atmosphere || 'Unknown' %><br>
        Position: <span id="coords">0, 0</span>
      </div>
      <% } else { %>
      <h2 id="planetTitle">PLANETARY EXPLORATION</h2>
      <div id="planetInfo">
        Biome: <span id="biome">Rocky Plains</span><br>
        Temp: <span id="temperature">-20¬∞C</span><br>
        Radiation: <span id="radiation">Low</span><br>
        Position: <span id="coords">0, 0</span>
      </div>
      <% } %>
    </div>

    <!-- Minimap - Top Left -->
    <div id="minimap" style="position: absolute; top: 20px; left: 20px; z-index: 100;">
      <div style="background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(3px); border: 1px solid #00ff88; border-radius: 3px; padding: 4px;">
        <canvas id="minimapCanvas" width="150" height="150" style="display: block; image-rendering: pixelated;"></canvas>
        <div style="text-align: center; color: #00ff88; font-size: 0.5em; font-family: 'Courier New', monospace; margin-top: 2px;">
          MINIMAP
        </div>
      </div>
    </div>

    <!-- Action Buttons - Top Center -->
    <div id="actionButtons" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; gap: 8px;">
      <!-- Map Toggle -->
      <button id="mapToggle" style="background: rgba(5, 10, 20, 0.8); border: 1px solid #4a9eff; color: #4a9eff; padding: 6px 12px; border-radius: 3px; font-family: 'Orbitron', monospace; font-size: 0.7em; cursor: pointer; transition: all 0.2s;">
        üó∫Ô∏è MAP
      </button>

      <!-- Inventory -->
      <button id="inventoryToggle" style="background: rgba(5, 10, 20, 0.8); border: 1px solid #ffa500; color: #ffa500; padding: 6px 12px; border-radius: 3px; font-family: 'Orbitron', monospace; font-size: 0.7em; cursor: pointer; transition: all 0.2s;">
        üéí INVENTORY
      </button>

      <!-- Return to Orbit -->
      <button id="returnToOrbit" style="background: rgba(5, 10, 20, 0.8); border: 1px solid #ff4444; color: #ff4444; padding: 6px 12px; border-radius: 3px; font-family: 'Orbitron', monospace; font-size: 0.7em; cursor: pointer; transition: all 0.2s;">
        üöÄ RETURN TO ORBIT
      </button>
    </div>

    <!-- Full Map Overlay (Hidden by default) -->
    <div id="fullMapOverlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 200;">
      <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div style="position: absolute; top: 20px; right: 20px;">
          <button id="closeMapBtn" style="background: rgba(255, 68, 68, 0.8); border: 1px solid #ff4444; color: #fff; padding: 10px 20px; border-radius: 3px; font-family: 'Orbitron', monospace; font-size: 0.8em; cursor: pointer;">
            ‚úï CLOSE MAP
          </button>
        </div>
        <canvas id="fullMapCanvas" width="800" height="800" style="border: 2px solid #00ff88; image-rendering: pixelated;"></canvas>
        <div style="color: #00ff88; font-family: 'Courier New', monospace; font-size: 0.9em; margin-top: 15px;">
          PLANETARY MAP - <span id="mapCoords">0, 0</span>
        </div>
      </div>
    </div>

    <!-- Inventory Overlay (Hidden by default) -->
    <div id="inventoryOverlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 200;">
      <div style="position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
        <div style="position: absolute; top: 20px; right: 20px;">
          <button id="closeInventoryBtn" style="background: rgba(255, 68, 68, 0.8); border: 1px solid #ff4444; color: #fff; padding: 10px 20px; border-radius: 3px; font-family: 'Orbitron', monospace; font-size: 0.8em; cursor: pointer;">
            ‚úï CLOSE
          </button>
        </div>
        <div style="background: rgba(5, 10, 20, 0.9); border: 2px solid #ffa500; border-radius: 5px; padding: 20px; max-width: 800px; width: 90%;">
          <h2 style="color: #ffa500; font-family: 'Orbitron', monospace; text-align: center; margin-bottom: 20px;">INVENTORY</h2>

          <!-- Inventory Grid -->
          <div id="inventoryGrid" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-bottom: 20px;">
            <!-- Inventory slots will be populated here -->
          </div>

          <!-- Inventory Stats -->
          <div style="border-top: 1px solid #ffa500; padding-top: 15px; color: #aaa; font-family: 'Courier New', monospace; font-size: 0.8em;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>Weight:</span>
              <span><span id="inventoryWeight">0</span> / <span id="inventoryMaxWeight">100</span> kg</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Slots Used:</span>
              <span><span id="inventorySlotsUsed">0</span> / <span id="inventoryMaxSlots">32</span></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Compact HUD Panel - Bottom Left -->
    <div id="hudPanel" style="position: absolute; bottom: 20px; left: 20px; font-family: 'Orbitron', monospace; z-index: 100; font-size: 0.75em;">
      <div style="display: grid; grid-template-columns: auto auto; gap: 6px;">

        <!-- LIFE SUPPORT MODULE -->
        <div style="background: rgba(5, 10, 20, 0.7); backdrop-filter: blur(3px); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 3px; padding: 4px 6px;">
          <div style="color: #00d4ff; font-size: 0.6em; font-weight: bold; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(0, 212, 255, 0.2); padding-bottom: 2px;">
            ‚ñ∏ LIFE
          </div>

          <!-- Oxygen -->
          <div style="margin-bottom: 3px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1px;">
              <span style="color: #00d4ff; font-size: 0.55em;">O2</span>
              <span id="oxygen" style="color: #00d4ff; font-size: 0.55em; font-weight: bold;">100%</span>
            </div>
            <div style="width: 100%; height: 3px; background: rgba(0, 0, 0, 0.5); border-radius: 2px; overflow: hidden;">
              <div id="oxygenBar" style="width: 100%; height: 100%; background: #00d4ff; transition: width 0.3s;"></div>
            </div>
          </div>

          <!-- Energy -->
          <div style="margin-bottom: 0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1px;">
              <span style="color: #ffa500; font-size: 0.55em;">PWR</span>
              <span id="energy" style="color: #ffa500; font-size: 0.55em; font-weight: bold;">100%</span>
            </div>
            <div style="width: 100%; height: 3px; background: rgba(0, 0, 0, 0.5); border-radius: 2px; overflow: hidden;">
              <div id="energyBar" style="width: 100%; height: 100%; background: #ffa500; transition: width 0.3s;"></div>
            </div>
          </div>
        </div>

        <!-- EXPLORATION MODULE -->
        <div style="background: rgba(5, 10, 20, 0.7); backdrop-filter: blur(3px); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 3px; padding: 4px 6px;">
          <div style="color: #00ff88; font-size: 0.6em; font-weight: bold; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(0, 255, 136, 0.2); padding-bottom: 2px;">
            ‚ñ∏ EXPL
          </div>

          <div style="font-size: 0.5em; line-height: 1.4; color: #00ff88;">
            <div>Resources: <span id="resources" style="font-weight: bold;">0</span></div>
            <div>Discoveries: <span id="discoveries" style="font-weight: bold;">0</span></div>
            <div>Scans: <span id="scans" style="font-weight: bold;">0</span></div>
          </div>
        </div>

        <!-- MOVEMENT MODULE -->
        <div style="background: rgba(5, 10, 20, 0.7); backdrop-filter: blur(3px); border: 1px solid rgba(138, 79, 255, 0.3); border-radius: 3px; padding: 4px 6px;">
          <div style="color: #8a4fff; font-size: 0.6em; font-weight: bold; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(138, 79, 255, 0.2); padding-bottom: 2px;">
            ‚ñ∏ MOV
          </div>

          <div style="font-size: 0.5em; line-height: 1.4; color: #8a4fff;">
            <div>Speed: <span id="moveSpeed" style="font-weight: bold;">1.0x</span></div>
            <div>Status: <span id="moveStatus" style="font-weight: bold;">IDLE</span></div>
          </div>
        </div>

        <!-- CONTROLS MODULE -->
        <div style="background: rgba(5, 10, 20, 0.7); backdrop-filter: blur(3px); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 3px; padding: 4px 6px;">
          <div style="color: #00ff88; font-size: 0.6em; font-weight: bold; margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid rgba(0, 255, 136, 0.2); padding-bottom: 2px;">
            ‚ñ∏ CTL
          </div>

          <div style="font-size: 0.5em; line-height: 1.4; color: #aaa;">
            <div><span style="color: #00ffff;">WASD</span> MOV <span style="color: #00ffff;">E</span> SCN</div>
            <div><span style="color: #00ffff;">SPC</span> INT <span style="color: #00ffff;">1-9</span> ACT</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Bar (Hidden by default, can be shown via game logic) -->
  <div id="action-bar" style="display: none;">
    <div class="action-slot active" data-slot="1">
      <span class="number">1</span>
      <span class="item-icon">=</span>
    </div>
    <div class="action-slot" data-slot="2">
      <span class="number">2</span>
      <span class="item-icon">ÔøΩ</span>
    </div>
    <div class="action-slot" data-slot="3">
      <span class="number">3</span>
      <span class="item-icon">=+</span>
    </div>
    <div class="action-slot" data-slot="4">
      <span class="number">4</span>
      <span class="item-icon">=ÔøΩ</span>
    </div>
    <div class="action-slot" data-slot="5">
      <span class="number">5</span>
      <span class="item-icon">=ÔøΩ</span>
    </div>
    <div class="action-slot" data-slot="6">
      <span class="number">6</span>
      <span class="item-icon">>ÔøΩ</span>
    </div>
    <div class="action-slot" data-slot="7">
      <span class="number">7</span>
      <span class="item-icon">=ÔøΩ</span>
    </div>
    <div class="action-slot" data-slot="8">
      <span class="number">8</span>
      <span class="item-icon">=ÔøΩ</span>
    </div>
    <div class="action-slot" data-slot="9">
      <span class="number">9</span>
      <span class="item-icon">=ÔøΩ</span>
    </div>
  </div>

  <script>
    // Game State
    const game = {
      canvas: null,
      ctx: null,
      minimapCanvas: null,
      minimapCtx: null,
      width: 0,
      height: 0,
      player: {
        x: 0,
        y: 0,
        size: 16,
        speed: 3,
        color: '#00ff88',
        facing: 0 // 0: up, 1: right, 2: down, 3: left
      },
      camera: {
        x: 0,
        y: 0
      },
      world: {
        width: 2000,
        height: 2000,
        tileSize: 32
      },
      keys: {},
      activeSlot: 1,
      resources: 0,
      oxygen: 100,
      energy: 100,
      discoveries: 0,
      terrain: [],
      objects: [],
      lastTime: 0,
      deltaTime: 0
    };

    // Terrain Types
    const TERRAIN = {
      ROCK: { color: '#333', name: 'Rock' },
      SAND: { color: '#d4a574', name: 'Sand' },
      ICE: { color: '#a8d8ff', name: 'Ice' },
      CRYSTAL: { color: '#ff00ff', name: 'Crystal' },
      METAL: { color: '#888', name: 'Metal' },
      ALIEN: { color: '#00ff00', name: 'Alien Flora' }
    };

    // Initialize
    function init() {
      game.canvas = document.getElementById('game-canvas');
      game.ctx = game.canvas.getContext('2d');
      game.minimapCanvas = document.getElementById('minimap-canvas');
      game.minimapCtx = game.minimapCanvas.getContext('2d');

      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);

      // Initialize player at center
      game.player.x = game.world.width / 2;
      game.player.y = game.world.height / 2;

      // Generate terrain
      generateTerrain();

      // Setup controls
      setupControls();

      // Hide loading
      document.getElementById('loading').style.display = 'none';

      // Start game loop
      requestAnimationFrame(gameLoop);
    }

    function resizeCanvas() {
      const container = document.getElementById('game-container');
      game.canvas.width = container.clientWidth;
      game.canvas.height = container.clientHeight;
      game.width = game.canvas.width;
      game.height = game.canvas.height;
    }

    function generateTerrain() {
      const tiles = (game.world.width / game.world.tileSize) * (game.world.height / game.world.tileSize);

      for (let i = 0; i < tiles; i++) {
        const x = (i % (game.world.width / game.world.tileSize)) * game.world.tileSize;
        const y = Math.floor(i / (game.world.width / game.world.tileSize)) * game.world.tileSize;

        // Noise-based terrain generation
        const noise = Math.sin(x * 0.01) * Math.cos(y * 0.01);
        let type = TERRAIN.ROCK;

        if (noise > 0.5) type = TERRAIN.CRYSTAL;
        else if (noise > 0.3) type = TERRAIN.METAL;
        else if (noise > 0) type = TERRAIN.SAND;
        else if (noise > -0.3) type = TERRAIN.ICE;
        else if (noise > -0.6) type = TERRAIN.ROCK;
        else type = TERRAIN.ALIEN;

        game.terrain.push({ x, y, type });
      }

      // Generate resource nodes
      for (let i = 0; i < 50; i++) {
        game.objects.push({
          x: Math.random() * game.world.width,
          y: Math.random() * game.world.height,
          type: 'resource',
          icon: '=ÔøΩ',
          collected: false
        });
      }

      // Generate alien structures
      for (let i = 0; i < 10; i++) {
        game.objects.push({
          x: Math.random() * game.world.width,
          y: Math.random() * game.world.height,
          type: 'structure',
          icon: '<ÔøΩ',
          discovered: false
        });
      }
    }

    function setupControls() {
      // Keyboard controls
      window.addEventListener('keydown', (e) => {
        game.keys[e.key.toLowerCase()] = true;

        // Number keys for action bar
        if (e.key >= '1' && e.key <= '9') {
          selectSlot(parseInt(e.key));
        }

        // Action keys
        if (e.key === ' ') {
          e.preventDefault();
          interact();
        }
        if (e.key.toLowerCase() === 'e') {
          scan();
        }
      });

      window.addEventListener('keyup', (e) => {
        game.keys[e.key.toLowerCase()] = false;
      });

      // Action bar clicks
      document.querySelectorAll('.action-slot').forEach(slot => {
        slot.addEventListener('click', () => {
          selectSlot(parseInt(slot.dataset.slot));
        });
      });
    }

    function selectSlot(num) {
      game.activeSlot = num;
      document.querySelectorAll('.action-slot').forEach(slot => {
        slot.classList.remove('active');
      });
      document.querySelector(`[data-slot="${num}"]`).classList.add('active');
    }

    function interact() {
      // Check for nearby objects
      game.objects.forEach(obj => {
        const dist = Math.hypot(obj.x - game.player.x, obj.y - game.player.y);
        if (dist < 50) {
          if (obj.type === 'resource' && !obj.collected) {
            obj.collected = true;
            game.resources += 10;
            updateStats();
            showMessage('Collected resource! +10');
          } else if (obj.type === 'structure' && !obj.discovered) {
            obj.discovered = true;
            game.discoveries++;
            updateStats();
            showMessage('Discovered alien structure!');
          }
        }
      });
    }

    function scan() {
      showMessage('Scanning area...');
      // Highlight nearby resources
      setTimeout(() => {
        showMessage('Scan complete!');
      }, 1000);
    }

    function showMessage(text) {
      const msg = document.createElement('div');
      msg.textContent = text;
      msg.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 255, 136, 0.9);
        color: #000;
        padding: 1rem 2rem;
        border-radius: 5px;
        font-weight: bold;
        z-index: 10000;
      `;
      document.body.appendChild(msg);
      setTimeout(() => msg.remove(), 2000);
    }

    function updateStats() {
      document.getElementById('oxygen').textContent = Math.floor(game.oxygen) + '%';
      document.getElementById('energy').textContent = Math.floor(game.energy) + '%';
      document.getElementById('resources').textContent = game.resources;
      document.getElementById('discoveries').textContent = game.discoveries;
      document.getElementById('coords').textContent =
        `${Math.floor(game.player.x)}, ${Math.floor(game.player.y)}`;
    }

    function updatePlayer(dt) {
      let moved = false;

      // WASD movement
      if (game.keys['w']) {
        game.player.y -= game.player.speed;
        game.player.facing = 0;
        moved = true;
      }
      if (game.keys['s']) {
        game.player.y += game.player.speed;
        game.player.facing = 2;
        moved = true;
      }
      if (game.keys['a']) {
        game.player.x -= game.player.speed;
        game.player.facing = 3;
        moved = true;
      }
      if (game.keys['d']) {
        game.player.x += game.player.speed;
        game.player.facing = 1;
        moved = true;
      }

      // Boundary check
      game.player.x = Math.max(0, Math.min(game.world.width, game.player.x));
      game.player.y = Math.max(0, Math.min(game.world.height, game.player.y));

      // Deplete oxygen/energy slowly when moving
      if (moved) {
        game.oxygen = Math.max(0, game.oxygen - 0.01);
        game.energy = Math.max(0, game.energy - 0.02);
      } else {
        // Regenerate when idle
        game.energy = Math.min(100, game.energy + 0.05);
      }

      // Camera follows player
      game.camera.x = game.player.x - game.width / 2;
      game.camera.y = game.player.y - game.height / 2;

      updateStats();
    }

    function render() {
      const ctx = game.ctx;

      // Clear
      ctx.fillStyle = '#0a0a0a';
      ctx.fillRect(0, 0, game.width, game.height);

      // Draw terrain
      game.terrain.forEach(tile => {
        const screenX = tile.x - game.camera.x;
        const screenY = tile.y - game.camera.y;

        if (screenX > -game.world.tileSize && screenX < game.width &&
            screenY > -game.world.tileSize && screenY < game.height) {
          ctx.fillStyle = tile.type.color;
          ctx.fillRect(screenX, screenY, game.world.tileSize, game.world.tileSize);

          // Grid
          ctx.strokeStyle = 'rgba(0, 255, 136, 0.1)';
          ctx.strokeRect(screenX, screenY, game.world.tileSize, game.world.tileSize);
        }
      });

      // Draw objects
      ctx.font = '20px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      game.objects.forEach(obj => {
        if (obj.type === 'resource' && obj.collected) return;
        if (obj.type === 'structure' && obj.discovered) {
          ctx.globalAlpha = 0.5;
        }

        const screenX = obj.x - game.camera.x;
        const screenY = obj.y - game.camera.y;

        if (screenX > -50 && screenX < game.width + 50 &&
            screenY > -50 && screenY < game.height + 50) {
          ctx.fillText(obj.icon, screenX, screenY);
        }

        ctx.globalAlpha = 1;
      });

      // Draw player
      const playerScreenX = game.player.x - game.camera.x;
      const playerScreenY = game.player.y - game.camera.y;

      // Player body
      ctx.fillStyle = game.player.color;
      ctx.beginPath();
      ctx.arc(playerScreenX, playerScreenY, game.player.size, 0, Math.PI * 2);
      ctx.fill();

      // Direction indicator
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      const dirX = playerScreenX + Math.cos((game.player.facing * 90 - 90) * Math.PI / 180) * game.player.size;
      const dirY = playerScreenY + Math.sin((game.player.facing * 90 - 90) * Math.PI / 180) * game.player.size;
      ctx.moveTo(playerScreenX, playerScreenY);
      ctx.lineTo(dirX, dirY);
      ctx.stroke();

      // Render minimap
      renderMinimap();
    }

    function renderMinimap() {
      const ctx = game.minimapCtx;
      const scale = 150 / game.world.width;

      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, 150, 150);

      // Draw world bounds
      ctx.strokeStyle = '#00ff88';
      ctx.strokeRect(0, 0, 150, 150);

      // Draw player
      ctx.fillStyle = '#00ff88';
      ctx.fillRect(
        game.player.x * scale - 2,
        game.player.y * scale - 2,
        4, 4
      );

      // Draw discovered objects
      ctx.fillStyle = '#ff00ff';
      game.objects.forEach(obj => {
        if (obj.discovered || obj.collected) {
          ctx.fillRect(obj.x * scale - 1, obj.y * scale - 1, 2, 2);
        }
      });
    }

    function gameLoop(timestamp) {
      game.deltaTime = timestamp - game.lastTime;
      game.lastTime = timestamp;

      updatePlayer(game.deltaTime);
      render();

      requestAnimationFrame(gameLoop);
    }

    // Legacy support - keep old game init for zones without planetId
    <% if (!planetId) { %>
    window.addEventListener('load', init);
    <% } %>
  </script>

  <!-- Planetary Chunk Manager -->
  <% if (planetId) { %>
  <script src="/javascripts/planetary-chunk-manager.js"></script>
  <script>
    // Initialize planetary chunk manager
    const planetId = '<%= planetId %>';
    let chunkManager = null;

    window.addEventListener('load', async () => {
      chunkManager = new PlanetaryChunkManager(planetId, 'game-canvas');
      await chunkManager.initialize();

      // Make globally accessible for debugging
      window.chunkManager = chunkManager;
    });
  </script>
  <% } %>

  <!-- Tester Toolbar for Admin/Tester Debugging -->
  <% if (user && (user.userRole === 'tester' || user.userRole === 'admin')) { %>
  <script src="/javascripts/tester-toolbar.js"></script>
  <script>
    // Initialize tester toolbar
    if (typeof TesterToolbar !== 'undefined') {
      const testerToolbar = new TesterToolbar(
        <%- JSON.stringify(user) %>,
        typeof character !== 'undefined' ? <%- JSON.stringify(character) %> : null
      );

      // Update debug info for planetary exploration
      const updateDebugInfo = () => {
        const locationEl = document.getElementById('quick-location');

        // Check for chunk manager first (new system)
        if (locationEl && window.chunkManager && window.chunkManager.player) {
          const player = window.chunkManager.player;
          locationEl.textContent = `${Math.round(player.x)}, ${Math.round(player.y)} (Chunk ${player.chunkX}, ${player.chunkY})`;
        }
        // Fall back to old game system
        else if (locationEl && game && game.player) {
          locationEl.textContent = `${Math.round(game.player.x)}, ${Math.round(game.player.y)}`;
        }

        // Update FPS
        const fpsEl = document.getElementById('quick-fps');
        if (fpsEl && game) {
          const fps = Math.round(1000 / (game.deltaTime || 16));
          fpsEl.textContent = fps;
        }
      };

      // Update debug info periodically
      setInterval(updateDebugInfo, 100);
    }
  </script>
  <% } %>
</body>
</html>
