<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - bih</title>
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/chat.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/call.css">
  <link rel="stylesheet" href="/css/channels.css">
</head>
<body>
  <h1>Dashboard</h1>
  <p>Welcome, <%= user.displayName || user.email %></p>
  <% if (user.avatar) { %>
    <img src="<%= user.avatar %>" alt="avatar" width="80" style="border-radius:50%;" />
  <% } %>
  <br><br>
  <a href="/profile">Profile</a>
  <a href="/tickets">Tickets</a>
  <a href="/auth/logout">Logout</a>
  <a href="/">Home</a>

  <hr>
  <h2 style="margin:16px 0 8px;">Live Now</h2>
  <div id="live-streams" style="display:flex; flex-wrap:wrap; gap:16px;">
    <p id="live-loading" style="color:var(--text-dim);">> checking streams...</p>
  </div>

  <script>
    (function() {
      const container = document.getElementById('live-streams');
      const loading = document.getElementById('live-loading');

      async function fetchLive() {
        try {
          const res = await fetch('/api/twitch/live');
          if (!res.ok) throw new Error(res.status);
          const { streams } = await res.json();
          loading.remove();

          if (!streams.length) {
            container.innerHTML = '<p style="color:var(--text-dim);">> no one is live</p>';
            return;
          }

          container.innerHTML = streams.map(s => `
            <a href="${s.url}" target="_blank" rel="noopener" style="
              display:block; width:220px; border:1px solid var(--border);
              background:var(--bg-surface); text-decoration:none;
              border-bottom:none; transition:box-shadow 0.2s;
            " onmouseover="this.style.boxShadow='0 0 12px rgba(0,255,65,0.15)'"
               onmouseout="this.style.boxShadow='none'">
              <div style="position:relative;">
                <img src="${s.thumbnail}" alt="${s.displayName}" style="width:100%;display:block;border:none;" />
                <span style="
                  position:absolute; bottom:6px; left:6px;
                  background:rgba(255,0,0,0.85); color:#fff;
                  font-size:10px; padding:2px 6px; border-radius:2px;
                  font-family:var(--mono);
                ">LIVE</span>
                <span style="
                  position:absolute; bottom:6px; right:6px;
                  background:rgba(0,0,0,0.7); color:#fff;
                  font-size:10px; padding:2px 6px; border-radius:2px;
                  font-family:var(--mono);
                ">${s.viewerCount} viewers</span>
              </div>
              <div style="padding:8px;">
                <div style="color:var(--green); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  ${s.bihDisplayName || s.displayName}
                </div>
                <div style="color:var(--text-dim); font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                  ${s.title}
                </div>
                <div style="color:var(--green-muted); font-size:10px; margin-top:4px;">
                  ${s.gameName}
                </div>
              </div>
            </a>
          `).join('');
        } catch (err) {
          loading.textContent = '> failed to load streams';
        }
      }

      fetchLive();
      // Refresh every 60 seconds
      setInterval(fetchLive, 60000);
    })();
  </script>

  <%- include('partials/sidebar') %>
  <%- include('partials/chat') %>
  <%- include('partials/call') %>
</body>
</html>
