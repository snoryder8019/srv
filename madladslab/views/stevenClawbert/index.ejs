<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a0505">
  <title><%= title %></title>
  <link rel="icon" type="image/png" href="/images/beaker_logo_no_stash.png">
  <style>
    :root {
      --red: #e74c3c;
      --red-dark: #c0392b;
      --red-deep: #96281b;
      --bg: #0a0a0a;
      --bg-raised: #111;
      --bg-card: #1a1a1a;
      --border: #222;
      --text: #e0e0e0;
      --text-dim: #888;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      height: 100%;
      height: -webkit-fill-available;
      overflow: hidden;
      overscroll-behavior: none;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Courier New', monospace;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100dvh;
    }

    /* ===== HEADER ===== */
    .header {
      background: linear-gradient(135deg, #1a0505 0%, #2d0a0a 50%, #1a0a00 100%);
      border-bottom: 2px solid var(--red-dark);
      padding: 0.5rem 0.75rem;
      padding-top: calc(0.5rem + var(--safe-top));
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      min-height: 48px;
      z-index: 10;
    }
    .header h1 {
      font-size: 1.1rem;
      color: var(--red);
      display: flex;
      align-items: center;
      gap: 0.4rem;
      white-space: nowrap;
    }
    .header h1 .claw { font-size: 1.3rem; }

    .header-right {
      display: flex;
      gap: 0.4rem;
      align-items: center;
    }
    .icon-btn {
      background: rgba(231, 76, 60, 0.12);
      color: var(--red);
      border: 1px solid rgba(231, 76, 60, 0.25);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      text-decoration: none;
      flex-shrink: 0;
    }
    .icon-btn:active { background: rgba(231, 76, 60, 0.35); transform: scale(0.93); }
    .icon-btn.active { background: rgba(231, 76, 60, 0.4); border-color: var(--red); }

    /* ===== OPTIONS TRAY (toggled) ===== */
    .options-tray {
      background: #0f0f0f;
      border-bottom: 1px solid var(--border);
      padding: 0.5rem 0.75rem;
      display: none;
      flex-wrap: wrap;
      gap: 0.75rem 1.25rem;
      align-items: center;
      flex-shrink: 0;
    }
    .options-tray.open { display: flex; }
    .opt-group {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .opt-group label {
      font-size: 0.78rem;
      color: var(--text-dim);
      cursor: pointer;
      user-select: none;
    }
    .opt-group input[type="checkbox"] {
      accent-color: var(--red-dark);
      width: 18px;
      height: 18px;
    }
    .opt-link {
      font-size: 0.78rem;
      color: var(--red);
      text-decoration: none;
      padding: 0.3rem 0.6rem;
      border: 1px solid rgba(231, 76, 60, 0.25);
      border-radius: 6px;
      background: rgba(231, 76, 60, 0.08);
    }
    .opt-link:active { background: rgba(231, 76, 60, 0.25); }

    /* ===== MAIN LAYOUT ===== */
    .main-layout {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }
    .chat-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    /* ===== MESSAGES ===== */
    .messages {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      scroll-behavior: smooth;
    }
    .messages::-webkit-scrollbar { width: 3px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: var(--red-dark); border-radius: 3px; }

    .message {
      max-width: 88%;
      padding: 0.65rem 0.85rem;
      border-radius: 16px;
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-wrap;
      font-size: 0.9rem;
    }
    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, var(--red-dark), var(--red-deep));
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.assistant {
      align-self: flex-start;
      background: var(--bg-card);
      border: 1px solid #2a2a2a;
      border-bottom-left-radius: 4px;
      color: #d0d0d0;
    }
    .message.system {
      align-self: center;
      background: rgba(231, 76, 60, 0.08);
      border: 1px solid rgba(231, 76, 60, 0.15);
      color: var(--red);
      font-size: 0.78rem;
      max-width: 95%;
      text-align: center;
      border-radius: 10px;
    }
    .message .timestamp {
      font-size: 0.65rem;
      opacity: 0.45;
      margin-top: 0.25rem;
    }
    .msg-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 0.25rem;
    }
    .speak-btn {
      background: none;
      border: none;
      color: var(--red);
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0.25rem;
      opacity: 0.5;
      min-width: 32px;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .speak-btn:active { opacity: 1; transform: scale(1.15); }

    /* ===== TYPING INDICATOR ===== */
    .typing-indicator {
      display: none;
      align-self: flex-start;
      padding: 0.65rem 0.85rem;
      background: var(--bg-card);
      border: 1px solid #2a2a2a;
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      margin: 0 0.75rem;
    }
    .typing-indicator.visible { display: flex; gap: 0.3rem; }
    .typing-dot {
      width: 7px; height: 7px;
      background: var(--red-dark);
      border-radius: 50%;
      animation: typing-bounce 1.4s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing-bounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-5px); opacity: 1; }
    }

    /* ===== INPUT AREA ===== */
    .input-area {
      border-top: 1px solid var(--border);
      padding: 0.5rem 0.5rem;
      padding-bottom: calc(0.5rem + var(--safe-bottom));
      display: flex;
      gap: 0.4rem;
      background: #0d0d0d;
      flex-shrink: 0;
      align-items: flex-end;
    }
    .mic-btn {
      background: var(--bg-card);
      border: 1px solid #333;
      color: var(--red);
      width: 46px;
      height: 46px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .mic-btn:active { transform: scale(0.9); }
    .mic-btn.recording {
      background: var(--red-dark);
      color: white;
      border-color: var(--red);
      animation: pulse-mic 1.5s infinite;
    }
    @keyframes pulse-mic {
      0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.5); }
      50% { box-shadow: 0 0 0 12px rgba(231, 76, 60, 0); }
    }

    .input-area input {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid #333;
      color: var(--text);
      padding: 0.7rem 0.85rem;
      border-radius: 22px;
      font-family: inherit;
      font-size: 16px; /* prevents iOS zoom */
      outline: none;
      min-width: 0;
    }
    .input-area input:focus { border-color: var(--red-dark); }
    .input-area input::placeholder { color: #555; }

    .send-btn {
      background: var(--red-dark);
      color: white;
      border: none;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.15s;
    }
    .send-btn:active { transform: scale(0.9); background: var(--red); }
    .send-btn:disabled { background: #333; }

    /* ===== BOTTOM SHEET (Controls Panel) ===== */
    .sheet-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s;
    }
    .sheet-overlay.open { opacity: 1; pointer-events: auto; }

    .bottom-sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0f0f0f;
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      z-index: 60;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      padding-bottom: var(--safe-bottom);
    }
    .bottom-sheet.open { transform: translateY(0); }

    .sheet-handle {
      width: 36px;
      height: 4px;
      background: #444;
      border-radius: 2px;
      margin: 0.6rem auto 0.3rem;
      flex-shrink: 0;
    }
    .sheet-header {
      padding: 0.4rem 1rem 0.6rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .sheet-header span {
      font-weight: bold;
      color: var(--red);
      font-size: 1rem;
    }
    .sheet-close {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }
    .sheet-body {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0.75rem 1rem;
    }

    /* ===== PANEL SECTIONS ===== */
    .panel-section { margin-bottom: 1rem; }
    .panel-section h3 {
      color: var(--red);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.4rem;
      padding-bottom: 0.2rem;
      border-bottom: 1px solid var(--border);
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      padding: 0.35rem 0;
      font-size: 0.82rem;
    }
    .status-row .label { color: var(--text-dim); }
    .status-row .value { color: #ccc; text-align: right; max-width: 55%; word-break: break-all; }

    .status-dot {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      margin-right: 0.25rem;
      vertical-align: middle;
    }
    .status-dot.green { background: #2ecc71; }
    .status-dot.red { background: #e74c3c; }

    .quick-actions-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.4rem;
    }
    .quick-btn {
      background: var(--bg-card);
      border: 1px solid #333;
      color: #ccc;
      padding: 0.65rem 0.6rem;
      border-radius: 10px;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.8rem;
      text-align: center;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
    }
    .quick-btn:active { border-color: var(--red); color: var(--red); background: rgba(231,76,60,0.1); transform: scale(0.96); }

    .panel-output {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.6rem;
      font-size: 0.72rem;
      font-family: 'Courier New', monospace;
      color: #aaa;
      max-height: 180px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      margin-top: 0.4rem;
    }

    /* ===== TASK LIST ===== */
    .task-list { display: flex; flex-direction: column; gap: 0.3rem; }
    .task-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.6rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.8rem;
    }
    .task-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .task-text { flex: 1; color: #ccc; }
    .task-tag {
      font-size: 0.65rem;
      padding: 1px 6px;
      border-radius: 3px;
      flex-shrink: 0;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .task-agent {
      font-size: 0.6rem;
      padding: 1px 5px;
      border-radius: 3px;
      flex-shrink: 0;
      background: rgba(231, 76, 60, 0.12);
      color: var(--red);
      border: 1px solid rgba(231, 76, 60, 0.2);
    }
    .task-item.blocked .task-dot { background: #ff4444; }
    .task-item.blocked .task-tag { background: #442222; color: #ff6666; }
    .task-item.todo .task-dot { background: #ffaa00; }
    .task-item.todo .task-tag { background: #333; color: #aaa; }
    .task-item.active .task-dot { background: #4488ff; }
    .task-item.active .task-tag { background: #223344; color: #66aaff; }
    .task-item.done .task-dot { background: #44cc44; }
    .task-item.done .task-tag { background: #224422; color: #66cc66; }
    .task-item.done .task-text { opacity: 0.5; text-decoration: line-through; }

    /* ===== DESKTOP (768px+) ===== */
    @media (min-width: 769px) {
      .header { padding: 0.6rem 1.5rem; }
      .header h1 { font-size: 1.4rem; }
      .header h1 .claw { font-size: 1.6rem; }
      .messages { padding: 1rem; gap: 0.75rem; }
      .message { max-width: 70%; font-size: 0.9rem; }
      .input-area { padding: 0.75rem 1rem; gap: 0.5rem; }

      /* On desktop, show panel as sidebar instead of bottom sheet */
      .sheet-overlay { display: none !important; }
      .bottom-sheet {
        position: static;
        transform: none;
        border-radius: 0;
        max-height: none;
        width: 320px;
        border-left: 1px solid var(--border);
        flex-shrink: 0;
        transition: width 0.25s;
      }
      .bottom-sheet.collapsed-desktop { width: 0; overflow: hidden; border: none; }
      .sheet-handle { display: none; }
      .main-layout { flex-direction: row; }
      .chat-wrapper { flex: 1; display: flex; flex-direction: column; min-width: 0; }
      .quick-actions-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <h1><span class="claw">&#x1F99E;</span> Steven Clawbert</h1>
  <div class="header-right">
    <button class="icon-btn" id="optionsBtn" onclick="toggleOptions()" title="Options">&#x2699;</button>
    <button class="icon-btn" id="panelBtn" onclick="togglePanel()" title="Controls">&#x1F4CA;</button>
  </div>
</div>

<!-- OPTIONS TRAY -->
<div class="options-tray" id="optionsTray">
  <div class="opt-group">
    <input type="checkbox" id="autoSpeak" checked>
    <label for="autoSpeak">Auto-speak</label>
  </div>
  <div class="opt-group">
    <input type="checkbox" id="notifyToggle" onchange="toggleNotifications(this.checked)">
    <label for="notifyToggle">ðŸ”” Notifications</label>
  </div>
  <div class="opt-group">
    <input type="checkbox" id="deliverToggle">
    <label for="deliverToggle">WhatsApp delivery</label>
  </div>
  <a href="/stevenClawbert/browser" class="opt-link">&#x2B21; SRV Browser</a>
  <a href="/claudeTalk" class="opt-link">Claude Talk</a>
  <a href="/" class="opt-link">Home</a>
</div>

<!-- MAIN LAYOUT -->
<div class="main-layout">
  <div class="chat-wrapper">
    <!-- MESSAGES -->
    <div class="messages" id="messages">
      <div class="message system">
        Steven Clawbert is ready. Type or tap the mic to talk to the OpenClaw agent.
      </div>
    </div>

    <!-- TYPING -->
    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>

    <!-- INPUT -->
    <div class="input-area">
      <button class="mic-btn" id="micBtn" onclick="toggleMic()" title="Voice input">&#x1F3A4;</button>
      <input type="text" id="msgInput" placeholder="Message..." autocomplete="off" enterkeyhint="send">
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send">&#x27A4;</button>
    </div>
  </div>

  <!-- BOTTOM SHEET / SIDE PANEL -->
  <div class="sheet-overlay" id="sheetOverlay" onclick="togglePanel()"></div>
  <div class="bottom-sheet" id="bottomSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span>&#x1F99E; OpenClaw Controls</span>
      <button class="sheet-close" onclick="togglePanel()">&times;</button>
    </div>
    <div class="sheet-body">
      <!-- Status -->
      <div class="panel-section">
        <h3>Gateway</h3>
        <div class="status-row">
          <span class="label">Status</span>
          <span class="value" id="gwStatus">Loading...</span>
        </div>
        <div class="status-row">
          <span class="label">Agent</span>
          <span class="value" id="gwAgent">--</span>
        </div>
        <div class="status-row">
          <span class="label">Channel</span>
          <span class="value" id="gwChannel">--</span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="panel-section">
        <h3>Quick Actions</h3>
        <div class="quick-actions-grid">
          <button class="quick-btn" onclick="runQuickAction('health')">&#x1F3E5; Health</button>
          <button class="quick-btn" onclick="runQuickAction('status')">&#x1F4CA; Status</button>
          <button class="quick-btn" onclick="runQuickAction('sessions')">&#x1F4CB; Sessions</button>
          <button class="quick-btn" onclick="runQuickAction('agents')">&#x1F916; Agents</button>
          <button class="quick-btn" onclick="runQuickAction('channels')">&#x1F4E1; Channels</button>
        </div>
      </div>

      <!-- Output -->
      <div class="panel-section">
        <h3>Output</h3>
        <div class="panel-output" id="panelOutput">Run a quick action to see output here.</div>
      </div>

      <!-- Tasks -->
      <div class="panel-section">
        <h3>ðŸ¦ž Task Board</h3>
        <div class="task-list" id="taskList">
          <div class="task-item blocked">
            <span class="task-dot"></span>
            <span class="task-text">Fix memory search (embedding API key needed)</span>
            <span class="task-agent">ðŸ¦ž Steven</span>
            <span class="task-tag">blocked</span>
          </div>
          <div class="task-item todo">
            <span class="task-dot"></span>
            <span class="task-text">Create HEARTBEAT.md with check schedule</span>
            <span class="task-agent">ðŸ¦ž Steven</span>
            <span class="task-tag">todo</span>
          </div>
          <div class="task-item todo">
            <span class="task-dot"></span>
            <span class="task-text">Design avatar</span>
            <span class="task-agent">ðŸ¦ž Steven</span>
            <span class="task-tag">todo</span>
          </div>
          <div class="task-item active">
            <span class="task-dot"></span>
            <span class="task-text">Work entirely inside VM on madLadsLab projects</span>
            <span class="task-agent">ðŸ’» Dennis</span>
            <span class="task-tag">active</span>
          </div>
          <div class="task-item todo">
            <span class="task-dot"></span>
            <span class="task-text">Explore & inventory /srv webstack projects</span>
            <span class="task-agent">ðŸ’» Dennis</span>
            <span class="task-tag">todo</span>
          </div>
          <div class="task-item todo">
            <span class="task-dot"></span>
            <span class="task-text">Open tickets for perf/refactoring</span>
            <span class="task-agent">ðŸ¦ž Steven</span>
            <span class="task-tag">todo</span>
          </div>
          <div class="task-item done">
            <span class="task-dot"></span>
            <span class="task-text">Identity setup (IDENTITY, USER, SOUL)</span>
            <span class="task-agent">ðŸ¦ž Steven</span>
            <span class="task-tag">done</span>
          </div>
          <div class="task-item done">
            <span class="task-dot"></span>
            <span class="task-text">Initial memory system configured</span>
            <span class="task-agent">ðŸ¦ž Steven</span>
            <span class="task-tag">done</span>
          </div>
          <div class="task-item todo">
            <span class="task-dot"></span>
            <span class="task-text">Security audit â€” SSH, firewall, exposed ports</span>
            <span class="task-agent">ðŸ”’ Napster</span>
            <span class="task-tag">todo</span>
          </div>
          <div class="task-item todo">
            <span class="task-dot"></span>
            <span class="task-text">Document team roles & onboarding flow</span>
            <span class="task-agent">ðŸ“‹ Carol</span>
            <span class="task-tag">todo</span>
          </div>
          <div class="task-item todo">
            <span class="task-dot"></span>
            <span class="task-text">SSL cert expiry monitoring</span>
            <span class="task-agent">ðŸ”’ Napster</span>
            <span class="task-tag">todo</span>
          </div>
          <div class="task-item todo">
            <span class="task-dot"></span>
            <span class="task-text">Marketing campaign â€” social & SEO content</span>
            <span class="task-agent">ðŸ¦ž Steven</span>
            <span class="task-tag">todo</span>
          </div>
        </div>
      </div>

      <!-- Sessions -->
      <div class="panel-section">
        <h3>Sessions</h3>
        <div class="panel-output" id="sessionsList">Tap "Sessions" above to load.</div>
      </div>
    </div>
  </div>
</div>

<script>
  // === State ===
  let isRecording = false;
  let recognition = null;
  let isSending = false;
  let panelOpen = false;
  const sessionId = localStorage.getItem('sc-sessionId') || ('sc-' + Date.now().toString(36));
  localStorage.setItem('sc-sessionId', sessionId);

  // === Speech Recognition ===
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      document.getElementById('msgInput').value = transcript;
      stopMic();
      sendMessage();
    };

    recognition.onerror = (event) => {
      console.error('Speech error:', event.error);
      stopMic();
      if (event.error === 'no-speech') {
        addSystemMessage('No speech detected. Try again.');
      }
    };

    recognition.onend = () => stopMic();
  }

  function toggleMic() {
    if (!recognition) {
      addSystemMessage('Speech recognition not supported. Use Chrome or Safari.');
      return;
    }
    if (isRecording) {
      recognition.stop();
    } else {
      isRecording = true;
      document.getElementById('micBtn').classList.add('recording');
      recognition.start();
    }
  }

  function stopMic() {
    isRecording = false;
    document.getElementById('micBtn').classList.remove('recording');
  }

  // === Text-to-Speech ===
  function speak(text) {
    if (!document.getElementById('autoSpeak').checked) return;
    if (!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const cleaned = text.replace(/```[\s\S]*?```/g, ' code block ')
                        .replace(/[*_#`~]/g, '')
                        .replace(/https?:\/\/\S+/g, ' link ')
                        .substring(0, 2000);
    const utter = new SpeechSynthesisUtterance(cleaned);
    utter.rate = 1.0;
    utter.pitch = 0.9;
    window.speechSynthesis.speak(utter);
  }

  function speakText(el) {
    const text = el.closest('.message').querySelector('.msg-text').textContent;
    window.speechSynthesis.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.rate = 1.0;
    utter.pitch = 0.9;
    window.speechSynthesis.speak(utter);
  }

  // === Messages ===
  function addMessage(role, content) {
    const container = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'message ' + role;
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    if (role === 'assistant') {
      div.innerHTML = `<span class="msg-text">${escapeHtml(content)}</span>
        <div class="msg-footer">
          <span class="timestamp">${time}</span>
          <button class="speak-btn" onclick="speakText(this)" title="Read aloud">&#x1F50A;</button>
        </div>`;
    } else {
      div.innerHTML = `<span class="msg-text">${escapeHtml(content)}</span><div class="timestamp">${time}</div>`;
    }
    container.appendChild(div);
    requestAnimationFrame(() => container.scrollTop = container.scrollHeight);
    return div;
  }

  function addSystemMessage(text) {
    const container = document.getElementById('messages');
    const div = document.createElement('div');
    div.className = 'message system';
    div.textContent = text;
    container.appendChild(div);
    requestAnimationFrame(() => container.scrollTop = container.scrollHeight);
  }

  function escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
  }

  // === Send Message ===
  async function sendMessage() {
    const input = document.getElementById('msgInput');
    const msg = input.value.trim();
    if (!msg || isSending) return;

    input.value = '';
    addMessage('user', msg);
    isSending = true;
    document.getElementById('sendBtn').disabled = true;
    document.getElementById('typingIndicator').classList.add('visible');

    try {
      const resp = await fetch('/stevenClawbert/message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: msg,
          sessionId: sessionId,
          deliver: document.getElementById('deliverToggle').checked
        })
      });
      const data = await resp.json();
      document.getElementById('typingIndicator').classList.remove('visible');

      if (data.success && data.response) {
        addMessage('assistant', data.response);
        speak(data.response);
        notifyResponse(data.response);
      } else if (data.response) {
        addMessage('assistant', data.response);
        notifyResponse(data.response);
      } else {
        addSystemMessage('Error: ' + (data.error || 'No response from agent'));
      }
    } catch (err) {
      document.getElementById('typingIndicator').classList.remove('visible');
      addSystemMessage('Connection error: ' + err.message);
    }

    isSending = false;
    document.getElementById('sendBtn').disabled = false;
  }

  // Enter key
  document.getElementById('msgInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // === Handle mobile keyboard resize ===
  const vv = window.visualViewport;
  if (vv) {
    vv.addEventListener('resize', () => {
      document.body.style.height = vv.height + 'px';
      const msgs = document.getElementById('messages');
      requestAnimationFrame(() => msgs.scrollTop = msgs.scrollHeight);
    });
  }

  // === Options tray toggle ===
  function toggleOptions() {
    const tray = document.getElementById('optionsTray');
    const btn = document.getElementById('optionsBtn');
    tray.classList.toggle('open');
    btn.classList.toggle('active');
  }

  // === Panel / Bottom Sheet toggle ===
  function togglePanel() {
    panelOpen = !panelOpen;
    const sheet = document.getElementById('bottomSheet');
    const overlay = document.getElementById('sheetOverlay');
    const btn = document.getElementById('panelBtn');

    if (window.innerWidth >= 769) {
      // Desktop: toggle sidebar
      sheet.classList.toggle('collapsed-desktop');
      btn.classList.toggle('active', !sheet.classList.contains('collapsed-desktop'));
    } else {
      // Mobile: bottom sheet
      sheet.classList.toggle('open', panelOpen);
      overlay.classList.toggle('open', panelOpen);
      btn.classList.toggle('active', panelOpen);
    }
  }

  // === Quick Actions ===
  async function runQuickAction(action) {
    const output = document.getElementById('panelOutput');
    output.textContent = 'Running...';

    let url;
    switch (action) {
      case 'health': url = '/stevenClawbert/health'; break;
      case 'status': url = '/stevenClawbert/status'; break;
      case 'sessions': url = '/stevenClawbert/sessions'; break;
      case 'agents':
      case 'channels':
        try {
          const cmd = action === 'agents' ? 'agents list' : 'channels status';
          const r = await fetch('/stevenClawbert/command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ command: cmd })
          });
          const d = await r.json();
          output.textContent = d.output || d.error || 'No output';
        } catch (e) { output.textContent = 'Error: ' + e.message; }
        return;
      default: return;
    }

    try {
      const resp = await fetch(url);
      const data = await resp.json();
      output.textContent = data.output || data.error || JSON.stringify(data, null, 2);

      if (action === 'health' && data.output) updateStatusFromHealth(data.output);
      if (action === 'sessions' && data.output) {
        document.getElementById('sessionsList').textContent = data.output;
      }
    } catch (err) {
      output.textContent = 'Error: ' + err.message;
    }
  }

  function updateStatusFromHealth(text) {
    const gwEl = document.getElementById('gwStatus');
    gwEl.innerHTML = text.includes('linked')
      ? '<span class="status-dot green"></span>Connected'
      : '<span class="status-dot red"></span>Disconnected';

    const agentMatch = text.match(/Agents?:\s*(.+)/i);
    if (agentMatch) document.getElementById('gwAgent').textContent = agentMatch[1].trim();

    const channelMatch = text.match(/WhatsApp:\s*(.+)/i);
    if (channelMatch) document.getElementById('gwChannel').textContent = channelMatch[1].trim().substring(0, 25);
  }

  // === Notifications (Service Worker based) ===
  let swRegistration = null;

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').then(reg => {
      swRegistration = reg;
    }).catch(err => console.warn('SW registration failed:', err));
  }

  function toggleNotifications(enabled) {
    if (enabled) {
      if (!('Notification' in window) || !('serviceWorker' in navigator)) {
        addSystemMessage('Notifications not supported in this browser.');
        document.getElementById('notifyToggle').checked = false;
        return;
      }
      Notification.requestPermission().then(perm => {
        if (perm === 'granted') {
          localStorage.setItem('sc-notify', '1');
        } else {
          document.getElementById('notifyToggle').checked = false;
          localStorage.removeItem('sc-notify');
          addSystemMessage('Notification permission denied. Enable it in browser settings.');
        }
      });
    } else {
      localStorage.removeItem('sc-notify');
    }
  }

  function notifyResponse(text) {
    if (document.hasFocus()) return;
    if (localStorage.getItem('sc-notify') !== '1') return;
    if (Notification.permission !== 'granted') return;
    const preview = text.length > 120 ? text.substring(0, 120) + 'â€¦' : text;
    if (swRegistration) {
      swRegistration.showNotification('ðŸ¦ž Steven Clawbert', {
        body: preview,
        icon: '/images/beaker_logo_no_stash.png',
        tag: 'sc-response'
      });
    } else if ('serviceWorker' in navigator) {
      // SW not cached yet â€” wait for it to be ready
      navigator.serviceWorker.ready.then(reg => {
        swRegistration = reg;
        reg.showNotification('ðŸ¦ž Steven Clawbert', {
          body: preview,
          icon: '/images/beaker_logo_no_stash.png',
          tag: 'sc-response'
        });
      }).catch(e => console.warn('Notification failed:', e));
    }
  }

  // Restore notification toggle from localStorage
  if (localStorage.getItem('sc-notify') === '1' && Notification.permission === 'granted') {
    document.getElementById('notifyToggle').checked = true;
  }

  // === Load Chat History ===
  async function loadHistory() {
    try {
      const resp = await fetch('/stevenClawbert/history?sessionId=' + encodeURIComponent(sessionId));
      const data = await resp.json();
      if (data.success && data.history && data.history.length > 0) {
        // Clear the default system message
        const container = document.getElementById('messages');
        container.innerHTML = '';
        // Add a system message header
        const sysDiv = document.createElement('div');
        sysDiv.className = 'message system';
        sysDiv.textContent = 'Chat history restored. ' + data.history.length + ' messages loaded.';
        container.appendChild(sysDiv);
        // Render each message
        data.history.forEach(msg => {
          const div = document.createElement('div');
          div.className = 'message ' + msg.role;
          const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          if (msg.role === 'assistant') {
            div.innerHTML = `<span class="msg-text">${escapeHtml(msg.content || '')}</span>
              <div class="msg-footer">
                <span class="timestamp">${time}</span>
                <button class="speak-btn" onclick="speakText(this)" title="Read aloud">&#x1F50A;</button>
              </div>`;
          } else {
            div.innerHTML = `<span class="msg-text">${escapeHtml(msg.content || '')}</span><div class="timestamp">${time}</div>`;
          }
          container.appendChild(div);
        });
        requestAnimationFrame(() => container.scrollTop = container.scrollHeight);
      }
    } catch (err) {
      console.warn('Failed to load history:', err);
    }
  }

  // Init: start panel collapsed on desktop, load health & history
  if (window.innerWidth >= 769) {
    document.getElementById('bottomSheet').classList.add('collapsed-desktop');
  }
  setTimeout(() => runQuickAction('health'), 500);
  loadHistory();
</script>
</body>
</html>
