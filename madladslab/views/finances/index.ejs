<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | MadLadsLab</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: #0d0d0d;
      color: #e0e0e0;
      min-height: 100vh;
    }
    a { color: #00ff88; text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* ── Header ── */
    .fin-header {
      background: linear-gradient(135deg, #0a2a1a 0%, #003322 100%);
      border-bottom: 2px solid #00ff88;
      padding: 1.25rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .fin-header h1 { font-size: 1.5rem; color: #00ff88; letter-spacing: 1px; }
    .fin-header nav { display: flex; gap: 0.75rem; flex-wrap: wrap; }
    .btn {
      display: inline-block;
      padding: 0.45rem 1rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.85; }
    .btn-primary { background: #00ff88; color: #000; }
    .btn-outline { background: transparent; border: 1px solid #00ff88; color: #00ff88; }
    .btn-danger  { background: #ff4444; color: #fff; }
    .btn-sm { padding: 0.3rem 0.7rem; font-size: 0.78rem; }

    /* ── Layout ── */
    .fin-layout { display: grid; grid-template-columns: 260px 1fr; gap: 0; min-height: calc(100vh - 64px); }
    @media (max-width: 900px) { .fin-layout { grid-template-columns: 1fr; } }

    /* ── Sidebar ── */
    .fin-sidebar {
      background: #111;
      border-right: 1px solid #222;
      padding: 1.5rem 1rem;
    }
    .fin-sidebar h3 { color: #00ff88; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.75rem; }
    .filter-form label { display: block; font-size: 0.8rem; color: #aaa; margin-bottom: 0.25rem; margin-top: 0.75rem; }
    .filter-form select, .filter-form input {
      width: 100%; padding: 0.45rem 0.6rem;
      background: #1a1a1a; border: 1px solid #333; color: #e0e0e0;
      border-radius: 4px; font-size: 0.85rem;
    }
    .filter-form select:focus, .filter-form input:focus { outline: none; border-color: #00ff88; }

    .summary-card {
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      padding: 0.75rem;
      margin-top: 0.75rem;
    }
    .summary-card h4 { font-size: 0.78rem; color: #888; margin-bottom: 0.5rem; }
    .summary-row { display: flex; justify-content: space-between; font-size: 0.8rem; padding: 0.2rem 0; border-bottom: 1px solid #222; }
    .summary-row:last-child { border-bottom: none; }
    .summary-row .entity-name { color: #ccc; }
    .summary-row .amount { font-weight: 600; }
    .amount.neg { color: #ff6666; }
    .amount.pos { color: #00ff88; }

    /* ── Main ── */
    .fin-main { padding: 1.5rem; overflow-x: auto; }
    .fin-main h2 { font-size: 1.1rem; color: #00ff88; margin-bottom: 1rem; }

    /* ── Manual entry form ── */
    .manual-form {
      background: #111;
      border: 1px solid #2a2a2a;
      border-radius: 6px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }
    .manual-form h3 { font-size: 0.85rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1rem; }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.75rem;
    }
    .form-group { display: flex; flex-direction: column; gap: 0.25rem; }
    .form-group label { font-size: 0.78rem; color: #aaa; }
    .form-group input, .form-group select, .form-group textarea {
      padding: 0.45rem 0.6rem;
      background: #1a1a1a; border: 1px solid #333; color: #e0e0e0;
      border-radius: 4px; font-size: 0.85rem;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: #00ff88;
    }
    .form-full { grid-column: 1 / -1; }

    /* ── Transactions table ── */
    .tx-table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    thead th {
      background: #111; color: #888; font-size: 0.75rem; text-transform: uppercase;
      letter-spacing: 0.5px; padding: 0.6rem 0.75rem; text-align: left;
      border-bottom: 2px solid #222; white-space: nowrap;
    }
    tbody tr { border-bottom: 1px solid #1a1a1a; transition: background 0.15s; }
    tbody tr:hover { background: #181818; }
    tbody td { padding: 0.55rem 0.75rem; vertical-align: middle; }
    .td-amount { font-weight: 600; text-align: right; }
    .td-date { color: #888; white-space: nowrap; }
    .td-desc { max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .td-actions { white-space: nowrap; }
    .entity-badge {
      display: inline-block; padding: 0.15rem 0.45rem; border-radius: 3px;
      font-size: 0.72rem; font-weight: 600; white-space: nowrap;
    }
    .eb-w2      { background: #1a3a5c; color: #64b5f6; }
    .eb-mll     { background: #1a3a2a; color: #66bb6a; }
    .eb-scott   { background: #3a2a1a; color: #ffa726; }
    .eb-oil     { background: #2a1a3a; color: #ba68c8; }
    .eb-vrbo    { background: #3a1a1a; color: #ef5350; }
    .eb-airbnb  { background: #3a1a2a; color: #f06292; }
    .eb-home    { background: #1a1a1a; color: #90a4ae; }

    /* ── Toast ── */
    #toast {
      position: fixed; bottom: 1.5rem; right: 1.5rem;
      background: #00ff88; color: #000; padding: 0.75rem 1.25rem;
      border-radius: 6px; font-weight: 600; font-size: 0.9rem;
      display: none; z-index: 9999;
    }
    #toast.error { background: #ff4444; color: #fff; }

    /* ── Inline edit modal ── */
    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.8); z-index: 10000;
      align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: #151515; border: 1px solid #00ff88; border-radius: 8px;
      padding: 1.5rem; width: 100%; max-width: 480px; position: relative;
    }
    .modal-box h3 { color: #00ff88; margin-bottom: 1rem; font-size: 1rem; }
    .modal-close {
      position: absolute; top: 0.75rem; right: 1rem;
      background: none; border: none; color: #888; font-size: 1.5rem;
      cursor: pointer; line-height: 1;
    }
    .modal-close:hover { color: #fff; }
  </style>
</head>
<body>

<div class="fin-header">
  <h1>$ Bookkeeping Dashboard</h1>
  <nav>
    <a href="/finances/upload" class="btn btn-primary">+ Upload Statements</a>
    <a href="/finances/report" class="btn btn-outline">Report</a>
    <a href="/finances/uploads" class="btn btn-outline">Recent Uploads</a>
    <a href="/" class="btn btn-outline">Home</a>
  </nav>
</div>

<div class="fin-layout">

  <!-- Sidebar: filters + summary -->
  <aside class="fin-sidebar">
    <h3>Filters</h3>
    <form class="filter-form" method="GET" action="/finances">
      <label>Tax Year</label>
      <select name="year">
        <option value="">All Years</option>
        <% [2024,2023,2022,2021].forEach(y => { %>
          <option value="<%= y %>" <%= filterYear == y ? 'selected' : '' %>><%= y %></option>
        <% }) %>
      </select>

      <label>Entity</label>
      <select name="entity">
        <option value="">All Entities</option>
        <% ['W2 Marketing LLC','madladslab LLC','Scott Employment','Oil Royalties','VRBO','Airbnb','Personal / Home'].forEach(e => { %>
          <option value="<%= e %>" <%= filterEntity === e ? 'selected' : '' %>><%= e %></option>
        <% }) %>
      </select>

      <button type="submit" class="btn btn-outline" style="margin-top:1rem;width:100%">Apply</button>
      <a href="/finances" class="btn btn-outline" style="margin-top:0.5rem;width:100%;text-align:center">Clear</a>
    </form>

    <!-- Summary cards by entity/year -->
    <% if (summary && summary.length > 0) { %>
      <div style="margin-top:1.5rem">
        <h3>Totals</h3>
        <%
          const grouped = {};
          summary.forEach(s => {
            const key = s._id.taxYear || 'N/A';
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(s);
          });
        %>
        <% Object.keys(grouped).sort((a,b) => b-a).forEach(yr => { %>
          <div class="summary-card">
            <h4>Tax Year <%= yr %></h4>
            <% grouped[yr].forEach(s => { %>
              <div class="summary-row">
                <span class="entity-name"><%= s._id.entity || 'Unknown' %></span>
                <span class="amount <%= s.total < 0 ? 'neg' : 'pos' %>">
                  $<%= Math.abs(s.total).toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}) %>
                </span>
              </div>
            <% }) %>
          </div>
        <% }) %>
      </div>
    <% } %>
  </aside>

  <!-- Main content -->
  <main class="fin-main">

    <!-- Source filter banner -->
    <% if (filterSource) { %>
      <div style="background:rgba(0,255,136,0.08);border-left:3px solid #00ff88;border-radius:4px;padding:0.6rem 1rem;margin-bottom:1rem;font-size:0.82rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap">
        <span>Showing upload: <strong style="color:#00ff88"><%= filterSource %></strong></span>
        <a href="/finances" style="color:#888;font-size:0.78rem">Clear filter ×</a>
      </div>
    <% } %>

    <!-- Manual Entry Form -->
    <div class="manual-form">
      <h3>Manual Transaction Entry</h3>
      <form id="manualForm">
        <div class="form-grid">
          <div class="form-group">
            <label>Date</label>
            <input type="date" name="date" required>
          </div>
          <div class="form-group">
            <label>Amount ($)</label>
            <input type="number" name="amount" step="0.01" placeholder="-49.99" required>
          </div>
          <div class="form-group">
            <label>Tax Year</label>
            <select name="taxYear">
              <% [2024,2023,2022,2021].forEach(y => { %><option value="<%= y %>"><%= y %></option><% }) %>
            </select>
          </div>
          <div class="form-group">
            <label>Entity</label>
            <select name="entity">
              <% ['W2 Marketing LLC','madladslab LLC','Scott Employment','Oil Royalties','VRBO','Airbnb','Personal / Home'].forEach(e => { %>
                <option value="<%= e %>"><%= e %></option>
              <% }) %>
            </select>
          </div>
          <div class="form-group">
            <label>Category</label>
            <select name="category">
              <% EXPENSE_CATEGORIES.forEach(c => { %><option value="<%= c %>"><%= c %></option><% }) %>
            </select>
          </div>
          <div class="form-group">
            <label>Institution</label>
            <input type="text" name="institution" placeholder="Chase, Amex…">
          </div>
          <div class="form-group">
            <label>Account Type</label>
            <select name="accountType">
              <option>Checking</option><option>Savings</option><option>Credit Card</option><option>Other</option>
            </select>
          </div>
          <div class="form-group form-full">
            <label>Description</label>
            <input type="text" name="description" placeholder="Vendor / memo" required>
          </div>
          <div class="form-group form-full">
            <label>Notes</label>
            <input type="text" name="notes" placeholder="Optional notes">
          </div>
        </div>
        <div style="margin-top:1rem">
          <button type="submit" class="btn btn-primary">Save Entry</button>
        </div>
      </form>
    </div>

    <!-- Transactions table -->
    <h2>Transactions (<%= transactions.length %>)</h2>
    <% if (transactions.length === 0) { %>
      <p style="color:#666;margin-top:1rem">No transactions found. Upload statements or add manual entries above.</p>
    <% } else { %>
      <div class="tx-table-wrap">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Category</th>
              <th>Entity</th>
              <th>Institution</th>
              <th>Year</th>
              <th style="text-align:right">Amount</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% transactions.forEach(tx => {
              const entityClass = {
                'W2 Marketing LLC': 'eb-w2',
                'madladslab LLC':   'eb-mll',
                'Scott Employment': 'eb-scott',
                'Oil Royalties':    'eb-oil',
                'VRBO':             'eb-vrbo',
                'Airbnb':           'eb-airbnb',
                'Personal / Home':  'eb-home'
              }[tx.entity] || 'eb-home';
            %>
            <tr data-id="<%= tx._id %>">
              <td class="td-date"><%= tx.date ? new Date(tx.date).toLocaleDateString('en-US') : '—' %></td>
              <td class="td-desc" title="<%= tx.description %>"><%= tx.description %></td>
              <td><%= tx.category %></td>
              <td><span class="entity-badge <%= entityClass %>"><%= tx.entity %></span></td>
              <td style="color:#888;font-size:0.78rem"><%= tx.institution %></td>
              <td style="color:#888"><%= tx.taxYear || '—' %></td>
              <td class="td-amount <%= tx.amount < 0 ? 'neg' : 'pos' %>">
                <%= tx.amount < 0 ? '-' : '+' %>$<%= Math.abs(tx.amount).toLocaleString('en-US', {minimumFractionDigits:2,maximumFractionDigits:2}) %>
              </td>
              <td class="td-actions">
                <button class="btn btn-outline btn-sm edit-btn"
                  data-id="<%= tx._id %>"
                  data-category="<%= tx.category %>"
                  data-entity="<%= tx.entity %>"
                  data-notes="<%= tx.notes || '' %>">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteTx('<%= tx._id %>')">Del</button>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    <% } %>
  </main>
</div>

<!-- Edit modal -->
<div class="modal-overlay" id="editModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeEdit()">&times;</button>
    <h3>Edit Transaction</h3>
    <input type="hidden" id="editId">
    <div class="form-group" style="margin-bottom:0.75rem">
      <label>Category</label>
      <select id="editCategory">
        <% EXPENSE_CATEGORIES.forEach(c => { %><option value="<%= c %>"><%= c %></option><% }) %>
      </select>
    </div>
    <div class="form-group" style="margin-bottom:0.75rem">
      <label>Entity</label>
      <select id="editEntity">
        <% ['W2 Marketing LLC','madladslab LLC','Scott Employment','Oil Royalties','VRBO','Airbnb','Personal / Home'].forEach(e => { %>
          <option value="<%= e %>"><%= e %></option>
        <% }) %>
      </select>
    </div>
    <div class="form-group" style="margin-bottom:1rem">
      <label>Notes</label>
      <input type="text" id="editNotes" placeholder="Optional notes">
    </div>
    <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
  </div>
</div>

<div id="toast"></div>

<script>
// ── Manual entry ────────────────────────────────────────────────────────────
document.getElementById('manualForm').addEventListener('submit', async e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  const res = await fetch('/finances/transaction', {
    method: 'POST', headers: {'Content-Type':'application/json'},
    body: JSON.stringify(data)
  });
  const json = await res.json();
  if (json.success) { showToast('Entry saved!'); setTimeout(() => location.reload(), 1000); }
  else showToast(json.message, true);
});

// ── Edit button delegation (avoids EJS inline quote escaping issues) ────────
document.addEventListener('click', e => {
  const btn = e.target.closest('.edit-btn');
  if (!btn) return;
  openEdit(btn.dataset.id, btn.dataset.category, btn.dataset.entity, btn.dataset.notes);
});

// ── Edit modal ──────────────────────────────────────────────────────────────
function openEdit(id, category, entity, notes) {
  document.getElementById('editId').value       = id;
  document.getElementById('editCategory').value = category;
  document.getElementById('editEntity').value   = entity;
  document.getElementById('editNotes').value    = notes;
  document.getElementById('editModal').classList.add('open');
}
function closeEdit() { document.getElementById('editModal').classList.remove('open'); }

async function saveEdit() {
  const id       = document.getElementById('editId').value;
  const category = document.getElementById('editCategory').value;
  const entity   = document.getElementById('editEntity').value;
  const notes    = document.getElementById('editNotes').value;
  const res = await fetch(`/finances/transaction/${id}`, {
    method: 'PATCH', headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ category, entity, notes })
  });
  const json = await res.json();
  if (json.success) { closeEdit(); showToast('Updated!'); setTimeout(() => location.reload(), 800); }
  else showToast(json.message, true);
}

// ── Delete ──────────────────────────────────────────────────────────────────
async function deleteTx(id) {
  if (!confirm('Delete this transaction?')) return;
  const res  = await fetch(`/finances/transaction/${id}`, { method: 'DELETE' });
  const json = await res.json();
  if (json.success) {
    document.querySelector(`tr[data-id="${id}"]`)?.remove();
    showToast('Deleted');
  } else showToast(json.message, true);
}

// ── Toast ───────────────────────────────────────────────────────────────────
function showToast(msg, isError = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = isError ? 'error' : '';
  t.style.display = 'block';
  setTimeout(() => { t.style.display = 'none'; }, 3000);
}

// Close modal on backdrop click
document.getElementById('editModal').addEventListener('click', e => {
  if (e.target === document.getElementById('editModal')) closeEdit();
});
</script>
</body>
</html>
