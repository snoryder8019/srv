<!-- views/euker.ejs -->
<!DOCTYPE html>
<html>
<head>
  <title>Euker</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { color: #333; margin-bottom: 8px; }
    h2 { color: #444; margin-top: 24px; border-bottom: 2px solid #ddd; padding-bottom: 8px; }
    h3 { color: #555; margin: 16px 0 8px; }

    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }

    button {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover:not([disabled]) { background: #f0f0f0; border-color: #999; }
    button:active:not([disabled]) { transform: translateY(1px); }
    button[disabled] { opacity: 0.5; cursor: not-allowed; background: #f9f9f9; }

    .card {
      border: 2px solid #2c5aa0;
      border-radius: 8px;
      padding: 8px 14px;
      font-weight: bold;
      font-size: 14px;
      background: linear-gradient(145deg, #ffffff, #f0f4ff);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card:hover:not([disabled]) {
      background: linear-gradient(145deg, #e8f0ff, #ffffff);
      border-color: #1a3d7a;
      box-shadow: 0 3px 8px rgba(44,90,160,0.3);
      transform: translateY(-2px);
    }
    .card[disabled] {
      opacity: 0.4;
      cursor: not-allowed;
      background: #f5f5f5;
      border-color: #ccc;
    }

    .pill {
      display: inline-block;
      padding: 4px 12px;
      border: 1px solid #ddd;
      border-radius: 999px;
      background: #fff;
      font-size: 13px;
    }
    .pill span { font-weight: bold; color: #2c5aa0; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 12px;
      border-radius: 8px;
      max-width: 100%;
      overflow: auto;
      font-size: 12px;
    }

    select { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; }
    input[type="text"] { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; }

    /* Header and controls */
    .game-header {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .game-controls { margin-top: 16px; }
    .control-buttons {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .primary-btn {
      background: linear-gradient(145deg, #2c5aa0, #1a3d7a);
      color: #fff;
      border: none;
      font-weight: 600;
    }
    .primary-btn:hover:not([disabled]) {
      background: linear-gradient(145deg, #1a3d7a, #2c5aa0);
      box-shadow: 0 2px 8px rgba(44,90,160,0.3);
    }
    .game-status {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Sections */
    .bidding-section, .manual-play {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .control-panel {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
    }
    .control-panel small {
      display: block;
      margin-top: 8px;
      color: #666;
    }
    .control-panel code {
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }

    /* Table styles from table.ejs */
    .game-table-container {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .game-table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 12px;
    }
    .game-table th, .game-table td {
      border: 1px solid #e0e0e0;
      padding: 10px 12px;
      text-align: left;
    }
    .game-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #444;
    }
    .game-table .current-turn {
      background: #fffbea;
      border-left: 3px solid #f59e0b;
    }
    .game-table .player-name { font-weight: 600; }
    .game-table .turn-indicator {
      color: #f59e0b;
      margin-left: 8px;
      font-size: 18px;
    }
    .game-table .hand-cards { display: flex; gap: 6px; flex-wrap: wrap; }
    .game-table .empty-hand { color: #999; font-style: italic; }
    .game-table .card-count {
      text-align: center;
      font-weight: bold;
      color: #666;
    }

    .scoreboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 24px;
    }
    .score-section {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
    }
    .score-grid { display: flex; flex-direction: column; gap: 12px; }
    .team-score {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #fff;
      border-radius: 6px;
      border-left: 4px solid #2c5aa0;
    }
    .team-score.team-ew { border-left-color: #dc2626; }
    .team-label { font-weight: 500; color: #555; }
    .score-value {
      font-size: 24px;
      font-weight: bold;
      color: #2c5aa0;
    }
    .team-ew .score-value { color: #dc2626; }

    .current-trick {
      margin-top: 20px;
      padding: 16px;
      background: #f0f9ff;
      border-radius: 8px;
      border: 1px solid #bae6fd;
    }
    .trick-cards { display: flex; gap: 12px; flex-wrap: wrap; }
    .trick-play {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 12px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .trick-player { font-size: 11px; color: #666; margin-bottom: 4px; }
    .trick-card { font-weight: bold; font-size: 16px; }
  </style>
</head>
<body>
  <header class="game-header">
    <h1><%= message %></h1>
    <p><%= rules %></p>

    <div class="game-controls">
      <div class="control-buttons">
        <button id="startBtn" class="primary-btn">Start / Deal</button>
        <button id="refreshBtn">Refresh</button>
      </div>

      <div class="game-status">
        <span class="pill">Phase: <span id="phase"><%= gameState.phase %></span></span>
        <span class="pill">Dealer: <span id="dealer"><%= gameState.players[gameState.dealerIdx] || '-' %></span></span>
        <span class="pill">Turn: <span id="turn"><%= gameState.players[gameState.turnIdx] || '-' %></span></span>
        <span class="pill">Upcard: <span id="upcard"><%= gameState.upcard || '-' %></span></span>
        <span class="pill">Trump: <span id="trump"><%= gameState.trump || '-' %></span></span>
      </div>
    </div>
  </header>

  <!-- Bidding controls -->
  <section class="bidding-section">
    <h2>Bidding Controls</h2>
    <div class="grid">
      <div class="control-panel">
        <h3>Round 1 (Upcard Suit)</h3>
        <div class="row">
          <button id="orderBtn">Order Up</button>
          <button id="passBtn">Pass</button>
        </div>
        <small>Use when Phase is <code>bidding1</code>.</small>
      </div>
      <div class="control-panel">
        <h3>Round 2 (Other Suit)</h3>
        <div class="row">
          <select id="chooseSuit">
            <option value="H">Hearts ♥</option>
            <option value="D">Diamonds ♦</option>
            <option value="C">Clubs ♣</option>
            <option value="S">Spades ♠</option>
          </select>
          <button id="chooseBtn">Choose</button>
          <button id="dealerChooseBtn" title="Dealer must choose at end of round 2">Dealer Choose</button>
        </div>
        <small>Use when Phase is <code>bidding2</code>.</small>
      </div>
    </div>
  </section>

  <!-- Play a specific card (fallback manual) -->
  <section class="manual-play">
    <h3>Manual Play (Fallback)</h3>
    <form id="playForm" class="row">
      <select id="playerInput">
        <option>North</option><option>East</option><option>South</option><option>West</option>
      </select>
      <input type="text" id="cardInput" placeholder="Card (e.g. 9H)">
      <button type="submit">Play Card</button>
    </form>
  </section>

  <pre id="output"></pre>

  <!-- Server-rendered table with clickable cards -->
  <%- include('table', { gameState }) %>

  <script>
    const $ = s => document.querySelector(s);
    const output = $('#output');

    const api = (path, opts={}) =>
      fetch(path, Object.assign({ headers:{'Content-Type':'application/json'} }, opts))
      .then(r => r.json());

    // controls
    $('#startBtn').addEventListener('click', async () => {
      const data = await api('/euker/start', { method:'POST' });
      output.textContent = JSON.stringify(data, null, 2);
      location.reload(); // re-render EJS to update hands/table
    });

    $('#refreshBtn').addEventListener('click', () => location.reload());

    // bidding round 1
    $('#orderBtn').addEventListener('click', async () => {
      const data = await api('/euker/bid', { method:'POST', body: JSON.stringify({ action:'order' }) });
      output.textContent = JSON.stringify(data, null, 2);
      location.reload();
    });
    $('#passBtn').addEventListener('click', async () => {
      const data = await api('/euker/bid', { method:'POST', body: JSON.stringify({ action:'pass' }) });
      output.textContent = JSON.stringify(data, null, 2);
      if (!data.error) location.reload();
    });

    // bidding round 2
    $('#chooseBtn').addEventListener('click', async () => {
      const suit = $('#chooseSuit').value;
      const data = await api('/euker/bid', { method:'POST', body: JSON.stringify({ action:'choose', suit }) });
      output.textContent = JSON.stringify(data, null, 2);
      if (!data.error) location.reload();
    });
    $('#dealerChooseBtn').addEventListener('click', async () => {
      const suit = $('#chooseSuit').value;
      const data = await api('/euker/dealer-choose', { method:'POST', body: JSON.stringify({ suit }) });
      output.textContent = JSON.stringify(data, null, 2);
      if (!data.error) location.reload();
    });

    // manual play fallback
    $('#playForm').addEventListener('submit', async e => {
      e.preventDefault();
      const card = $('#cardInput').value.trim();
      const player = $('#playerInput').value;
      const data = await api('/euker/play', { method:'POST', body: JSON.stringify({ card, player }) });
      output.textContent = JSON.stringify(data, null, 2);
      if (!data.error) location.reload();
    });

    // tap-to-play (delegate)
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.card');
      if (!btn) return;
      const player = btn.dataset.player;
      const card = btn.dataset.card;
      const data = await api('/euker/play', { method:'POST', body: JSON.stringify({ player, card }) });
      output.textContent = JSON.stringify(data, null, 2);
      if (!data.error) btn.setAttribute('disabled','');
      // optionally refresh to re-render hands/turn/score
      if (!data.error) location.reload();
    });

    // quick state peek without reload (optional)
    async function peek() {
      const s = await api('/euker/state');
      $('#phase').textContent = s.gameState.phase || '-';
      $('#dealer').textContent = (s.gameState.players?.[s.gameState.dealerIdx]) || '-';
      $('#turn').textContent = (s.gameState.players?.[s.gameState.turnIdx]) || '-';
      $('#upcard').textContent = s.gameState.upcard || '-';
      $('#trump').textContent = s.gameState.trump || '-';
    }
    peek();
  </script>
  <%-include('../mainContent/adminNav.ejs')%>
</body>
</html>
