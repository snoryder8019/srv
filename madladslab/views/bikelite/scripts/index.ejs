
<script>
  /**
   * Halloween Bikelite - Dual Module Handler
   * Module 1: Strobe Light with Color Selector
   * Module 2: Scrolling Chevron Pattern
   */
  (function() {
    'use strict';

    // ==================== SHARED UTILITIES ====================

    /**
     * Request fullscreen mode with cross-browser support
     */
    async function requestFullscreen(element) {
      try {
        if (element.requestFullscreen) {
          return await element.requestFullscreen();
        }
        if (element.webkitRequestFullscreen) {
          return await element.webkitRequestFullscreen();
        }
        if (element.mozRequestFullScreen) {
          return await element.mozRequestFullScreen();
        }
        if (element.msRequestFullscreen) {
          return await element.msRequestFullscreen();
        }
      } catch (error) {
        console.warn('Failed to enter fullscreen:', error);
      }
    }

    /**
     * Exit fullscreen mode with cross-browser support
     */
    async function exitFullscreen() {
      try {
        const isInFullscreen = document.fullscreenElement ||
                               document.webkitFullscreenElement ||
                               document.mozFullScreenElement ||
                               document.msFullscreenElement;

        if (!isInFullscreen) return;

        if (document.exitFullscreen) {
          await document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          await document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
          await document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
          await document.msExitFullscreen();
        }
      } catch (error) {
        console.warn('Failed to exit fullscreen:', error);
      }
    }

    /**
     * Check if currently in fullscreen mode
     */
    function isFullscreen() {
      return !!(
        document.fullscreenElement ||
        document.webkitFullscreenElement ||
        document.mozFullScreenElement ||
        document.msFullscreenElement
      );
    }

    // ==================== MODULE 1: STROBE LIGHT ====================

    const flashbox = document.getElementById('flashbox');
    const colorButtons = document.querySelectorAll('.color-btn');
    let selectedColor = '#ff6600'; // Default Halloween orange

    if (flashbox && colorButtons.length) {
      const flashOriginalState = {
        html: flashbox.innerHTML || ''
      };

      // Color selector handler
      colorButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent flashbox click

          // Remove active class from all buttons
          colorButtons.forEach(b => b.classList.remove('active'));

          // Add active class to clicked button
          btn.classList.add('active');

          // Update selected color
          selectedColor = btn.getAttribute('data-color');

          // Update flashbox border color
          flashbox.style.borderColor = selectedColor;

          // If in expanded mode, update animation color
          if (flashbox.classList.contains('expanded')) {
            updateStrobeColor(selectedColor);
          }
        });
      });

      // Create dynamic strobe animation
      function updateStrobeColor(color) {
        // Remove existing style if any
        const existingStyle = document.getElementById('dynamic-strobe-style');
        if (existingStyle) {
          existingStyle.remove();
        }

        // Create new style element
        const style = document.createElement('style');
        style.id = 'dynamic-strobe-style';
        style.textContent = `
          @keyframes strobeFlash {
            0% { background-color: #000; }
            5% { background-color: ${color}; }
            10% { background-color: #000; }
            15% { background-color: ${color}; }
            20% { background-color: #000; }
            25% { background-color: ${color}; }
            30% { background-color: #000; }
            50% { background-color: ${color}; }
            100% { background-color: #000; }
          }
          #flashbox.expanded {
            animation: strobeFlash 1.5s infinite;
          }
        `;
        document.head.appendChild(style);
      }

      // Flashbox toggle handler
      async function toggleFlashbox() {
        if (flashbox.classList.contains('expanded')) {
          // Exit mode
          await exitFullscreen();
          flashbox.classList.remove('expanded');
          flashbox.innerHTML = flashOriginalState.html;
          flashbox.style.animation = '';

          // Remove dynamic style
          const existingStyle = document.getElementById('dynamic-strobe-style');
          if (existingStyle) {
            existingStyle.remove();
          }
        } else {
          // Enter mode
          flashbox.classList.add('expanded');
          await requestFullscreen(flashbox);
          flashbox.innerHTML = `<h2 style="color: ${selectedColor};">Tap to Exit</h2>`;
          updateStrobeColor(selectedColor);
        }
      }

      // Handle fullscreen exit via ESC
      function handleFlashFullscreenChange() {
        if (!isFullscreen() && flashbox.classList.contains('expanded')) {
          flashbox.classList.remove('expanded');
          flashbox.innerHTML = flashOriginalState.html;
          flashbox.style.animation = '';

          const existingStyle = document.getElementById('dynamic-strobe-style');
          if (existingStyle) {
            existingStyle.remove();
          }
        }
      }

      flashbox.addEventListener('click', toggleFlashbox);

      const fullscreenEvents = [
        'fullscreenchange',
        'webkitfullscreenchange',
        'mozfullscreenchange',
        'MSFullscreenChange'
      ];

      fullscreenEvents.forEach(eventName => {
        document.addEventListener(eventName, handleFlashFullscreenChange);
      });
    }

    // ==================== MODULE 2: CHEVRON SCROLL ====================

    const chevronbox = document.getElementById('chevronbox');

    if (chevronbox) {
      const chevronOriginalState = {
        html: chevronbox.innerHTML || ''
      };

      // Chevron toggle handler
      async function toggleChevronbox() {
        if (chevronbox.classList.contains('expanded')) {
          // Exit mode
          await exitFullscreen();
          chevronbox.classList.remove('expanded');
          chevronbox.innerHTML = chevronOriginalState.html;
        } else {
          // Enter mode
          chevronbox.classList.add('expanded');
          await requestFullscreen(chevronbox);

          // Create chevron pattern
          const container = document.createElement('div');
          container.className = 'chevron-container';

          // Create two sets of chevrons for seamless scroll
          for (let set = 0; set < 2; set++) {
            const pattern = document.createElement('div');
            pattern.className = 'chevron-pattern';

            // Create 5 chevrons per set
            for (let i = 0; i < 5; i++) {
              const chevron = document.createElement('div');
              chevron.className = 'chevron';
              chevron.style.color = selectedColor; // Use selected color
              pattern.appendChild(chevron);
            }

            container.appendChild(pattern);
          }

          chevronbox.appendChild(container);
        }
      }

      // Handle fullscreen exit via ESC
      function handleChevronFullscreenChange() {
        if (!isFullscreen() && chevronbox.classList.contains('expanded')) {
          chevronbox.classList.remove('expanded');
          chevronbox.innerHTML = chevronOriginalState.html;
        }
      }

      chevronbox.addEventListener('click', toggleChevronbox);

      const fullscreenEvents = [
        'fullscreenchange',
        'webkitfullscreenchange',
        'mozfullscreenchange',
        'MSFullscreenChange'
      ];

      fullscreenEvents.forEach(eventName => {
        document.addEventListener(eventName, handleChevronFullscreenChange);
      });
    }

  })();
</script>
