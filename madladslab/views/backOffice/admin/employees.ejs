<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      min-height: 100vh;
    }

    .header {
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      padding: 1rem 2rem;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .nav {
      display: flex;
      gap: 1.5rem;
    }

    .nav a {
      color: white;
      text-decoration: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .nav a:hover, .nav a.active {
      background: rgba(255, 255, 255, 0.2);
    }

    .container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .page-header {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-header h2 {
      color: #333;
      font-size: 1.8rem;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .card h3 {
      color: #333;
      margin-bottom: 1.5rem;
      font-size: 1.3rem;
    }

    .employee-table {
      width: 100%;
      border-collapse: collapse;
    }

    .employee-table th {
      text-align: left;
      padding: 1rem;
      background: #f9fafb;
      color: #374151;
      font-weight: 600;
      border-bottom: 2px solid #e5e7eb;
    }

    .employee-table td {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
    }

    .employee-table tr:hover {
      background: #f9fafb;
    }

    .role-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .role-badge.admin {
      background: #fee2e2;
      color: #991b1b;
    }

    .role-badge.manager {
      background: #d1fae5;
      color: #065f46;
    }

    .role-badge.staff {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 15px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-badge.active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-badge.inactive {
      background: #fef3c7;
      color: #92400e;
    }

    .status-badge.terminated {
      background: #fee2e2;
      color: #991b1b;
    }

    .btn {
      display: inline-block;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: transform 0.2s;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-small {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }

    .btn-secondary {
      background: #6b7280;
    }

    .btn-success {
      background: #10b981;
    }

    .actions {
      display: flex;
      gap: 0.5rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6b7280;
    }

    .empty-state h3 {
      margin-bottom: 1rem;
      color: #374151;
    }

    .alert {
      padding: 1rem 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
      display: none;
    }

    .alert.success {
      background: #d1fae5;
      color: #065f46;
      border-left: 4px solid #10b981;
    }

    .alert.error {
      background: #fee2e2;
      color: #991b1b;
      border-left: 4px solid #ef4444;
    }

    .info-box {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      color: #1e40af;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Back Office - Admin</h1>
    <nav class="nav">
      <a href="/backOffice/admin">Dashboard</a>
      <a href="/backOffice/admin/employees" class="active">Employees</a>
      <a href="/backOffice/training">Training</a>
      <a href="/backOffice/recipes">Recipes</a>
      <a href="/backOffice/tasks">Tasks</a>
      <a href="/backOffice/feed">Feed</a>
    </nav>
  </div>

  <div class="container">
    <div class="page-header">
      <h2>Employee Management</h2>
      <a href="/backOffice/setup" class="btn">Tell users to visit /backOffice/setup</a>
    </div>

    <div class="alert success" id="successAlert"></div>
    <div class="alert error" id="errorAlert"></div>

    <div class="info-box">
      <strong>How to add new employees:</strong><br>
      Have users log in and visit <strong>/backOffice/setup</strong> to create their employee profile. They'll start as staff, and you can promote them to manager here.
    </div>

    <div class="card">
      <h3>All Employees (<%= employees.length %>)</h3>

      <% if (employees && employees.length > 0) { %>
        <table class="employee-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Position</th>
              <th>Department</th>
              <th>Role</th>
              <th>Status</th>
              <th>Hire Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% employees.forEach(function(emp) { %>
              <tr>
                <td><strong><%= emp.userId?.displayName || emp.userId?.email || 'Unknown' %></strong><br><small><%= emp.userId?.email || '' %></small></td>
                <td><%= emp.position %></td>
                <td><%= emp.department %></td>
                <td>
                  <span class="role-badge <%= emp.role %>"><%= emp.role %></span>
                </td>
                <td>
                  <span class="status-badge <%= emp.status %>"><%= emp.status %></span>
                </td>
                <td><%= new Date(emp.hireDate).toLocaleDateString() %></td>
                <td>
                  <div class="actions">
                    <% if (emp.role === 'staff') { %>
                      <button class="btn btn-small btn-success" onclick="promoteToManager('<%= emp._id %>')">
                        Promote to Manager
                      </button>
                    <% } %>
                    <% if (emp.status === 'active') { %>
                      <button class="btn btn-small btn-secondary" onclick="changeStatus('<%= emp._id %>', 'inactive')">
                        Deactivate
                      </button>
                    <% } else { %>
                      <button class="btn btn-small btn-success" onclick="changeStatus('<%= emp._id %>', 'active')">
                        Activate
                      </button>
                    <% } %>
                  </div>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      <% } else { %>
        <div class="empty-state">
          <h3>No employees yet</h3>
          <p>Have users visit <strong>/backOffice/setup</strong> after logging in to create their employee profile.</p>
        </div>
      <% } %>
    </div>
  </div>

  <script>
    function showAlert(message, type) {
      const alert = document.getElementById(type === 'success' ? 'successAlert' : 'errorAlert');
      alert.textContent = message;
      alert.style.display = 'block';
      setTimeout(() => {
        alert.style.display = 'none';
      }, 5000);
    }

    async function promoteToManager(employeeId) {
      if (!confirm('Promote this employee to Manager?')) return;

      try {
        const response = await fetch(`/backOffice/api/employees/${employeeId}/assign-manager`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (response.ok) {
          showAlert('Employee promoted to Manager successfully!', 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          showAlert(data.error || 'Error promoting employee', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert('Error promoting employee', 'error');
      }
    }

    async function changeStatus(employeeId, newStatus) {
      const action = newStatus === 'active' ? 'activate' : 'deactivate';
      if (!confirm(`Are you sure you want to ${action} this employee?`)) return;

      try {
        const response = await fetch(`/backOffice/api/employees/${employeeId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();

        if (response.ok) {
          showAlert(`Employee ${action}d successfully!`, 'success');
          setTimeout(() => location.reload(), 1500);
        } else {
          showAlert(data.error || `Error ${action}ing employee`, 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert(`Error ${action}ing employee`, 'error');
      }
    }
  </script>

  <%-include('../../mainContent/adminNav.ejs')%>
</body>
</html>
